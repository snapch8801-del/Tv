<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª 3.1</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<style>
:root{
  --bg0:#070a12;
  --bg1:#0b1020;
  --card: rgba(255,255,255,.06);
  --line: rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.70);
  --accent:#7c5cff;
  --warn:#f59e0b;
  --err:#ef4444;
  --radius:18px;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.topbar{
  padding:14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.55); background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12)); }
.btn.soft{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
.btn.soft:hover{ background: rgba(255,255,255,.08); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input{
  width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line);
  background: rgba(0,0,0,.18); color: var(--text); outline:none;
}
.searchWrap input:focus{ border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }

.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 0 14px 14px 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; transition: all 0.2s ease; }
.filterBtn:hover{ background: rgba(255,255,255,.05); }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }

.analyticsArea{ display: flex; flex-wrap: wrap; gap: 20px; padding: 20px 14px; border-bottom: 1px solid var(--line); background: rgba(0,0,0,.15); align-items: center; }
.chartContainer{ height: 160px; flex: 1; min-width: 250px; max-width: 400px; position: relative; }
.revenueContainer{ flex: 1; min-width: 200px; padding: 14px; background: rgba(255,255,255,.03); border: 1px solid var(--line); border-radius: 16px; }
.revTitle{ color: var(--muted); font-size: 13px; font-weight: 900; margin-bottom: 8px; }
.revValue{ color: var(--text); font-size: 24px; font-weight: 900; }

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color: var(--text); white-space:nowrap; }
.statChip .k{ color: var(--muted); font-weight:900; }
.statChip .v{ font-weight:900; }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }
.statChip.sync.offline{ border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.10); }
.statChip.sync.err{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.10); }

.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 980px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; font-weight:900; padding:12px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.07); white-space:nowrap; vertical-align:middle; }
tbody tr:hover{ background: rgba(255,255,255,.03); }
tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }

.badge{ display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.62); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: 0 30px 90px rgba(0,0,0,.65); overflow:hidden; animation: pop .14s ease-out; }
@keyframes pop{ from{ transform: translateY(8px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }
.modalHeader{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; }
.modalHeader h2{margin:0;font-size:16px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 14px 16px; }
.modalFooter{ padding:12px 16px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; flex-wrap:wrap; }

.formGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
@media (max-width: 760px){ .formGrid{ grid-template-columns: 1fr 1fr; } }
.field label{ display:block; font-weight:900; font-size:12px; color: var(--muted); margin-bottom:6px; }
.field input, .field select{ width:100%; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.22); color: var(--text); outline:none; }
.field input:focus, .field select:focus{ border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }

.actionPill{ padding:8px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); font-weight: 900; cursor:pointer; }
.actionPill:hover{ background: rgba(255,255,255,.08); }

.actGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
.actBtn{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); padding: 14px; border-radius: 18px; font-weight: 900; cursor:pointer; }

.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 14px; border-radius: 16px; border: 1px solid rgba(255,255,255,.12); background: rgba(10,14,26,.92); color: var(--text); font-weight: 900; display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s ease; z-index: 10000; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">Ù†Ø³Ø®Ø© 3.1 - ØªØ¹Ù…Ù„ Ø¨Ù€ Native Firebase SDK (Ø§ØªØµØ§Ù„ ÙÙˆØ±ÙŠ ÙˆÙ…Ø³ØªÙ‚Ø±)</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openAuth" type="button">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>
      <div class="searchWrap" style="margin-right:auto;">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." />
      </div>
      <div class="pills" id="statsBar"></div>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" data-filter="active">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" data-filter="expiring">â° Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="filterBtn" data-filter="expired">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="analyticsArea">
      <div class="chartContainer"><canvas id="statusChart"></canvas></div>
      <div class="revenueContainer">
        <div class="revTitle">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
        <div id="revenueList"><div class="revValue">0.00</div></div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader"><div><h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2></div><button class="btn" id="closeForm" type="button">âœ•</button></div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="name"></div>
        <div class="field"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="email" type="email"></div>
        <div class="field"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input id="phone" type="tel" dir="ltr"></div>
        <div class="field"><label>Ø§Ù„Ù…Ø¯Ø© (Ø£Ø´Ù‡Ø±)</label><input id="months" type="number" min="1"></div>
        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="price" type="number" min="0"></div>
        <div class="field"><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><select id="currency"><option value="DZD">DZD</option><option value="USD">USD</option><option value="EUR">EUR</option></select></div>
        <div class="field"><label>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input id="start" type="date"></div>
      </div>
    </div>
    <div class="modalFooter"><button class="btn primary" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button></div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" role="dialog" style="width:500px;">
    <div class="modalHeader"><div><h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2><div id="rowActionsHint" class="hint"></div></div><button class="btn" id="closeRowActionsX" type="button">âœ•</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend" type="button">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actWhatsApp" type="button" style="border-color:rgba(37,211,102,.5); color:#4ade80;">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="actBtn danger" id="actDelete" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:400px;">
    <div class="modalHeader"><div><h2>ğŸ‘¤ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2></div><button class="btn" id="closeAuth" type="button" style="display:none;">âœ•</button></div>
    <div class="modalBody">
      <div class="field" style="margin-bottom:10px"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="authEmail" type="email"></div>
      <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="authPass" type="password"></div>
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button class="btn primary" id="authLogin" type="button">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn danger" id="authLogout" type="button" style="margin-inline-start:auto">Ø®Ø±ÙˆØ¬</button>
      </div>
      <div id="authStateText" style="margin-top:10px; font-size:13px; color:var(--muted)">â€”</div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';
Chart.register(ChartDataLabels);

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

const FIREBASE_PATH = "subscriptions";
const LOCAL_BACKUP_KEY = "subs_local_backup_v3";

let currentUser = null;
let data = []; let editingId = null; let currentFilter = "all"; let myChartInstance = null;
let syncState = "idle"; let lastSyncAt = null; let syncTimer = null;

function nowHHMM(){
  const d = new Date();
  return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
}
function getSyncText(){
  if(!navigator.onLine) return "ğŸ“´ Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
  if(syncState === "saving") return "â³ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...";
  if(syncState === "ok") return `âœ… ${lastSyncAt || ""}`;
  if(syncState === "fail") return "ğŸ”´ ÙØ´Ù„";
  return "â€”";
}
function setSyncState(state){
  syncState = state;
  if(state === "ok") lastSyncAt = nowHHMM();
  const el = document.getElementById("syncVal");
  if(el) el.textContent = getSyncText();
  const chip = document.getElementById("syncChip");
  if(chip){
    chip.className = "statChip sync"; 
    if(!navigator.onLine) chip.classList.add("offline");
    else if(state==="saving") chip.classList.add("syncing");
    else if(state==="fail") chip.classList.add("err");
  }
}

// ==== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Native SDK ====
function initAuth(){
  if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
  firebase.auth().onAuthStateChanged(async (u)=>{
    currentUser = u || null;
    updateAuthUI();
    if(currentUser){
      closeModal("authModal"); await load(); render();
    } else {
      data = []; render(); openModal("authModal");
    }
  });
}

function updateAuthUI(){
  const t = $("authStateText"); const l = $("authLogout");
  if(currentUser){ t.textContent = `âœ… Ù…Ø³Ø¬Ù„ ÙƒÙ€: ${currentUser.email}`; l.disabled = false; }
  else { t.textContent = "ğŸ”’ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„."; l.disabled = true; }
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© ====
async function firebasePull(){
  const snapshot = await firebase.database().ref(FIREBASE_PATH).once('value');
  const val = snapshot.val();
  if(!val) return [];
  return Array.isArray(val) ? val : Object.values(val);
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø°Ø±ÙŠ: Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© ====
async function firebasePushOnce(){
  await firebase.database().ref(FIREBASE_PATH).set(data);
}

function save(){
  localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data));
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(async ()=>{
    if(!navigator.onLine){ setSyncState("offline"); return; }
    try{
      setSyncState("saving"); 
      await firebasePushOnce(); // Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø± ÙˆÙ†Ø¸ÙŠÙ
      setSyncState("ok");
    }catch(e){
      setSyncState("fail"); 
      showToast("ØªØ¹Ø°Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", e.message, "err");
    }
  }, 600);
}

async function load(){
  if(navigator.onLine){
    try{ 
      setSyncState("saving"); 
      data = await firebasePull(); 
      localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data));
      setSyncState("ok"); 
    }
    catch(e){ 
      setSyncState("fail"); 
      showToast("ØªØ¹Ø°Ø± Ø§Ù„Ø¬Ù„Ø¨", e.message, "err");
      try{ data = JSON.parse(localStorage.getItem(LOCAL_BACKUP_KEY)) || []; }catch{}
    }
  } else {
    setSyncState("offline");
    try{ data = JSON.parse(localStorage.getItem(LOCAL_BACKUP_KEY)) || []; }catch{}
  }
}

/* ===== Utils ===== */
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function addMonths(iso, m){ const d=new Date(iso); d.setMonth(d.getMonth()+m); return d.toISOString().slice(0,10); }
function status(end){
  const left = Math.round((new Date(end) - new Date(todayISO()))/86400000);
  if(left<0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left<=7) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

function openModal(id){ $(id).style.display="flex"; }
function closeModal(id){ $(id).style.display="none"; }
function showToast(m, s="", k="ok"){
  const t=$("toast"); t.className=`toast ${k} show`;
  t.innerHTML=`<span class="ico">${k==="err"?"âŒ":"âœ…"}</span><div><div class="msg">${m}</div><div class="sub">${s}</div></div>`;
  setTimeout(()=>t.classList.remove("show"), 4000);
}

/* ===== Logic ===== */
$("openAdd").onclick = ()=>{ 
  $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ©"; editingId=null;
  $("name").value=""; $("email").value=""; $("phone").value=""; $("months").value=""; $("price").value=""; $("start").value=todayISO();
  openModal("formModal"); 
};
$("closeForm").onclick = ()=> closeModal("formModal");
$("saveBtn").onclick = ()=>{
  const name=$("name").value, email=$("email").value, phone=$("phone").value, m=Number($("months").value), p=Number($("price").value), s=$("start").value;
  if(!name || !s || m<1) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  const rec = { id: editingId||Date.now().toString(), name, email, phone, months:m, price:p, currency:$("currency").value, start:s, end:addMonths(s,m) };
  if(editingId){ const i=data.findIndex(x=>x.id===editingId); if(i>=0) data[i]=rec; } else data.unshift(rec);
  save(); render(); closeModal("formModal");
};

$("closeRowActionsX").onclick = ()=> closeModal("rowActionsModal");
$("actEdit").onclick = ()=>{
  const r=data.find(x=>x.id===currentRowId); if(!r)return;
  editingId=r.id; $("name").value=r.name; $("email").value=r.email||""; $("phone").value=r.phone||""; $("months").value=r.months; $("price").value=r.price; $("start").value=r.start;
  $("formTitle").textContent="ØªØ¹Ø¯ÙŠÙ„"; closeModal("rowActionsModal"); openModal("formModal");
};
$("actExtend").onclick = ()=>{
  const r=data.find(x=>x.id===currentRowId); if(!r)return;
  r.end = addMonths(r.end, r.months); save(); render(); closeModal("rowActionsModal"); showToast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯");
};
$("actDelete").onclick = ()=>{
  if(!confirm("Ø­Ø°ÙØŸ"))return; data=data.filter(x=>x.id!==currentRowId); save(); render(); closeModal("rowActionsModal");
};
$("actWhatsApp").onclick = ()=>{
  const r=data.find(x=>x.id===currentRowId); if(!r||!r.phone) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…");
  window.open(`https://wa.me/${r.phone.replace(/[^0-9+]/g,'')}?text=${encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${r.name}ØŒ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙŠÙˆÙ… ${r.end}.`)}`,'_blank');
};

document.querySelectorAll(".filterBtn").forEach(b => {
  b.onclick = (e) => { document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active")); e.target.classList.add("active"); currentFilter=e.target.getAttribute("data-filter"); render(); };
});

function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody"); tb.innerHTML="";
  
  let act=0, expg=0, expd=0, rev={};
  for(const r of data){
    const k=status(r.end).key; 
    if(k==="active")act++; if(k==="expiring")expg++; if(k==="expired")expd++;
    if(r.price>0) rev[r.currency] = (rev[r.currency]||0)+r.price;
  }
  
  const bar = $("statsBar");
  if(bar){
    bar.innerHTML = `<div class="statChip sync" id="syncChip"><span class="ico">â˜ï¸</span><span class="k">Ù…Ø²Ø§Ù…Ù†Ø©</span><span class="v" id="syncVal">${getSyncText()}</span></div>`;
    setSyncState(syncState); 
  }

  if(myChartInstance) myChartInstance.destroy();
  myChartInstance = new Chart($("statusChart"), {
    type:'doughnut', data:{ labels:['ÙØ¹Ù‘Ø§Ù„','Ù‚Ø±ÙŠØ¨','Ù…Ù†ØªÙ‡ÙŠ'], datasets:[{ data:[act,expg,expd], backgroundColor:['#22c55e','#f59e0b','#ef4444'], borderWidth:0 }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{position:'right',labels:{color:'#fff'}}, datalabels:{color:'#fff',font:{weight:'bold'},formatter:(v,c)=>{if(v===0)return''; let s=0; c.chart.data.datasets[0].data.map(d=>s+=d); return v+'\n('+(v*100/s).toFixed(0)+'%)';}} } }
  });
  
  $("revenueList").innerHTML = Object.keys(rev).length ? Object.keys(rev).map(k=>`<div class="revValue">${rev[k]} ${k}</div>`).join('') : `<div class="revValue">0.00</div>`;

  const rows = data.filter(r=>{
    if(q && !`${r.name} ${r.email} ${r.phone}`.toLowerCase().includes(q)) return false;
    const k=status(r.end).key; if(currentFilter!=="all" && currentFilter!==k) return false;
    return true;
  });

  for(const r of rows){
    const st = status(r.end); const tr = document.createElement("tr");
    if(st.key!=="active") tr.className = st.key+"-row";
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.email)}</td><td>${escapeHtml(r.phone||'-')}</td><td>${r.months} Ø´</td><td>${r.price||0} ${r.currency}</td><td>${r.start}</td><td>${r.end}</td><td>${st.left} ÙŠÙˆÙ…</td><td><span class="badge ${st.cls}">${st.label}</span></td><td><button class="actionPill" data-act="actions" data-id="${r.id}">âš¡</button></td>`;
    tb.appendChild(tr);
  }
}

$("tbody").addEventListener("click",(e)=>{ const b=e.target.closest("button"); if(b) { currentRowId=b.getAttribute("data-id"); openModal("rowActionsModal"); } });
$("search").addEventListener("input", render);
$("openAuth").onclick = ()=> openModal("authModal");

$("authLogin").onclick = async ()=>{
  try{ await firebase.auth().signInWithEmailAndPassword($("authEmail").value, $("authPass").value); }
  catch(e){ showToast("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„", e.message, "err"); }
};
$("authLogout").onclick = ()=> firebase.auth().signOut();

initAuth();
</script></body></html>
