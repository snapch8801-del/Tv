<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª 2.0 (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†Ø¸ÙØ©)</title>

<style>
:root{
  --bg0:#070a12;
  --bg1:#0b1020;
  --card: rgba(255,255,255,.06);
  --line: rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted: rgba(234,240,255,.70);
  --accent:#7c5cff;
  --warn:#f59e0b;
  --err:#ef4444;
  --radius:18px;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.topbar{
  padding:14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{
  border-color: rgba(124,92,255,.55);
  background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15));
}
.btn.danger{
  border-color: rgba(239,68,68,.55);
  background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12));
}
.btn.soft{
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
}

.searchWrap{flex:1;min-width:240px}
.searchWrap input{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  outline:none;
}
.searchWrap input:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

.filtersBar{
  width: 100%;
  display: flex;
  gap: 8px;
  padding: 0 14px 14px 14px;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--line);
}
.filterBtn{
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--muted);
  font-size: 13px;
  font-weight: 800;
  cursor: pointer;
}
.filterBtn.active{
  background: var(--text);
  color: var(--bg0);
  border-color: var(--text);
}

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}

#statsBar{
  margin-inline-start:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.statChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  font-size:12px;
  font-weight:900;
  color: var(--text);
}
.statChip.sync{
  border-color: rgba(124,92,255,.45);
  background: rgba(124,92,255,.10);
}

.tableWrap{ overflow:auto; }
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width: 980px;
}
thead th{
  position:sticky; top:0;
  z-index:5;
  background: rgba(0,0,0,.22);
  color: var(--muted);
  text-align:right;
  font-size:12px;
  font-weight:900;
  padding:12px 12px;
  border-bottom:1px solid var(--line);
}
tbody td{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.07);
  white-space:nowrap;
}
tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }

.badge{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:12px;
  font-weight:900;
}
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.62);
  z-index:9999;
  padding: 18px;
}
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{
  width:min(860px, 100%);
  background: rgba(10,14,26,.96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 22px;
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  overflow:hidden;
}

.modalHeader{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:space-between;
}
.modalBody{ padding: 14px 16px; }
.modalFooter{
  padding:12px 16px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-start;
}

.formGrid{
  display:grid;
  grid-template-columns: 1.2fr 1.2fr 1.2fr .9fr .9fr .9fr .9fr .9fr;
  gap:10px;
}
@media (max-width: 980px){
  .formGrid{ grid-template-columns: 1fr 1fr; }
}

.field label{
  display:block;
  font-weight:900;
  font-size:12px;
  color: var(--muted);
  margin-bottom:6px;
}
.field input, .field select{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: var(--text);
  outline:none;
}

.actionPill{
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}

.actGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 640px){
  .actGrid{ grid-template-columns: 1fr; }
}
.actBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 14px 14px;
  border-radius: 18px;
  font-weight: 900;
  cursor:pointer;
}

.toast{
  position: fixed;
  left: 50%; bottom: 18px;
  transform: translateX(-50%) translateY(20px);
  padding: 12px 14px;
  border-radius: 16px;
  background: rgba(10,14,26,.92);
  border: 1px solid rgba(255,255,255,.12);
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0;
  transition: all .18s ease;
  z-index: 10000;
}
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">âš¡ Ù†Ø³Ø®Ø© Ù…Ù†Ø¸ÙØ© ÙˆÙ…Ø³ØªÙ‚Ø±Ø© (v2.0 Ø§Ù„ÙƒØ§Ù…Ù„Ø©)</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openAuth">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>

      <div class="searchWrap">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." />
      </div>

      <div class="pills" id="statsBar">
        <div class="statChip sync" id="syncChip">
          <span class="ico">â˜ï¸</span>
          <span class="k">Ù…Ø²Ø§Ù…Ù†Ø©:</span>
          <span class="v" id="syncVal">â€”</span>
        </div>
      </div>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" data-filter="active">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" data-filter="expiring">â° Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="filterBtn" data-filter="expired">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box">
    <div class="modalHeader">
      <h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2>
      <button class="btn" onclick="closeModal('formModal')">âœ•</button>
    </div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="name"></div>
        <div class="field"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="email"></div>
        <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="phone"></div>
        <div class="field">
          <label>Ø§Ù„Ø®Ø·Ø©</label>
          <select id="quickPlan">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="1">1 Ø´Ù‡Ø±</option><option value="3">3 Ø£Ø´Ù‡Ø±</option>
            <option value="6">6 Ø£Ø´Ù‡Ø±</option><option value="12">12 Ø´Ù‡Ø±</option>
          </select>
        </div>
        <div class="field"><label>Ø§Ù„Ø£Ø´Ù‡Ø±</label><input id="months" type="number"></div>
        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="price" type="number"></div>
        <div class="field">
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select id="currency"><option value="DZD">DZD</option><option value="USD">USD</option></select>
        </div>
        <div class="field"><label>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input id="start" type="date"></div>
      </div>
    </div>
    <div class="modalFooter">
      <button class="btn primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
    </div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" style="width: 400px">
    <div class="modalHeader"><h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h2><button class="btn" onclick="closeModal('rowActionsModal')">âœ•</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actCopyEmail">ğŸ“‹ Ù†Ø³Ø® Email</button>
        <button class="actBtn" id="actWhatsApp" style="color:#22c55e">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="actBtn danger" id="actDelete" style="grid-column: span 2;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" style="width: 350px">
    <div class="modalHeader"><h2>ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h2></div>
    <div style="padding: 15px">
      <div class="field" style="margin-bottom:10px"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="authEmail"></div>
      <div class="field" style="margin-bottom:15px"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="authPass" type="password"></div>
      <button class="btn primary" id="authLogin" style="width:100%">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button class="btn soft" id="authLogout" style="width:100%; margin-top:10px">Ø®Ø±ÙˆØ¬</button>
      <div id="authStateText" style="margin-top:10px; font-size:12px; color:var(--muted)"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

const $ = (id)=>document.getElementById(id);
const FIREBASE_PATH = "subscriptions";
const LOCAL_BACKUP_KEY = "subs_local_backup_v4";
let data = []; let editingId = null; let currentRowId = null; let currentFilter = "all"; let currentUser = null;

// === Firebase Init ===
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.database();

auth.onAuthStateChanged(async (u)=>{
  currentUser = u;
  if(u){ closeModal("authModal"); await load(); }
  else { data = []; render(); openModal("authModal"); }
  updateAuthUI();
});

function updateAuthUI(){
  const t = $("authStateText");
  if(t) t.textContent = currentUser ? `âœ… Ù…ØªØµÙ„: ${currentUser.email}` : "ğŸ”’ ØºÙŠØ± Ù…ØªØµÙ„";
}

function setSyncState(state){
  const chip = $("syncChip"); const val = $("syncVal");
  if(!chip || !val) return;
  chip.className = "statChip sync " + state;
  if(!navigator.onLine) val.textContent = "Ø£ÙˆÙÙ„Ø§ÙŠÙ† ğŸ“´";
  else if(state==="saving") val.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ â³";
  else if(state==="ok") {
    const d = new Date();
    val.textContent = d.getHours()+":"+String(d.getMinutes()).padStart(2,"0") + " âœ…";
  }
}

async function load() {
  if(!navigator.onLine) { data = loadLocalBackup(); render(); return; }
  try {
    setSyncState("saving");
    const snap = await db.ref(FIREBASE_PATH).once('value');
    data = snap.val() ? Object.values(snap.val()) : [];
    saveLocalBackup(); setSyncState("ok"); render();
  } catch(e) { setSyncState("err"); }
}

async function firebasePush() {
  if(!navigator.onLine) return;
  try {
    setSyncState("saving");
    await db.ref(FIREBASE_PATH).set(data);
    saveLocalBackup();
    setSyncState("ok");
  } catch(e) { setSyncState("err"); showToast(e.message, "err"); }
}

function saveLocalBackup(){ localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data)); }
function loadLocalBackup(){
  try { const j = JSON.parse(localStorage.getItem(LOCAL_BACKUP_KEY)); return Array.isArray(j) ? j : []; } catch { return []; }
}

function getStatus(endISO) {
  const left = Math.round((new Date(endISO) - new Date().setHours(0,0,0,0))/(1000*60*60*24));
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= 7) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}

function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody"); tb.innerHTML="";
  const rows = data.filter(r=>{
    const match = !q || r.name.toLowerCase().includes(q) || (r.phone||"").includes(q) || (r.email||"").toLowerCase().includes(q);
    const st = getStatus(r.end).key;
    if(currentFilter !== "all" && currentFilter !== st) return false;
    return match;
  });
  rows.forEach(r=>{
    const st = getStatus(r.end);
    const tr = document.createElement("tr");
    if(st.key==="expired") tr.className = "expired-row";
    tr.innerHTML = `<td>${r.name}</td><td>${r.email||'-'}</td><td dir="ltr">${r.phone||'-'}</td><td>${r.months} Ø´</td><td>${r.price} ${r.currency}</td><td>${r.start}</td><td>${r.end}</td><td>${st.left < 0 ? 'Ù…Ù†Ø° ' + Math.abs(st.left) : st.left} ÙŠÙˆÙ…</td><td><span class="badge ${st.cls}">${st.label}</span></td><td><button class="actionPill" onclick="openRowActions('${r.id}')">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</button></td>`;
    tb.appendChild(tr);
  });
}

// === ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===
window.openRowActions = (id) => { currentRowId = id; openModal("rowActionsModal"); };

// === ÙˆØ¸Ø§Ø¦Ù Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ===
$("actEdit").onclick = () => {
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  closeModal("rowActionsModal");
  editingId = rec.id;
  $("formTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
  $("name").value = rec.name || "";
  $("email").value = rec.email || "";
  $("phone").value = rec.phone || "";
  $("quickPlan").value = "";
  $("months").value = rec.months || "";
  $("price").value = rec.price || "";
  $("currency").value = rec.currency || "DZD";
  $("start").value = rec.start || todayISO();
  openModal("formModal");
};

$("actDelete").onclick = async () => {
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
  data = data.filter(x => x.id !== currentRowId);
  await firebasePush(); render(); closeModal("rowActionsModal"); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù ğŸ—‘ï¸");
};

$("actExtend").onclick = async () => {
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  const m = prompt("ÙƒÙ… Ø´Ù‡Ø±Ø§Ù‹ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¬Ø¯Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ", "1");
  if(!m || isNaN(m)) return;
  
  const endD = new Date(rec.end);
  endD.setMonth(endD.getMonth() + parseInt(m));
  rec.end = endD.toISOString().split('T')[0];
  rec.months = parseInt(rec.months) + parseInt(m);
  
  await firebasePush(); render(); closeModal("rowActionsModal"); showToast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ ğŸ”");
};

$("actCopyEmail").onclick = () => {
  const rec = data.find(x => x.id === currentRowId);
  if(!rec || !rec.email) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„", "err");
  navigator.clipboard.writeText(rec.email);
  closeModal("rowActionsModal"); showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ğŸ“‹");
};

$("actWhatsApp").onclick = () => {
  const rec = data.find(x => x.id === currentRowId);
  if(!rec || !rec.phone) return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØªØ±Ùƒ", "err");
  let cleanPhone = rec.phone.replace(/[^0-9+]/g, '');
  let message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${rec.name}ØŒ\nÙ†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø£Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${rec.end}.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©.`;
  window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
  closeModal("rowActionsModal");
};

// === Ø­ÙØ¸ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© ===
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().split('T')[0]; }
$("quickPlan").onchange = ()=>{ if($("quickPlan").value) $("months").value = $("quickPlan").value; };

$("saveBtn").onclick = async () => {
  const start = $("start").value; const months = parseInt($("months").value);
  if(!$("name").value || !start || !months) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", "err");
  
  const endD = new Date(start); endD.setMonth(endD.getMonth() + months);
  const rec = { 
    id: editingId || Date.now().toString(), 
    name: $("name").value, 
    email: $("email").value, 
    phone: $("phone").value, 
    months, 
    price: $("price").value, 
    currency: $("currency").value, 
    start, 
    end: endD.toISOString().split('T')[0] 
  };
  
  if(editingId) data = data.map(x => x.id === editingId ? rec : x);
  else data.unshift(rec);
  
  await firebasePush(); render(); closeModal("formModal"); showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
};

// === Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© ===
$("authLogin").onclick = () => { auth.signInWithEmailAndPassword($("authEmail").value, $("authPass").value).catch(e => showToast(e.message, "err")); };
$("authLogout").onclick = () => auth.signOut();
$("openAdd").onclick = () => { editingId=null; $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ"; $("name").value=""; $("email").value=""; $("phone").value=""; $("months").value=""; $("price").value=""; $("start").value=todayISO(); openModal("formModal"); };
$("search").oninput = render;

function openModal(id){ $(id).setAttribute("aria-hidden","false"); }
function closeModal(id){ $(id).setAttribute("aria-hidden","true"); }
function showToast(m, type="ok"){ const t=$("toast"); t.textContent=m; t.style.borderColor = type==="err"?"#ef4444":"#22c55e"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3000); }

document.querySelectorAll(".filterBtn").forEach(b => {
  b.onclick = (e) => {
    document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active"));
    e.target.classList.add("active"); currentFilter = e.target.dataset.filter; render();
  };
});
</script>
</body>
</html>
