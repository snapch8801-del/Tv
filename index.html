<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช - v13.0</title>

<meta name="theme-color" content="#070a12" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link id="manifest-link" rel="manifest" href="" />

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, sans-serif; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px; overflow-x: hidden;
}
.container{max-width:1200px;margin:0 auto}
.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px; display: flex; align-items: center; gap: 8px;}
.version-badge { background: linear-gradient(135deg, var(--accent), #5a3bc2); color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 12px;}
.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }
.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; flex-direction:column; gap:12px; }
.topbar-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.searchWrap{ display: flex; gap: 6px; align-items: center; width: 100%; }
.searchWrap input { flex:1; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; font-size: 14px;}
.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; transition: all .15s ease; font-size:13px; }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.1); color: #ff8a8a; }
.btn.soft { border-color: rgba(255,255,255,.1); }
.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }
.bulkBar{ display: none; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(124,92,255,.15); border-bottom: 1px solid rgba(124,92,255,.3); flex-wrap: wrap; }
.selCount{ font-weight: 900; color: #fff; background: var(--accent); padding: 4px 10px; border-radius: 99px; font-size: 12px; }
.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 850px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; padding:14px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px; border-bottom:1px solid rgba(255,255,255,.05); white-space:nowrap; }
.expired-row { background: rgba(239,68,68,0.05); }
.badge{ padding:4px 8px; border-radius:999px; font-size:11px; font-weight:900; border:1px solid var(--line); }
.badge.ok{ border-color: #22c55e; color:#c8f7d9; background: rgba(34,197,94,.1); }
.badge.warn{ border-color: #f59e0b; color:#ffe2b3; background: rgba(245,158,11,.1); }
.badge.err{ border-color: #ef4444; color:#ffd0d0; background: rgba(239,68,68,.1); }
.tag-pill { background: rgba(255,255,255,0.05); border: 1px solid var(--line); padding: 2px 6px; border-radius: 6px; font-size: 10px; margin-inline-end: 4px;}
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.75); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: #0b1020; border: 1px solid var(--line); border-radius: 22px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); }
.modalHeader{ padding:16px 20px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; position: sticky; top: 0; background: #0b1020; z-index: 10; }
.modalBody{ padding: 20px; }
.formGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
.full-width { grid-column: 1 / -1 !important; }
.field label{ display:block; font-weight:900; font-size:13px; color: var(--muted); margin-bottom:8px; }
.field input, .field select, .field textarea { background: rgba(0,0,0,.3); border:1px solid var(--line); width:100%; padding:12px 14px; border-radius:14px; color: var(--text); outline:none; font-size: 14px; font-family: inherit; }
.pagination { display: flex; justify-content: center; align-items: center; gap: 12px; padding: 16px; border-top: 1px solid var(--line); }
.page-btn { padding: 8px 16px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--line); color: white; cursor:pointer;}
.id-card-wrap { border: 2px solid #e2e8f0; border-radius: 16px; padding: 25px; background: white; color: #0f172a; text-align: center; }
.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); padding: 12px 14px; border-radius: 16px; background: #0b1020; border: 1px solid var(--line); color: var(--text); opacity: 0; transition: .2s; z-index: 10000; font-weight:bold; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(-10px); }
.statChip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; background: rgba(0,0,0,0.2); font-size: 12px; border: 1px solid var(--line); }
@media print { body > *:not(.print-active) { display: none !important; } .modal.print-active { display: block !important; position: static !important; background:white !important;} }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>๐งพ ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช <span class="version-badge">v13.0</span></h1>
    <div class="sub">โก ุงููุณุฎุฉ ุงูุดุงููุฉ: QRุ ูุงููุฑุงุ ุญุตุตุ ุจุงูุงุชุ ูุฃุฏุงุก ูุงุฆู</div>
  </div>

  <div class="card">
    <div class="topbar">
      <div class="topbar-actions">
        <button class="btn primary" onclick="window.openScannerModal()" style="background:#10b981; border-color:#059669;">๐ท ูุณุญ ุจุทุงูุฉ (QR)</button>
        <button class="btn primary" onclick="window.openAddSub()">โ ุฅุถุงูุฉ ุนููู</button>
        <button class="btn soft" onclick="window.openTotalsReport()">๐ฐ ุงูุฅุญุตุงุฆูุงุช</button>
        <button class="btn soft" onclick="openModal('authModal')">๐ค ุงูุฅุฏุงุฑุฉ</button>
        <button class="btn soft" onclick="openModal('toolsModal')">โ๏ธ ุฃุฏูุงุช</button>
        <div class="statChip sync" id="syncChip"><span class="ico">โ๏ธ</span> <span id="syncVal">ุฌุงุฑู ุงูุชุญููู...</span></div>
      </div>
      <div class="searchWrap">
        <input id="search" oninput="window.currentPage=1; window.render()" placeholder="ุจุญุซ ุจุงูุงุณูุ ุงููุณุงูุ ุงููุงุชูุ ุงูุฎุฏูุฉ..." />
        <button class="btn soft" onclick="window.clearSearch()">โ</button>
      </div>
    </div>

    <div class="bulkBar" id="bulkBar">
      <div class="selCount" id="selCount">0 ูุญุฏุฏ</div>
      <button class="btn" style="border-color:#10b981; color:#10b981;" onclick="window.openBulkWhatsAppModal()">๐ฌ ุฑุณุงุฆู ุฌูุงุนูุฉ</button>
      <button class="btn danger" onclick="window.bulkDeleteAction()">๐๏ธ ุญุฐู ุฌูุงุนู</button>
      <button class="btn soft" onclick="window.clearSelection()">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
    </div>

    <div class="filtersBar">
      <button class="filterBtn active" onclick="setFilter(this, 'all')">ุงููู</button>
      <button class="filterBtn" onclick="setFilter(this, 'active')">โ ูุนูุงู</button>
      <button class="filterBtn" onclick="setFilter(this, 'expiring')">โฐ ูุฑูุจ ููุชูู</button>
      <button class="filterBtn" onclick="setFilter(this, 'expired')">โ ููุชูู</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="window.toggleSelectAll(this)"></th>
            <th>ุงูุนููู</th> <th>ุงููุงุชู</th> <th>ุงูุงุดุชุฑุงู</th> <th>ุงููุงููุฉ</th> <th>ุงูุญุงูุฉ / ุงูุฑุตูุฏ</th> <th>ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="paginationControls" class="pagination"></div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box">
    <div class="modalHeader"><h2 id="formTitle">ุฅุถุงูุฉ ูุดุชุฑู</h2><button class="btn danger" onclick="closeModal('formModal')">โ</button></div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full-width" style="background:rgba(124,92,255,0.1); padding:10px; border-radius:14px; border:1px solid rgba(124,92,255,0.3);">
          <label>๐ฆ ุชุนุจุฆุฉ ุณุฑูุนุฉ ูู ุงูุจุงูุงุช</label>
          <select id="packageSelector" onchange="window.applyPackage()"></select>
        </div>
        <div class="field full-width">
          <label>ููุน ุงูุงุดุชุฑุงู</label>
          <select id="subType" onchange="window.toggleSubType()">
            <option value="time">โณ ุฒููู (ุฃุดูุฑ)</option>
            <option value="sessions">๐๏ธ ุญุตุต (ุฑุตูุฏ)</option>
          </select>
        </div>
        <div class="field full-width"><label>ุงูุงุณู ุงููุงูู *</label><input id="name"></div>
        <div class="field full-width"><label>ุงููุงุชู</label><input id="phone" type="tel"></div>
        <div class="field full-width"><label>ุงูุฃูุณูุฉ (ูุตู ุจูุงุตูุฉ)</label><input id="tags" placeholder="ูุซุงู: ุณูุฉ 4 ูุชูุณุทุ ููุฌ 1"></div>
        <div class="field full-width"><label>ุงูุฎุฏูุฉ / ุงูุจุงูุฉ *</label><input id="serviceType"></div>
        
        <div id="timeFieldsGrp" style="display:contents;">
          <div class="field"><label>ุงููุฏุฉ (ุฃุดูุฑ)</label><input id="months" type="number" value="1"></div>
          <div class="field"><label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label><input id="start" type="date"></div>
          <div class="field"><label>ุชูุจูู ูุจู (ููู)</label><input id="alertDays" type="number" value="7"></div>
        </div>

        <div id="sessionsFieldsGrp" style="display:none;">
          <div class="field"><label>ุฅุฌูุงูู ุงูุญุตุต</label><input id="sessionsTotal" type="number" placeholder="12"></div>
          <div class="field"><label>ุงูุฑุตูุฏ ุงููุชุจูู</label><input id="sessionsLeft" type="number"></div>
        </div>

        <div class="field"><label>ุงูุนููุฉ</label><select id="currency"><option>DZD</option><option>EUR</option><option>USD</option></select></div>
        <div class="field"><label>ุงูุณุนุฑ ุงูุฅุฌูุงูู</label><input id="price" type="number" value="0"></div>
        <div class="field"><label>ุงููุจูุบ ุงููุฏููุน</label><input id="paidAmount" type="number" value="0"></div>
        <div class="field full-width"><label>ููุงุญุธุงุช ุฎุงุตุฉ</label><textarea id="notes" rows="2"></textarea></div>
      </div>
      <button class="btn primary" style="width:100%; margin-top:20px; padding:16px;" onclick="window.saveSubscription()">๐พ ุญูุธ ุงูุจูุงูุงุช ุงูุขู</button>
    </div>
  </div>
</div>

<div class="modal" id="scannerModal" aria-hidden="true">
  <div class="box" style="width: 400px">
    <div class="modalHeader"><h2>๐ท ูุงุฑุฆ ุงูุจุงุฑููุฏ</h2><button class="btn danger" onclick="window.closeScannerModal()">โ</button></div>
    <div class="modalBody"><div id="qr-reader" style="width:100%; border-radius:12px;"></div></div>
  </div>
</div>

<div class="modal" id="checkInModal" aria-hidden="true">
  <div class="box" style="width: 400px; text-align:center;">
    <div class="modalHeader" style="justify-content:center;"><h2>๐ ููุทุฉ ุงูุฏุฎูู</h2></div>
    <div class="modalBody">
      <h2 id="chkInName" style="margin:0;">-</h2>
      <p id="chkInService" style="color:var(--muted);">-</p>
      <div id="chkInAlert" style="margin:20px 0; padding:15px; border-radius:12px; font-weight:bold; font-size:18px;"></div>
      <button class="btn primary" id="btnChkInAction" style="width:100%; padding:16px; margin-bottom:10px;"></button>
      <button class="btn danger" style="width:100%;" onclick="closeModal('checkInModal')">ุฅุบูุงู</button>
    </div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" style="width:500px">
    <div class="modalHeader"><h2 id="rowActionsHint">ุฅุฌุฑุงุกุงุช</h2><button class="btn danger" onclick="closeModal('rowActionsModal')">โ</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" style="background:#3b82f6; color:white;" onclick="window.openMembershipCard()">๐ชช ุจุทุงูุฉ ุงูุงูุฎุฑุงุท (QR)</button>
        <button class="actBtn" onclick="window.actEditAction()">โ๏ธ ุชุนุฏูู</button>
        <button class="actBtn" onclick="window.openReceiptAction()">๐ ูุงุชูุฑุฉ / ูุตู</button>
        <button class="actBtn" style="color:#22c55e;" onclick="window.actWhatsAppAction()">๐ฌ ูุงุชุณุงุจ</button>
        <button class="actBtn danger" onclick="window.actDeleteAction()">๐๏ธ ุญุฐู ููุงุฆู</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="idCardModal" aria-hidden="true">
  <div class="box" style="width: 400px;">
    <div class="modalHeader no-print"><h2>๐ชช ุจุทุงูุฉ ุงูุนุถููุฉ</h2><button class="btn danger" onclick="closeModal('idCardModal')">โ</button></div>
    <div class="modalBody id-card-content">
      <div class="id-card-wrap">
        <h2 id="idCardStoreName" style="color:#4f46e5; margin:0;">ุงููุคุณุณุฉ</h2>
        <p style="font-size:10px; color:#94a3b8; margin-bottom:15px;">MEMBERSHIP CARD</p>
        <div id="idCardQR" style="display:inline-block; padding:10px; background:white; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:15px;"></div>
        <h3 id="idCardClientName" style="margin:0; font-size:22px;">-</h3>
        <p id="idCardService" style="font-weight:bold; color:#8b5cf6;">-</p>
        <div style="border-top:1px dashed #cbd5e1; margin-top:10px; padding-top:10px; display:flex; justify-content:space-between; font-size:12px;">
           <span id="idCardType">-</span> <span id="idCardStatus">-</span>
        </div>
      </div>
      <button class="btn primary no-print" style="width:100%; margin-top:20px;" onclick="window.printIdCardAction()">๐จ๏ธ ุทุจุงุนุฉ ุงูุจุทุงูุฉ</button>
    </div>
  </div>
</div>

<div class="modal" id="toolsModal" aria-hidden="true">
  <div class="box" style="width:450px">
    <div class="modalHeader"><h2>โ๏ธ ุฃุฏูุงุช ุงููุธุงู</h2><button class="btn danger" onclick="closeModal('toolsModal')">โ</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" style="grid-column: span 2; background:rgba(124,92,255,0.1);" onclick="closeModal('toolsModal'); openModal('packagesModal')">๐ฆ ุฅุฏุงุฑุฉ ุงูุจุงูุงุช ุงูุฌุงูุฒุฉ</button>
        <button class="actBtn" onclick="window.exportCSV()">๐ฅ ุชุตุฏูุฑ Excel</button>
        <button class="actBtn" onclick="openModal('storeSettingsModal')">๐ช ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ</button>
        <button class="actBtn danger" style="grid-column: span 2;" onclick="window.clearAllData()">โ๏ธ ุญุฐู ุฌููุน ุงูุจูุงูุงุช</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';
const FIREBASE_CONFIG = { apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ", authDomain: "dattta-6f497.firebaseapp.com", databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com", projectId: "dattta-6f497" };
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database(); const auth = firebase.auth();

let data = []; let packagesData = []; let editingId = null; let currentRowId = null; 
let currentFilter = "all"; let selectedIds = new Set(); 
window.currentPage = 1; window.itemsPerPage = 50;

const $ = (id) => document.getElementById(id);
window.showToast = (m, type="ok") => { const t=$("toast"); t.textContent=m; t.style.borderColor = type==="err"?"#ef4444":"#22c55e"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3000); };
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function toDate(iso){ return iso ? new Date(iso+"T00:00:00") : new Date(); }
function saveLocalBackup(){ localStorage.setItem("subs_v13", JSON.stringify(data)); }
function loadLocalBackup(){ try { return JSON.parse(localStorage.getItem("subs_v13") || "[]"); } catch { return []; } }

// ุฌูุจ ูุชุญููู ุงูุจูุงูุงุช
window.loadData = async () => {
  try {
    const snap = await db.ref("subscriptions").once('value');
    data = snap.val() ? Object.values(snap.val()) : [];
    const pSnap = await db.ref("packages").once('value');
    packagesData = pSnap.val() ? Object.values(pSnap.val()) : [];
    window.renderPackages();
    window.render();
    $("syncVal").textContent = "ูุชุตู ุจุงูุฎุงุฏู โ";
  } catch(e) {
    data = loadLocalBackup();
    window.render();
    $("syncVal").textContent = "ุฃูููุงูู โ๏ธ (Brave Shield?)";
  }
};

window.renderPackages = () => {
  const sel = $("packageSelector"); if(!sel) return;
  sel.innerHTML = '<option value="">โ๏ธ ุฅุฏุฎุงู ูุฏูู ููุจูุงูุงุช</option>';
  packagesData.forEach(p => { sel.innerHTML += `<option value="${p.id}">${p.name} (${p.price})</option>`; });
};

window.applyPackage = () => {
  const p = packagesData.find(x => x.id === $("packageSelector").value);
  if(p) {
    $("subType").value = p.type; window.toggleSubType();
    $("serviceType").value = p.serviceType; $("price").value = p.price;
    if(p.type === 'time') $("months").value = p.value; else $("sessionsTotal").value = p.value;
    window.calcDebt();
  }
};

window.toggleSubType = () => {
  const isTime = $("subType").value === 'time';
  $("timeFieldsGrp").style.display = isTime ? "contents" : "none";
  $("sessionsFieldsGrp").style.display = isTime ? "none" : "contents";
};

// ุญูุธ ุงูุจูุงูุงุช (ุชู ุฅุตูุงุญูุง ุจุงููุงูู)
window.saveSubscription = async () => {
  const name = $("name").value.trim();
  const service = $("serviceType").value.trim();
  if(!name || !service) return showToast("ุงูุงุณู ูุงูุฎุฏูุฉ ุฅุฌุจุงุฑูุฉ!", "err");

  const subType = $("subType").value;
  const rec = {
    id: editingId || Date.now().toString(),
    name, serviceType: service, subType,
    phone: $("phone").value, tags: $("tags").value,
    price: $("price").value || 0, paidAmount: $("paidAmount").value || 0,
    currency: $("currency").value, notes: $("notes").value
  };

  if(subType === 'time') {
    rec.start = $("start").value || todayISO();
    rec.months = parseInt($("months").value) || 1;
    const d = new Date(rec.start); d.setMonth(d.getMonth() + rec.months);
    rec.end = d.toISOString().split('T')[0];
    rec.alertDays = $("alertDays").value || 7;
  } else {
    rec.sessionsTotal = parseInt($("sessionsTotal").value) || 0;
    rec.sessionsLeft = ($("sessionsLeft").value !== "") ? parseInt($("sessionsLeft").value) : rec.sessionsTotal;
  }

  try {
    if(editingId) data = data.map(x => x.id === editingId ? rec : x);
    else data.unshift(rec);
    await db.ref("subscriptions").set(data);
    saveLocalBackup(); window.render(); closeModal('formModal');
    showToast("ุชู ุงูุญูุธ ุจูุฌุงุญ โจ");
  } catch(e) { showToast("ูุดู ุงูุญูุธ: " + e.message, "err"); }
};

window.render = () => {
  const tb = $("tbody"); if(!tb) return; tb.innerHTML = "";
  const q = $("search").value.toLowerCase();
  
  let filtered = data.filter(r => {
    const match = !q || r.name.toLowerCase().includes(q) || r.serviceType.toLowerCase().includes(q) || (r.tags||"").toLowerCase().includes(q);
    const st = getStatus(r, 7);
    if(currentFilter !== "all" && currentFilter !== st.key) return false;
    return match;
  });

  const totalPages = Math.ceil(filtered.length / window.itemsPerPage) || 1;
  const startIdx = (window.currentPage - 1) * window.itemsPerPage;
  const rows = filtered.slice(startIdx, startIdx + window.itemsPerPage);

  rows.forEach(r => {
    const st = getStatus(r, 7);
    const tr = document.createElement("tr");
    if(st.key === 'expired') tr.className = "expired-row";
    
    let tagsHtml = (r.tags||"").split(',').map(t => t.trim() ? `<span class="tag-pill">${t}</span>` : "").join("");
    
    tr.innerHTML = `
      <td><input type="checkbox" class="rowChk" value="${r.id}" ${selectedIds.has(r.id)?"checked":""}></td>
      <td><b>${r.name}</b><br>${tagsHtml}</td>
      <td>${r.phone || "-"}</td>
      <td><span class="service-badge">${r.serviceType}</span></td>
      <td>${r.price} ${r.currency}</td>
      <td><span class="badge ${st.cls}">${st.label}</span><br><small>${r.subType==='time'?'ุฅูู: '+r.end : 'ุจูู: '+r.sessionsLeft+' ุญุตุฉ'}</small></td>
      <td><button class="btn primary" onclick="window.openRowActions('${r.id}')">โก ุฅุฌุฑุงุก</button></td>
    `;
    tb.appendChild(tr);
  });

  $("paginationControls").innerHTML = `
    <button class="page-btn" onclick="window.changePage(1)" ${window.currentPage === totalPages ? 'disabled' : ''}>ุงูุชุงูู</button>
    <span style="font-size:12px;">${window.currentPage} ูู ${totalPages}</span>
    <button class="page-btn" onclick="window.changePage(-1)" ${window.currentPage === 1 ? 'disabled' : ''}>ุงูุณุงุจู</button>
  `;
};

function getStatus(r, alertD) {
  if (r.subType === 'sessions') {
    return (parseInt(r.sessionsLeft) <= 0) ? {key:'expired', label:'ููุชูู', cls:'err'} : {key:'active', label:'ูุนูุงู', cls:'ok'};
  } else {
    const left = Math.round((toDate(r.end) - toDate(todayISO()))/(1000*60*60*24));
    if(left < 0) return {key:'expired', label:'ููุชูู', cls:'err'};
    if(left <= alertD) return {key:'expiring', label:'ูุฑูุจ ููุชูู', cls:'warn'};
    return {key:'active', label:'ูุนูุงู', cls:'ok'};
  }
}

// ุงููุงููุฑุง ูุงููุณุญ
let scanner;
window.openScannerModal = () => {
  openModal('scannerModal');
  scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
  scanner.render((text) => {
    const id = text.replace("ID:", "");
    scanner.clear(); closeModal('scannerModal');
    window.processScannedId(id);
  });
};
window.closeScannerModal = () => { if(scanner) scanner.clear(); closeModal('scannerModal'); };

window.processScannedId = (id) => {
  const rec = data.find(x => x.id === id);
  if(!rec) return showToast("ุบูุฑ ููุฌูุฏ!", "err");
  currentRowId = rec.id;
  $("chkInName").textContent = rec.name;
  $("chkInService").textContent = rec.serviceType;
  const st = getStatus(rec, 7);
  $("chkInAlert").textContent = st.label;
  $("chkInAlert").style.background = st.cls==='err'?'rgba(239,68,68,0.2)':'rgba(34,197,94,0.2)';
  const btn = $("btnChkInAction");
  if(rec.subType === 'sessions' && rec.sessionsLeft > 0) {
    btn.style.display = "block"; btn.textContent = "โ๏ธ ุฎุตู ุญุตุฉ ุญุถูุฑ";
    btn.onclick = () => { rec.sessionsLeft--; db.ref("subscriptions").set(data); closeModal('checkInModal'); window.render(); showToast("ุชู ุชุณุฌูู ุงูุญุถูุฑ"); };
  } else { btn.style.display = "none"; }
  openModal('checkInModal');
};

// ุงูุจุทุงูุฉ ูQR
window.openMembershipCard = () => {
  const rec = data.find(x => x.id === currentRowId); if(!rec) return;
  closeModal('rowActionsModal');
  $("idCardClientName").textContent = rec.name;
  $("idCardService").textContent = rec.serviceType;
  const qrBox = $("idCardQR"); qrBox.innerHTML = "";
  new QRCode(qrBox, { text: "ID:" + rec.id, width: 120, height: 120 });
  openModal('idCardModal');
};

// ุจููุฉ ูุธุงุฆู ุงููุงุฌูุฉ
window.openAddSub = () => { editingId=null; $("formTitle").textContent="ุฅุถุงูุฉ ูุดุชุฑู ุฌุฏูุฏ"; openModal('formModal'); };
window.openRowActions = (id) => { currentRowId = id; $("rowActionsHint").textContent = data.find(x=>x.id===id).name; openModal('rowActionsModal'); };
window.setFilter = (btn, f) => { document.querySelectorAll(".filterBtn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); currentFilter = f; window.render(); };
window.clearSearch = () => { $("search").value = ""; window.render(); };

auth.onAuthStateChanged(u => { if(u) window.loadData(); else openModal('authModal'); });
</script>
</body>
</html>
