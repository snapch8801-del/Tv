<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - v12.3</title>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0; font-family: "Inter", system-ui, -apple-system; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px; display: flex; align-items: center; gap: 8px;}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}
.version-badge { background: linear-gradient(135deg, var(--accent), #5a3bc2); color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 12px; box-shadow: 0 4px 15px rgba(124,92,255,0.3);}

.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }

.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; flex-direction:column; gap:12px; }
.topbar-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; width: 100%; }
.searchWrap{ display: flex; gap: 6px; align-items: center; width: 100%; }
.searchWrap input { flex:1; width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; transition: all 0.2s; font-size: 14px;}
.searchWrap input:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }

.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; transition: all .15s ease; font-size:13px; display: inline-flex; align-items: center; gap: 6px; }
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.15); }
.btn.ai-btn { border-color: #10b981; color: #10b981; background: rgba(16,185,129,0.1); display: none; }

.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color: var(--text); margin-inline-start: auto; }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }

.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); background: rgba(0,0,0,0.1); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }

.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 850px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; font-weight:900; padding:14px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px; border-bottom:1px solid rgba(255,255,255,.05); white-space:nowrap; vertical-align:middle; }

.badge{ display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:11px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; background: rgba(34,197,94,.1); }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; background: rgba(245,158,11,.1); }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; background: rgba(239,68,68,.1); }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.75); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: var(--shadow); overflow:hidden; max-height: 90vh; overflow-y: auto; }
.modalHeader{ padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; position: sticky; top: 0; background: rgba(10,14,26,.96); z-index: 10; backdrop-filter: blur(5px); }
.modalFooter{ padding: 16px 20px; border-top: 1px solid var(--line); display: flex; justify-content: flex-end; gap: 10px; }

.formGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; padding: 20px; }
.full-width { grid-column: 1 / -1 !important; }
@media (max-width: 768px){ .formGrid{ grid-template-columns: 1fr; } }

.field label{ display:block; font-weight:900; font-size:13px; color: var(--muted); margin-bottom:8px; }
.field input, .field select, .field textarea{ background: rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.15); width:100%; padding:12px 14px; border-radius:14px; color: var(--text); outline:none; transition: all 0.2s; font-size: 14px; }

.ai-response-box { background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 14px; padding: 15px; line-height: 1.6; font-size: 14px; margin-top: 10px; white-space: pre-wrap; }

#toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 24px; border-radius: 16px; background: rgba(10,14,26,.92); border: 1px solid rgba(255,255,255,.12); color: var(--text); display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s ease; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight:bold; }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª <span class="version-badge">v12.3</span></h1>
    <div class="sub">âš¡ Ù†Ø³Ø®Ø© Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªØ¯Ø§Ø®Ù„Ø§Øª (Stable & Complete)</div>
  </div>

  <div class="card">
    <div class="topbar">
      <div class="topbar-actions">
        <button class="btn primary" onclick="openAddSub()">â• Ø¥Ø¶Ø§ÙØ©</button>
        <button id="mainAiBtn" class="btn ai-btn" onclick="openAiAnalysis()">ğŸ§  ØªØ­Ù„ÙŠÙ„ Gemini</button>
        <button class="btn soft" onclick="openModal('storeSettingsModal')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <div class="statChip sync" id="syncChip"><span class="ico">â˜ï¸</span> <span class="v" id="syncVal">Ù…ØªØµÙ„</span></div>
      </div>
      <div class="searchWrap">
        <input id="search" oninput="window.render()" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø©..." />
      </div>
    </div>

    <div class="filtersBar">
      <button class="filterBtn active" onclick="setFilter(this, 'all')">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" onclick="setFilter(this, 'active')">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" onclick="setFilter(this, 'expiring')">â° Ù‚Ø±ÙŠØ¨</button>
      <button class="filterBtn" onclick="setFilter(this, 'expired')">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th> <th>Ø§Ù„Ù‡Ø§ØªÙ</th> <th>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th> <th>Ø§Ù„Ø³Ø¹Ø±</th> <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th> <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th> <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
    <div class="box"><div class="modalHeader"><h2>Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ</h2><button class="btn" onclick="closeModal('formModal')">âœ•</button></div>
    <div class="modalBody">
      <div class="formGrid">
          <div class="field full-width"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input id="name"></div>
          <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="phone"></div>
          <div class="field"><label>Ø§Ù„Ø®Ø¯Ù…Ø© (Ù…Ø«Ù„Ø§Ù‹: Netflix)</label><input id="serviceType"></div>
          <div class="field"><label>Ø§Ù„Ù…Ø¯Ø© (Ø£Ø´Ù‡Ø±)</label><input id="months" type="number" value="1"></div>
          <div class="field"><label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><input id="price" type="number" oninput="window.calcDebt()"></div>
          <div class="field"><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input id="paidAmount" type="number" oninput="window.calcDebt()"></div>
          <div class="field"><label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¯ÙŠÙ†)</label><input id="debtAmount" readonly></div>
          <div class="field full-width"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input id="start" type="date"></div>
      </div>
    </div>
    <div class="modalFooter"><button class="btn primary" onclick="saveSubscription()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button></div></div>
</div>

<div class="modal" id="storeSettingsModal" aria-hidden="true">
  <div class="box" style="width: 450px">
    <div class="modalHeader"><h2>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><button class="btn" onclick="closeModal('storeSettingsModal')">âœ•</button></div>
    <div class="modalBody" style="padding:20px;">
       <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¬Ø±</label><input id="setStoreName"></div>
       <div style="margin-top:15px; border-top:1px solid var(--line); padding-top:15px;">
         <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
           <input type="checkbox" id="enableAiToggle" onchange="toggleAiVisibility(this.checked)"> ØªÙØ¹ÙŠÙ„ Ø°ÙƒØ§Ø¡ Gemini
         </label>
         <div id="aiSettingsFields" style="margin-top:10px; display:none;">
           <div class="field"><label>Gemini API Key</label><input id="geminiKey" type="password"></div>
           <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; cursor: pointer;">
             <input type="checkbox" id="privacyShield" checked> Ø¯Ø±Ø¹ Ø§Ù„Ø®ØµÙˆØµÙŠØ© (ØªØ´ÙÙŠØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¹Ù† AI)
           </label>
         </div>
       </div>
    </div>
    <div class="modalFooter"><button class="btn primary" onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button></div>
  </div>
</div>

<div class="modal" id="aiModal" aria-hidden="true">
  <div class="box" style="width: 600px">
    <div class="modalHeader"><h2>ğŸ§  Ù…Ø³Ø§Ø¹Ø¯ Gemini Ø§Ù„Ø°ÙƒÙŠ</h2><button class="btn" onclick="closeModal('aiModal')">âœ•</button></div>
    <div class="modalBody" style="padding:20px;">
      <div id="aiLoading" style="display:none; text-align:center; margin-bottom: 10px;">ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.</div>
      <div id="aiError" style="display:none; color:var(--err); padding:10px; border:1px solid var(--err); border-radius:8px; margin-bottom:10px;"></div>
      <div id="aiResult" class="ai-response-box" style="display:none;"></div>
      <button class="btn ai-btn" id="generateAiBtn" style="width:100%; display:block; margin-top: 15px;" onclick="generateAiReport()">âœ¨ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';
// 1. ØªÙ‡ÙŠØ¦Ø© Firebase
const FIREBASE_CONFIG = { apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ", authDomain: "dattta-6f497.firebaseapp.com", databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com", projectId: "dattta-6f497" };
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const $ = (id)=>document.getElementById(id);
let data = []; 
let currentFilter = "all";
let storeSettings = { name: "Ù…ØªØ¬Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª", geminiKey: "", enableAi: false, privacyShield: true };

// 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
window.showToast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
};

window.openModal = (id) => $(id).setAttribute('aria-hidden', 'false');
window.closeModal = (id) => $(id).setAttribute('aria-hidden', 'true');

// 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¬Ù„Ø¨ØŒ Ø¥Ø¶Ø§ÙØ©ØŒ Ø­Ø°Ù)
window.loadData = async () => {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    const sSnap = await db.ref("settings/storeInfo").once('value');
    if(sSnap.exists()) {
        storeSettings = { ...storeSettings, ...sSnap.val() };
        $("setStoreName").value = storeSettings.name || "";
        $("geminiKey").value = storeSettings.geminiKey || "";
        $("privacyShield").checked = !!storeSettings.privacyShield;
        $("enableAiToggle").checked = !!storeSettings.enableAi;
        window.toggleAiVisibility(storeSettings.enableAi);
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
    db.ref("subscriptions").on('value', (snap) => {
        const val = snap.val();
        data = val ? Object.keys(val).map(key => ({ ...val[key], id: key })) : [];
        window.render();
    });
};

window.saveSubscription = async () => {
    const startVal = $("start").value;
    const months = parseInt($("months").value) || 1;
    if(!startVal || !$("name").value) return showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©");

    const start = new Date(startVal);
    const end = new Date(start.setMonth(start.getMonth() + months));
    const endISO = end.toISOString().split('T')[0];

    const newSub = {
        name: $("name").value,
        phone: $("phone").value || "-",
        serviceType: $("serviceType").value || "-",
        price: parseFloat($("price").value) || 0,
        paidAmount: parseFloat($("paidAmount").value) || 0,
        start: startVal,
        end: endISO
    };

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ (Push Key) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø­Ø°Ù Ù„Ø§Ø­Ù‚Ø§Ù‹
    await db.ref("subscriptions").push(newSub);
    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    closeModal('formModal');
};

window.deleteSub = async (id) => {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
        await db.ref("subscriptions/" + id).remove();
        showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù ğŸ—‘ï¸");
    }
};

// 4. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ø¹Ø±Ø¶
window.calcDebt = () => { 
    const p = parseFloat($("price").value) || 0;
    const paid = parseFloat($("paidAmount").value) || 0;
    $("debtAmount").value = Math.max(0, p - paid); 
};

function getStatus(endISO, alertDays) {
    const d1 = new Date(endISO); const d2 = new Date();
    const left = Math.round((d1 - d2)/(1000*60*60*24));
    if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err"};
    if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨", cls:"warn"};
    return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok"};
}

window.render = () => {
    const q = ($("search").value || "").toLowerCase();
    const tb = $("tbody"); tb.innerHTML = "";
    data.filter(r => {
        const match = !q || r.name.toLowerCase().includes(q) || r.serviceType.toLowerCase().includes(q);
        const st = getStatus(r.end, 7);
        return (currentFilter === "all" || currentFilter === st.key) && match;
    }).forEach(r => {
        const st = getStatus(r.end, 7);
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><b>${r.name}</b></td>
            <td>${r.phone}</td>
            <td>${r.serviceType}</td>
            <td>${r.price}</td>
            <td>${r.paidAmount}</td>
            <td>${r.end}</td>
            <td><span class="badge ${st.cls}">${st.label}</span></td>
            <td><button class="btn danger" onclick="deleteSub('${r.id}')">Ø­Ø°Ù</button></td>
        `;
        tb.appendChild(tr);
    });
};

// 5. Ù‚Ø³Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ¬Ø±
window.toggleAiVisibility = (enabled) => {
    $("mainAiBtn").style.display = enabled ? "inline-flex" : "none";
    $("aiSettingsFields").style.display = enabled ? "block" : "none";
};

window.saveSettings = async () => {
    storeSettings.enableAi = $("enableAiToggle").checked;
    storeSettings.geminiKey = $("geminiKey").value;
    storeSettings.name = $("setStoreName").value;
    storeSettings.privacyShield = $("privacyShield").checked;
    await db.ref("settings/storeInfo").set(storeSettings);
    window.toggleAiVisibility(storeSettings.enableAi);
    showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âš™ï¸");
    closeModal('storeSettingsModal');
};

window.openAiAnalysis = () => { 
    $("aiResult").style.display = "none"; 
    $("aiError").style.display = "none"; 
    openModal("aiModal"); 
};

async function callGemini(prompt, systemPrompt) {
  const apiKey = storeSettings.geminiKey;
  if(!apiKey) throw new Error("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ API Key Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Gemini ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.");

  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    systemInstruction: { parts: [{ text: systemPrompt }] }
  };

  const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  const result = await response.json();
  if (result.error) throw new Error(result.error.message);
  return result.candidates?.[0]?.content?.parts?.[0]?.text || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø©.";
}

window.generateAiReport = async () => {
  const btn = $("generateAiBtn"); 
  btn.disabled = true; 
  $("aiLoading").style.display = "block";
  $("aiError").style.display = "none";
  $("aiResult").style.display = "none";
  
  try {
    const shieldOn = storeSettings.privacyShield;
    // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    const cleanData = data.map(r => ({ 
        service: r.serviceType, 
        price: r.price, 
        debt: Math.max(0, r.price - r.paidAmount), 
        status: getStatus(r.end, 7).label, 
        client: shieldOn ? "Ø¹Ù…ÙŠÙ„ Ù…Ø®ÙÙŠ Ù„Ù„Ø­Ù…Ø§ÙŠØ©" : r.name 
    }));
    
    const sysPrompt = "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ù…Ø§Ù„ÙŠ ÙˆØ¥Ø¯Ø§Ø±ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù‡Ø°Ù‡ØŒ Ø£Ø¹Ø·Ù†ÙŠ Ù…Ù„Ø®ØµØ§Ù‹ Ø¹Ù† Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©ØŒ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„ØªÙŠ Ø£ÙˆØ´ÙƒØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡. Ù‚Ø¯Ù… Ø§Ù„Ù†ØµÙŠØ­Ø© Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù…Ù†Ø¸Ù… ÙˆÙ…Ø¨Ø§Ø´Ø±.";
    
    const report = await callGemini(JSON.stringify(cleanData), sysPrompt);
    $("aiResult").textContent = report; 
    $("aiResult").style.display = "block";
  } catch (err) { 
    $("aiError").textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message; 
    $("aiError").style.display = "block"; 
  } finally { 
    $("aiLoading").style.display = "none"; 
    btn.disabled = false; 
  }
};

// 6. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø¨Ø­Ø«
window.loadData();
window.openAddSub = () => {
    $("name").value = ""; $("phone").value = ""; $("serviceType").value = "";
    $("price").value = ""; $("paidAmount").value = ""; $("debtAmount").value = "";
    $("start").value = new Date().toISOString().split('T')[0];
    openModal("formModal");
};
window.setFilter = (btn, f) => { 
    document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active")); 
    btn.classList.add("active"); 
    currentFilter=f; 
    window.render(); 
};
</script>
</body>
</html>
