<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©)</title>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }
.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; transition: all .15s ease; }
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.55); background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12)); }
.btn.soft{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input, .searchWrap select { width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; }
.searchWrap input:focus, .searchWrap select:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }

.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 0 14px 14px 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© */
.bulkBar{ display: none; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(124,92,255,.15); border-bottom: 1px solid rgba(124,92,255,.3); }
.bulkBar .selCount{ font-weight: 900; color: #fff; background: var(--accent); padding: 4px 10px; border-radius: 99px; font-size: 12px; }

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap; align-items:center;}
.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color: var(--text); }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }

/* Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ */
input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid var(--muted); border-radius: 4px; background: rgba(0,0,0,.2); cursor: pointer; position: relative; display: inline-block; vertical-align: middle; }
input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
input[type="checkbox"]:checked::after { content: "âœ”"; position: absolute; color: white; font-size: 12px; left: 3px; top: -1px; font-weight: bold; }

.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 1050px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; font-weight:900; padding:12px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.07); white-space:nowrap; vertical-align:middle; }

tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }
tr.expired-row td:nth-child(2){ box-shadow: inset 4px 0 0 rgba(239,68,68,.85); }
tr.expiring-row td:nth-child(2){ box-shadow: inset 4px 0 0 rgba(245,158,11,.85); }

.badge{ display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.62); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: 0 30px 90px rgba(0,0,0,.65); overflow:hidden; }
.modalHeader{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; }
.modalHeader h2{margin:0;font-size:16px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 14px 16px; }
.modalFooter{ padding:12px 16px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; }

.formGrid{ display:grid; grid-template-columns: 1.2fr 1.2fr 1.2fr .9fr .9fr .9fr .9fr .9fr; gap:10px; }
@media (max-width: 980px){ .formGrid{ grid-template-columns: 1fr 1fr; } }
.field label{ display:block; font-weight:900; font-size:12px; color: var(--muted); margin-bottom:6px; }

.actionPill{ padding:10px 12px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); font-weight: 900; cursor:pointer; }
.actGrid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
@media (max-width: 640px){ .actGrid{ grid-template-columns: 1fr; } }
.actBtn{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); padding: 14px; border-radius: 18px; font-weight: 900; cursor:pointer; }
.actBtn.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.20); }

.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 14px; border-radius: 16px; background: rgba(10,14,26,.92); border: 1px solid rgba(255,255,255,.12); color: var(--text); display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s ease; z-index: 10000; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;}

@media print{ .filtersBar, .topbar, .btn, .toast, .modal, .bulkBar{ display:none !important; } }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">âš¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø¯Ù…Ø¬Ø© (Ø§Ù„Ø£ØµÙ„ + Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª)</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openBackup" type="button">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <button class="btn soft" id="openSync" type="button">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      <button class="btn soft" id="openTotals" type="button">ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
      <button class="btn soft" id="openAuth" type="button">ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>

      <div class="searchWrap">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." />
      </div>

      <button class="btn soft" id="shareBtn" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
      <button class="btn soft" id="printBtn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn danger" id="clearBtn" type="button">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>

      <div class="pills" id="statsBar">
        <div class="statChip sync" id="syncChip">
          <span class="ico">â˜ï¸</span> <span class="k">Ù…Ø²Ø§Ù…Ù†Ø©:</span> <span class="v" id="syncVal">â€”</span>
        </div>
      </div>
    </div>

    <div class="bulkBar" id="bulkBar">
      <div class="selCount" id="selCount">0 Ù…Ø­Ø¯Ø¯</div>
      <button class="btn" id="bulkExtend" style="border-color:var(--accent); color:var(--accent);">ğŸ” ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button class="btn danger" id="bulkDelete">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      <button class="btn soft" id="clearSelection" style="margin-inline-start:auto;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" data-filter="active">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" data-filter="expiring">â° Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="filterBtn" data-filter="expired">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAll"></th>
            <th>Ø§Ù„Ø§Ø³Ù…</th> <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th> <th>Ø§Ù„Ù‡Ø§ØªÙ</th> <th>Ø§Ù„Ù…Ø¯Ø©</th> <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th> <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th> <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th> <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader"><div><h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2><div class="hint">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div></div><button class="btn" id="closeForm" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="name" placeholder="Ù…Ø«Ø§Ù„: Ahmed"></div>
        <div class="field"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="email" placeholder="name@example.com" inputmode="email"></div>
        <div class="field">
          <label>Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø¹ Ø§Ù„Ø±Ù…Ø²)</label>
          <div style="display: flex; gap: 5px;">
            <select id="countryCode" style="width: 90px; direction: ltr;">
              <option value="+213">ğŸ‡©ğŸ‡¿ +213</option><option value="+212">ğŸ‡²ğŸ‡¦ +212</option><option value="+216">ğŸ‡¹ğŸ‡³ +216</option><option value="">Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø²</option>
            </select>
            <input id="phone" type="tel" dir="ltr" placeholder="555000000" style="flex:1;">
          </div>
        </div>
        <div class="field">
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹</label>
          <select id="quickPlan"><option value="">â€” Ø§Ø®ØªØ± â€”</option><option value="1">1 Ø´Ù‡Ø±</option><option value="3">3 Ø£Ø´Ù‡Ø±</option><option value="6">6 Ø£Ø´Ù‡Ø±</option><option value="12">12 Ø´Ù‡Ø±</option></select>
        </div>
        <div class="field"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</label><input id="months" type="number" min="1" step="1"></div>
        <div class="field"><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="price" type="number" min="0" step="0.01"></div>
        <div class="field">
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select id="currency"><option value="DZD">DZD</option><option value="EUR">EUR</option><option value="USD">USD</option><option value="MAD">MAD</option><option value="TND">TND</option></select>
        </div>
        <div class="field"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input id="start" type="date"></div>
        <div class="field"><label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ (Ø£ÙŠØ§Ù…)</label><input id="alertDays" type="number" min="1" step="1" value="7"></div>
      </div>
    </div>
    <div class="modalFooter"><button class="btn primary" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button><button class="btn" id="cancelBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button></div>
  </div>
</div>

<div class="modal" id="extendModal" aria-hidden="true">
  <div class="box" style="width: 350px">
    <div class="modalHeader"><h2 id="extendTitle">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2><button class="btn" onclick="closeModal('extendModal')">âœ•</button></div>
    <div class="modalBody">
      <div class="field" style="margin-bottom:15px"><label>Ø§Ù„Ù…Ø¯Ø©</label><input id="extendValue" type="number" min="1" value="1"></div>
      <div class="field" style="margin-bottom:20px"><label>Ø§Ù„ÙˆØ­Ø¯Ø©</label><select id="extendUnit"><option value="months">Ø£Ø´Ù‡Ø±</option><option value="days">Ø£ÙŠØ§Ù…</option></select></div>
      <button class="btn primary" id="confirmExtendBtn" style="width:100%">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</button>
    </div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(740px, 100%)">
    <div class="modalHeader"><div><h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2><div class="hint" id="rowActionsHint">â€”</div></div><button class="btn" id="closeRowActionsX" type="button">âœ•</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend" type="button">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actCopyEmail" type="button">ğŸ“‹ Ù†Ø³Ø® Email</button>
        <button class="actBtn" id="actWhatsApp" type="button" style="border-color: rgba(37,211,102,.5); background: rgba(37,211,102,.15); color: #4ade80;">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="actBtn danger" id="actDelete" type="button" style="grid-column: span 2;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" style="width: 450px">
    <div class="modalHeader"><h2>ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2><button class="btn" id="closeAuthBtn" onclick="closeModal('authModal')" style="display:none">âœ•</button></div>
    <div class="modalBody">
      <div id="authLoginSection">
        <div class="field" style="margin-bottom:10px"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="authEmail"></div>
        <div class="field" style="margin-bottom:15px"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="authPass" type="password"></div>
        <button class="btn primary" id="authLogin" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
      </div>
      <div id="authLoggedInSection" style="display:none;">
        <div id="authStateText" style="margin-bottom:20px; font-weight:900; font-size:14px; text-align:center;"></div>
        <div id="ownerDashboard" style="display:none; padding:15px; background:rgba(124,92,255,0.1); border-radius:16px; border:1px solid rgba(124,92,255,0.3); margin-bottom:20px;">
          <h3 style="margin-top:0; color:#fff; font-size:14px;">ğŸ‘‘ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ</h3>
          <button class="btn primary" onclick="openModal('addAdminModal')" style="width:100%; margin-bottom:10px;">â• Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn soft" onclick="loadAdminsList()" style="width:100%;">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
        </div>
        <button class="btn danger" id="authLogout" style="width:100%">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="addAdminModal" aria-hidden="true">
  <div class="box" style="width: 380px">
    <div class="modalHeader"><h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h2><button class="btn" onclick="closeModal('addAdminModal')">âœ•</button></div>
    <div class="modalBody">
      <div class="field" style="margin-bottom:10px"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="newAdminEmail" type="email"></div>
      <div class="field" style="margin-bottom:10px"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø£Ùˆ Ø£ÙƒØ«Ø±)</label><input id="newAdminPass" type="password"></div>
      <div class="field" style="margin-bottom:20px"><label>Ù†ÙˆØ¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label><select id="newAdminRole"><option value="admin">Ø£Ø¯Ù…Ù†</option><option value="owner">Ù…Ø§Ù„Ùƒ ğŸ‘‘</option></select></div>
      <button class="btn primary" id="confirmAddAdminBtn" style="width:100%">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>
  </div>
</div>

<div class="modal" id="manageAdminsModal" aria-hidden="true">
  <div class="box" style="width: 500px">
    <div class="modalHeader"><h2>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2><button class="btn" onclick="closeModal('manageAdminsModal')">âœ•</button></div>
    <div class="modalBody" style="max-height:300px; overflow:auto;">
      <table style="min-width:100%;"><thead><tr><th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="adminsTbody"></tbody></table>
    </div>
  </div>
</div>

<div class="modal" id="backupModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2><button class="btn" id="closeBackup" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div><div class="modalBody"><div style="display:grid; gap:10px;"><button class="btn soft" id="exportJsonBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button><button class="btn soft" id="importFileBtn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button><input id="fileInput" type="file" style="display:none"><button class="btn soft" onclick="openModal('pasteModal')">ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚</button></div></div></div></div>
<div class="modal" id="pasteModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚</h2><button class="btn" onclick="closeModal('pasteModal')">âœ•</button></div><div class="modalBody"><textarea id="pasteArea" rows="10" style="width:100%;"></textarea></div><div class="modalFooter"><button class="btn primary">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button></div></div></div>
<div class="modal" id="syncModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2><button class="btn" id="closeSyncX" type="button">âœ•</button></div><div class="modalBody">Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ âœ…</div></div></div>
<div class="modal" id="totalsModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>ğŸ’° Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</h2><button class="btn" id="closeTotalsX" type="button">âœ•</button></div><div class="modalBody"><div id="totalsBody" style="font-size:20px; text-align:center; font-weight:bold;">Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹</div></div></div></div>

<div id="toast" class="toast"></div>

<script>
'use strict';
const FIREBASE_CONFIG = { apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ", authDomain: "dattta-6f497.firebaseapp.com", databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com", projectId: "dattta-6f497", storageBucket: "dattta-6f497.firebasestorage.app", messagingSenderId: "804914291938", appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb" };

const $ = (id)=>document.getElementById(id);
const LOCAL_BACKUP_KEY = "subs_local_backup_v5";
let data = []; let editingId = null; let currentRowId = null; let currentFilter = "all"; 
let selectedIds = new Set(); let extendMode = "single";
let currentUser = null; let currentRole = null;

if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth(); const db = firebase.database();

auth.onAuthStateChanged(async (u)=>{
  currentUser = u;
  if(u){
    try {
      const roleSnap = await db.ref("admins/" + u.uid).once("value");
      let roleData = roleSnap.val();
      if(roleData === true) { roleData = { role: "owner", email: u.email }; await db.ref("admins/" + u.uid).set(roleData); }
      currentRole = roleData?.role || "admin";
      $("closeAuthBtn").style.display = "block"; closeModal("authModal"); await load();
    } catch(e) { showToast("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª", "err"); auth.signOut(); }
  } else {
    currentRole = null; data = []; render(); 
    $("closeAuthBtn").style.display = "none"; openModal("authModal");
  }
  updateAuthUI();
});

function updateAuthUI() {
  if(currentUser) {
    $("authLoginSection").style.display = "none"; $("authLoggedInSection").style.display = "block";
    $("authStateText").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.email} (${currentRole === "owner" ? "Ù…Ø§Ù„Ùƒ ğŸ‘‘" : "Ø£Ø¯Ù…Ù† ğŸ‘¤"})`;
    $("ownerDashboard").style.display = currentRole === "owner" ? "block" : "none";
  } else {
    $("authLoginSection").style.display = "block"; $("authLoggedInSection").style.display = "none";
  }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯Ø±Ø§Ø¡ (Ø§Ù„Ù…Ø§Ù„Ùƒ)
$("confirmAddAdminBtn").onclick = async () => {
  const email = $("newAdminEmail").value.trim(); const pass = $("newAdminPass").value; const role = $("newAdminRole").value;
  if(!email || pass.length < 6) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "err");
  try {
    setSyncState("saving");
    const secondaryApp = firebase.initializeApp(FIREBASE_CONFIG, "SecondaryApp");
    const userCredential = await secondaryApp.auth().createUserWithEmailAndPassword(email, pass);
    await db.ref("admins/" + userCredential.user.uid).set({ role: role, email: email });
    await secondaryApp.auth().signOut(); await secondaryApp.delete();
    closeModal("addAdminModal"); $("newAdminEmail").value = ""; $("newAdminPass").value = "";
    showToast(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨!`); setSyncState("ok");
  } catch (error) { showToast("Ø®Ø·Ø£: " + error.message, "err"); setSyncState("fail"); try { const app = firebase.app("SecondaryApp"); if(app) await app.delete(); } catch(e){} }
};

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ (Ø§Ù„Ù…Ø§Ù„Ùƒ)
window.loadAdminsList = async () => {
  openModal("manageAdminsModal");
  const tb = $("adminsTbody"); tb.innerHTML = "<tr><td colspan='3' style='text-align:center'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";
  const snap = await db.ref("admins").once("value"); const adminsObj = snap.val() || {}; tb.innerHTML = "";
  for(let uid in adminsObj) {
    let uData = adminsObj[uid]; let isOwner = uData.role === "owner" || uData === true;
    let actionBtn = uid === currentUser.uid ? `<span style="color:var(--muted)">Ø­Ø³Ø§Ø¨Ùƒ</span>` : `<button class="btn danger" onclick="revokeAdmin('${uid}')">Ø³Ø­Ø¨ ØµÙ„Ø§Ø­ÙŠØ©</button>`;
    tb.innerHTML += `<tr><td>${uData.email || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td><td>${isOwner?"Ù…Ø§Ù„Ùƒ ğŸ‘‘":"Ø£Ø¯Ù…Ù† ğŸ‘¤"}</td><td>${actionBtn}</td></tr>`;
  }
};
window.revokeAdmin = async (uid) => { if(confirm("Ø³Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŸ")) { await db.ref("admins/" + uid).remove(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); loadAdminsList(); } };

// Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ§Ø±ÙŠØ®
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(iso){ const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return d; }

function saveLocalBackup(){ localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data)); }
function loadLocalBackup(){ try { const j = JSON.parse(localStorage.getItem(LOCAL_BACKUP_KEY)); return Array.isArray(j) ? j : []; } catch { return []; } }

function setSyncState(state){
  const chip = $("syncChip"); const val = $("syncVal"); chip.className = "statChip sync " + state;
  if(!navigator.onLine) val.textContent = "Ø£ÙˆÙÙ„Ø§ÙŠÙ† ğŸ“´";
  else if(state==="saving") val.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
  else if(state==="ok") { const d = new Date(); val.textContent = d.getHours()+":"+String(d.getMinutes()).padStart(2,"0") + " âœ…"; }
}

async function load() {
  if(!navigator.onLine) { data = loadLocalBackup(); render(); return; }
  try { setSyncState("saving"); const snap = await db.ref("subscriptions").once('value'); data = snap.val() ? Object.values(snap.val()) : []; saveLocalBackup(); setSyncState("ok"); render(); } catch(e) {}
}
async function firebasePush() {
  if(!navigator.onLine) return;
  try { setSyncState("saving"); await db.ref("subscriptions").set(data); saveLocalBackup(); setSyncState("ok"); } catch(e) { showToast("Ø®Ø·Ø£", "err"); }
}

// Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
function updateBulkUI() { const bar = $("bulkBar"); if(selectedIds.size > 0) { bar.style.display = "flex"; $("selCount").textContent = `${selectedIds.size} Ù…Ø­Ø¯Ø¯`; } else { bar.style.display = "none"; $("selectAll").checked = false; } }
$("tbody").addEventListener("change", (e) => { if(e.target.classList.contains("rowChk")) { if(e.target.checked) selectedIds.add(e.target.value); else selectedIds.delete(e.target.value); updateBulkUI(); } });
$("selectAll").addEventListener("change", (e) => { const isChkd = e.target.checked; document.querySelectorAll(".rowChk").forEach(chk => { chk.checked = isChkd; if(isChkd) selectedIds.add(chk.value); else selectedIds.delete(chk.value); }); updateBulkUI(); });
$("clearSelection").onclick = () => { selectedIds.clear(); render(); updateBulkUI(); };
$("bulkDelete").onclick = async () => { if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù ${selectedIds.size} Ø§Ø´ØªØ±Ø§ÙƒØ§ØªØŸ`)) return; data = data.filter(x => !selectedIds.has(x.id)); selectedIds.clear(); await firebasePush(); render(); updateBulkUI(); showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù"); };
$("bulkExtend").onclick = () => { extendMode = "bulk"; $("extendTitle").textContent = `ØªØ¬Ø¯ÙŠØ¯ ${selectedIds.size} Ù…Ø´ØªØ±Ùƒ`; $("extendValue").value = 1; $("extendUnit").value = "months"; openModal("extendModal"); };

function getStatus(endISO, alertDays) {
  const left = Math.round((toDate(endISO) - toDate(todayISO()))/(1000*60*60*24));
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}

function render(){
  const q = ($("search").value||"").trim().toLowerCase(); const tb = $("tbody"); tb.innerHTML=""; if($("selectAll")) $("selectAll").checked = false;
  const alertD = parseInt($("alertDays")?.value || 7);
  const rows = data.filter(r=>{ const match = !q || r.name.toLowerCase().includes(q) || (r.phone||"").includes(q) || (r.email||"").toLowerCase().includes(q); const st = getStatus(r.end, alertD); if(currentFilter !== "all" && currentFilter !== st.key) return false; return match; });
  
  rows.forEach(r=>{
    const st = getStatus(r.end, alertD); const isChecked = selectedIds.has(r.id) ? "checked" : ""; const tr = document.createElement("tr");
    if(st.key === "expired") tr.className = "expired-row"; else if(st.key === "expiring") tr.className = "expiring-row";
    tr.innerHTML = `<td style="text-align: center;"><input type="checkbox" class="rowChk" value="${r.id}" ${isChecked}></td><td>${r.name}</td><td>${r.email||'-'}</td><td dir="ltr">${r.phone?`${r.countryCode||''} ${r.phone}`:'-'}</td><td>${r.months} Ø´</td><td>${r.price||0} ${r.currency||'DZD'}</td><td>${r.start}</td><td>${r.end}</td><td>${st.left < 0 ? 'Ù…Ù†Ø° ' + Math.abs(st.left) : st.left} ÙŠÙˆÙ…</td><td><span class="badge ${st.cls}">${st.label}</span></td><td><button class="actionPill" onclick="openRowActions('${r.id}')">âš¡ Ø¥Ø¬Ø±Ø§Ø¡</button></td>`;
    tb.appendChild(tr);
  });
}

// Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ© ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
window.openRowActions = (id) => { currentRowId = id; const rec = data.find(x => x.id === id); $("rowActionsHint").textContent = rec.name; openModal("rowActionsModal"); };
$("actEdit").onclick = () => { const rec = data.find(x => x.id === currentRowId); if(!rec) return; closeModal("rowActionsModal"); editingId = rec.id; $("formTitle").textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ"; $("name").value = rec.name||""; $("email").value = rec.email||""; $("phone").value = rec.phone||""; $("countryCode").value = rec.countryCode||"+213"; $("months").value = rec.months||""; $("price").value = rec.price||""; $("currency").value = rec.currency||"DZD"; $("start").value = rec.start; openModal("formModal"); };
$("actDelete").onclick = async () => { if(confirm("Ø­Ø°ÙØŸ")) { data = data.filter(x => x.id !== currentRowId); await firebasePush(); render(); closeModal("rowActionsModal"); } };
$("actExtend").onclick = () => { extendMode = "single"; const rec = data.find(x => x.id === currentRowId); $("extendTitle").textContent = `ØªØ¬Ø¯ÙŠØ¯ Ù„Ù€ ${rec.name}`; $("extendValue").value = 1; $("extendUnit").value = "months"; closeModal("rowActionsModal"); openModal("extendModal"); };
$("actCopyEmail").onclick = () => { const rec = data.find(x => x.id === currentRowId); if(!rec || !rec.email) { closeModal("rowActionsModal"); return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„.", "err"); } navigator.clipboard.writeText(rec.email); closeModal("rowActionsModal"); showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ğŸ“‹"); };
$("actWhatsApp").onclick = () => { const rec = data.find(x => x.id === currentRowId); if(!rec || !rec.phone) { closeModal("rowActionsModal"); return showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ.", "err"); } let cleanPhone = ((rec.countryCode||'')+rec.phone).replace(/[^0-9+]/g, ''); window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${rec.name}ØŒ Ù†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨ØªØ§Ø±ÙŠØ® ${rec.end}.`)}`, '_blank'); closeModal("rowActionsModal"); };

$("confirmExtendBtn").onclick = async () => {
  const val = parseInt($("extendValue").value); const unit = $("extendUnit").value; if(isNaN(val) || val < 1) return showToast("ØºÙŠØ± ØµØ§Ù„Ø­", "err");
  const processRecord = (rec) => { const endD = new Date(rec.end); if(unit === "months") { endD.setMonth(endD.getMonth() + val); rec.months = (parseInt(rec.months)||0) + val; } else { endD.setDate(endD.getDate() + val); } rec.end = endD.toISOString().split('T')[0]; return rec; };
  if(extendMode === "bulk") { data = data.map(x => selectedIds.has(x.id) ? processRecord(x) : x); selectedIds.clear(); updateBulkUI(); } else { data = data.map(x => x.id === currentRowId ? processRecord(x) : x); }
  await firebasePush(); render(); closeModal("extendModal"); showToast("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ ğŸ”");
};

$("quickPlan").onchange = ()=>{ if($("quickPlan").value) $("months").value = $("quickPlan").value; };
$("saveBtn").onclick = async () => {
  const start = $("start").value; const months = parseInt($("months").value); if(!$("name").value || !start || isNaN(months)) return showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©", "err");
  const endD = new Date(start); endD.setMonth(endD.getMonth() + months);
  const rec = { id: editingId || Date.now().toString(), name: $("name").value, email: $("email").value, phone: $("phone").value, countryCode: $("countryCode").value, months, price: $("price").value, currency: $("currency").value, start, end: endD.toISOString().split('T')[0] };
  if(editingId) data = data.map(x => x.id === editingId ? rec : x); else data.unshift(rec);
  await firebasePush(); render(); closeModal("formModal"); showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ¨");
};

// Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©
$("openBackup").onclick = ()=> openModal("backupModal"); $("closeBackup").onclick = ()=> closeModal("backupModal");
$("openSync").onclick = ()=> openModal("syncModal"); $("closeSyncX").onclick = ()=> closeModal("syncModal");
$("openTotals").onclick = ()=> openModal("totalsModal"); $("closeTotalsX").onclick = ()=> closeModal("totalsModal");
$("closeForm").onclick = ()=> closeModal("formModal"); $("cancelBtn").onclick = ()=> closeModal("formModal");
$("closeRowActionsX").onclick = ()=> closeModal("rowActionsModal");

$("authLogin").onclick = () => { auth.signInWithEmailAndPassword($("authEmail").value, $("authPass").value).catch(e => showToast("Ø®Ø·Ø£: " + e.message, "err")); };
$("authLogout").onclick = () => auth.signOut();
$("openAdd").onclick = () => { editingId=null; $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ"; $("name").value=""; $("email").value=""; $("phone").value=""; $("countryCode").value="+213"; $("quickPlan").value=""; $("months").value=""; $("price").value=""; $("start").value=todayISO(); openModal("formModal"); };
$("openAuth").onclick = () => openModal("authModal");
$("search").oninput = render;

function openModal(id){ $(id).setAttribute("aria-hidden","false"); }
function closeModal(id){ $(id).setAttribute("aria-hidden","true"); }
function showToast(m, type="ok"){ const t=$("toast"); t.textContent=m; t.style.borderColor = type==="err"?"#ef4444":"#22c55e"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3000); }
document.querySelectorAll(".filterBtn").forEach(b => { b.onclick = (e) => { document.querySelectorAll(".filterBtn").forEach(x=>x.classList.remove("active")); e.target.classList.add("active"); currentFilter = e.target.dataset.filter; render(); }; });
</script>
</body>
</html>
