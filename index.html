<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª 3.1 (Ù…Ø³ØªÙ‚Ø±Ø©)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<style>
:root{
  --bg0:#070a12;
  --bg1:#0b1020;
  --card: rgba(255,255,255,.06);
  --line: rgba(255,255,255,.10);

  --text:#eaf0ff;
  --muted: rgba(234,240,255,.70);

  --accent:#7c5cff;
  --warn:#f59e0b;
  --err:#ef4444;

  --radius:18px;
  --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%),
    radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.18), transparent 60%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  overflow:hidden;
}

.topbar{
  padding:14px;
  border-bottom:1px solid var(--line);
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}

.btn{
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  padding:10px 12px;
  border-radius:14px;
  font-weight:900;
  cursor:pointer;
  transition: transform .08s ease, background .15s ease, border-color .15s ease;
}
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{
  border-color: rgba(124,92,255,.55);
  background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15));
}
.btn.danger{
  border-color: rgba(239,68,68,.55);
  background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12));
}
.btn.soft{
  border-color: rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
}
.btn.soft:hover{ background: rgba(255,255,255,.08); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--text);
  outline:none;
}
.searchWrap input:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

/* ===== Filters Bar ===== */
.filtersBar{
  width: 100%;
  display: flex;
  gap: 8px;
  padding: 0 14px 14px 14px;
  flex-wrap: wrap;
  border-bottom: 1px solid var(--line);
}
.filterBtn{
  padding: 8px 14px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: rgba(0,0,0,.18);
  color: var(--muted);
  font-size: 13px;
  font-weight: 800;
  cursor: pointer;
  transition: all 0.2s ease;
}
.filterBtn:hover{ background: rgba(255,255,255,.05); }
.filterBtn.active{
  background: var(--text);
  color: var(--bg0);
  border-color: var(--text);
}

/* ===== Analytics Dashboard ===== */
.analyticsArea{
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 20px 14px;
  border-bottom: 1px solid var(--line);
  background: rgba(0,0,0,.15);
  align-items: center;
}
.chartContainer{
  height: 160px;
  flex: 1;
  min-width: 250px;
  max-width: 400px;
  position: relative;
}
.revenueContainer{
  flex: 1;
  min-width: 200px;
  padding: 14px;
  background: rgba(255,255,255,.03);
  border: 1px solid var(--line);
  border-radius: 16px;
}
.revTitle{ color: var(--muted); font-size: 13px; font-weight: 900; margin-bottom: 8px; }
.revValue{ color: var(--text); font-size: 24px; font-weight: 900; }

.pills{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}

/* ===== Stats Bar ===== */
#statsBar{
  margin-inline-start:auto;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.statChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.18);
  font-size:12px;
  font-weight:900;
  color: var(--text);
  white-space:nowrap;
}
.statChip .k{ color: var(--muted); font-weight:900; }
.statChip .v{ font-weight:900; }
.statChip.ok{ border-color: rgba(34,197,94,.40); }
.statChip.warn{ border-color: rgba(245,158,11,.40); }
.statChip.err{ border-color: rgba(239,68,68,.40); }
.statChip.sync{
  border-color: rgba(124,92,255,.45);
  background: rgba(124,92,255,.10);
}

@media (max-width: 650px){
  #statsBar{ width:100%; margin-inline-start:0; }
  .statChip{ flex: 1 1 auto; justify-content:center; }
}

/* ======= Table ======= */
.tableWrap{ overflow:auto; }
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width: 980px;
}
thead th{
  position:sticky; top:0;
  z-index:5;
  background: rgba(0,0,0,.22);
  color: var(--muted);
  text-align:right;
  font-size:12px;
  font-weight:900;
  padding:12px 12px;
  border-bottom:1px solid var(--line);
}
tbody td{
  padding:12px 12px;
  border-bottom:1px solid rgba(255,255,255,.07);
  white-space:nowrap;
  vertical-align:middle;
}
tbody tr:hover{ background: rgba(255,255,255,.03); }

tr.expired-row{ background: rgba(239,68,68,.10); }
tr.expiring-row{ background: rgba(245,158,11,.08); }
tr.expired-row td:first-child{ box-shadow: inset 4px 0 0 rgba(239,68,68,.85); }
tr.expiring-row td:first-child{ box-shadow: inset 4px 0 0 rgba(245,158,11,.85); }

.badge{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  font-size:12px;
  font-weight:900;
}
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

/* ======= Modals ======= */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.62);
  z-index:9999;
  padding: 18px;
}
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{
  width:min(860px, 100%);
  background: rgba(10,14,26,.96);
  border: 1px solid rgba(255,255,255,.10);
  border-radius: 22px;
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  overflow:hidden;
  animation: pop .14s ease-out;
}
@keyframes pop{ from{ transform: translateY(8px); opacity:.0 } to{ transform: translateY(0); opacity:1 } }
.modalHeader{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
}
.modalHeader h2{margin:0;font-size:16px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 14px 16px; }
.modalFooter{
  padding:12px 16px;
  border-top:1px solid rgba(255,255,255,.10);
  display:flex; gap:10px; flex-wrap:wrap;
  justify-content:flex-start;
}

.formGrid{
  display:grid;
  grid-template-columns: 1.2fr 1.2fr 1.2fr .9fr .9fr .9fr .9fr .9fr;
  gap:10px;
}
@media (max-width: 980px){
  .formGrid{ grid-template-columns: 1fr 1fr; }
}
.field label{
  display:block;
  font-weight:900;
  font-size:12px;
  color: var(--muted);
  margin-bottom:6px;
}
.field input, .field select, .field textarea{
  width:100%;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: var(--text);
  outline:none;
}
.field input:focus, .field select:focus, .field textarea:focus{
  border-color: rgba(124,92,255,.6);
  box-shadow: 0 0 0 4px rgba(124,92,255,.14);
}

/* ===== Actions Modal ===== */
.actionPill{
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor:pointer;
}
.actionPill:hover{ background: rgba(255,255,255,.08); }

.actGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
@media (max-width: 640px){
  .actGrid{ grid-template-columns: 1fr; }
}
.actBtn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  padding: 14px 14px;
  border-radius: 18px;
  font-weight: 900;
  cursor:pointer;
  min-height: 56px;
}
.actBtn:hover{ background: rgba(255,255,255,.08); }
.actBtn:active{ transform: scale(.99); }
.actBtn.danger{
  border-color: rgba(239,68,68,.45);
  background: rgba(239,68,68,.20);
}
.actBtn.danger:hover{ background: rgba(239,68,68,.28); }

/* ===== Toast ===== */
.toast{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%) translateY(20px);
  min-width: min(520px, calc(100% - 28px));
  max-width: 720px;
  padding: 12px 14px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(10,14,26,.92);
  box-shadow: 0 18px 45px rgba(0,0,0,.55);
  color: var(--text);
  font-weight: 900;
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  z-index: 10000;
}
.toast.show{
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}
.toast .ico{ font-size: 16px; }
.toast.err{ border-color: rgba(239,68,68,.45); }
.toast.ok{ border-color: rgba(34,197,94,.40); }
.toast.warn{ border-color: rgba(245,158,11,.40); }
.toast .msg{ font-weight: 900; }
.toast .sub{ color: var(--muted); font-weight: 800; }

@media print{
  .filtersBar, .topbar, .analyticsArea, .btn, .toast, .modal{ display:none !important; }
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

</head>

<body>
<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">âš¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø© 3.1 Ù…Ø¹ ÙƒØ§Ø´Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªÙ‚Ø¯Ù….</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd" type="button">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn soft" id="openBackup" type="button">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
      <button class="btn soft" id="openSync" type="button">â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
      <button class="btn soft" id="openAuth" type="button">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>

      <div class="searchWrap">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." />
      </div>

      <button class="btn soft" id="shareBtn" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
      <button class="btn soft" id="printBtn" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn danger" id="clearBtn" type="button">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>

      <div class="pills" id="statsBar"></div>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" data-filter="active">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" data-filter="expiring">â° Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="filterBtn" data-filter="expired">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="analyticsArea">
      <div class="chartContainer">
        <canvas id="statusChart"></canvas>
      </div>
      <div class="revenueContainer">
        <div class="revTitle">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</div>
        <div id="revenueList">
          <div class="revValue">0.00 DZD</div>
        </div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th> 
            <th>Ø§Ù„Ù…Ø¯Ø©</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2>
        <div class="hint">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸</div>
      </div>
      <button class="btn" id="closeForm" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ahmed">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
          <input id="email" placeholder="name@example.com" inputmode="email">
        </div>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="phone" type="tel" dir="ltr" placeholder="Ù…Ø«Ø§Ù„: 213555000000+">
        </div>
        <div class="field">
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø³Ø±ÙŠØ¹</label>
          <select id="quickPlan">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="1">1 Ø´Ù‡Ø±</option>
            <option value="3">3 Ø£Ø´Ù‡Ø±</option>
            <option value="6">6 Ø£Ø´Ù‡Ø±</option>
            <option value="12">12 Ø´Ù‡Ø±</option>
          </select>
        </div>
        <div class="field">
          <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±</label>
          <input id="months" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 2">
        </div>

        <div class="field">
          <label>Ø§Ù„Ø³Ø¹Ø±</label>
          <input id="price" type="number" min="0" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 9.99">
        </div>
        <div class="field">
          <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
          <select id="currency">
            <option value="DZD">DZD</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
            <option value="MAD">MAD</option>
            <option value="TND">TND</option>
          </select>
        </div>
        <div class="field">
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label>
          <input id="start" type="date">
        </div>
        <div class="field">
          <label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ (Ø£ÙŠØ§Ù…)</label>
          <input id="alertDays" type="number" min="1" step="1" placeholder="Ù…Ø«Ø§Ù„: 7">
        </div>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn primary" id="saveBtn" type="button">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn" id="cancelBtn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:min(740px, 100%)">
    <div class="modalHeader">
      <div>
        <h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
        <div class="hint" id="rowActionsHint">â€”</div>
      </div>
      <button class="btn" id="closeRowActionsX" type="button">âœ•</button>
    </div>

    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actExtend" type="button">ğŸ” ØªØ¬Ø¯ÙŠØ¯</button>
        <button class="actBtn" id="actEdit" type="button">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn" id="actCopyEmail" type="button">ğŸ“‹ Ù†Ø³Ø® Email</button>
        <button class="actBtn" id="actWhatsApp" type="button" style="border-color: rgba(37,211,102,.5); background: rgba(37,211,102,.15); color: #4ade80;">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="actBtn danger" id="actDelete" type="button">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>

    <div class="modalFooter">
      <button class="btn" id="closeRowActions" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<div class="modal" id="backupModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2><button class="btn" id="closeBackup" type="button">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div><div class="modalBody"><div class="backGrid"><div class="backTile"><div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</div><div class="actions"><button class="btn soft" id="exportJsonBtn" type="button">ØªØµØ¯ÙŠØ±</button></div></div><div class="backTile"><div class="t">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù JSON</div><div class="actions"><button class="btn soft" id="importFileBtn" type="button">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</button><input id="fileInput" type="file" accept="application/json,.json" style="display:none"></div></div><div class="backTile"><div class="t">ğŸ“‹ Ù„ØµÙ‚ JSON</div><div class="actions"><button class="btn soft" id="openPasteFromBackup" type="button">ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù„ØµÙ‚</button></div></div><div class="backTile"><div class="t">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</div><div class="actions"><button class="btn soft" id="exportCsvBtn" type="button">ØªØµØ¯ÙŠØ±</button></div></div></div></div></div></div>
<div class="modal" id="pasteModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚</h2><button class="btn" id="closePaste" type="button">âœ•</button></div><div class="modalBody"><textarea id="pasteArea" rows="10" style="width:100%;background:rgba(0,0,0,.22);color:#fff;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.1)"></textarea></div><div class="modalFooter"><button class="btn primary" id="doPasteImport" type="button">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button></div></div></div>
<div class="modal" id="syncModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>â˜ï¸ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h2><button class="btn" id="closeSyncX" type="button">âœ•</button></div><div class="modalBody"><div class="syncGrid"><button class="syncBtn" id="syncBackupDownload" type="button">ğŸ’¾ Backup (ØªÙ†Ø²ÙŠÙ„)</button><button class="syncBtn" id="syncBackupShare" type="button">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Backup</button></div></div></div></div>

<script>
'use strict';

Chart.register(ChartDataLabels);

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

let authReady = false;
let currentUser = null;

function initAuth(){
  try{
    if(!window.firebase || !firebase.initializeApp) return false;
    if(!firebase.apps || firebase.apps.length === 0){
      firebase.initializeApp(FIREBASE_CONFIG);
    }
    const auth = firebase.auth();
    
    auth.onAuthStateChanged(async (u)=>{
      currentUser = u || null;
      updateAuthUI();
      
      if(currentUser){
        closeModal("authModal");
        await load();
        render();
      } else {
        data = [];
        render();
        openModal("authModal");
      }
    });
    
    authReady = true;
    updateAuthUI();
    return true;
  }catch(e){
    authReady = false;
    currentUser = null;
    showToast("ØªØ¹Ø°Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ø³Ø§Ø¨", String(e?.message || e), "err");
    return false;
  }
}

function updateAuthUI(){
  const t = document.getElementById("authStateText");
  const logoutBtn = document.getElementById("authLogout");
  if(!t || !logoutBtn) return;
  if(currentUser){
    t.textContent = `âœ… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„: ${currentUser.email || "â€”"}`;
    logoutBtn.disabled = false;
  }else{
    t.textContent = "ğŸ”’ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
    logoutBtn.disabled = true;
  }
}

const $ = (id)=>document.getElementById(id);
const FIREBASE_URL  = "https://dattta-6f497-default-rtdb.firebaseio.com";
const FIREBASE_PATH = "subscriptions";

async function requireIdToken(){
  if(!currentUser) throw new Error("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  return await currentUser.getIdToken(false);
}

const LOCAL_BACKUP_KEY = "subs_local_backup_v3";
let syncState = "idle"; 
let data = [];
let editingId = null;
let currentFilter = "all"; 
let myChartInstance = null; 

function setSyncState(state){
  syncState = state;
  const chip = document.getElementById("syncChip");
  if(chip){
    chip.classList.remove("ok","warn","err","syncing","offline");
    if(!navigator.onLine) chip.classList.add("offline");
    else if(state==="saving") chip.classList.add("syncing");
    else if(state==="ok") chip.classList.add("ok");
    else if(state==="fail") chip.classList.add("err");
  }
}

async function fetchWithTimeout(url, options={}, timeoutMs=25000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    return await fetch(url, { ...options, signal: controller.signal, cache: "no-store" });
  } finally { clearTimeout(t); }
}

function saveLocalBackup(){ localStorage.setItem(LOCAL_BACKUP_KEY, JSON.stringify(data)); }
function loadLocalBackup(){
  try{
    const j = JSON.parse(localStorage.getItem(LOCAL_BACKUP_KEY));
    return Array.isArray(j) ? j : [];
  }catch{ return []; }
}

async function firebasePull(){
  const token = await requireIdToken();
  const url = `${FIREBASE_URL}/${FIREBASE_PATH}.json?auth=${encodeURIComponent(token)}`;
  const res = await fetchWithTimeout(url);
  if(!res.ok) throw new Error("Pull failed");
  const json = await res.json();
  return Array.isArray(json) ? json : [];
}

// ==========================================
// ğŸ’¡ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„ÙƒØ´Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
// ==========================================
async function firebasePushOnce(){
  const token = await requireIdToken();
  const url = `${FIREBASE_URL}/${FIREBASE_PATH}.json?auth=${encodeURIComponent(token)}`;
  const res = await fetchWithTimeout(url, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  
  // Ø¥Ø°Ø§ Ø±ÙØ¶Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙØ¸ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
  if(!res.ok) {
     const errorText = await res.text().catch(()=>"");
     throw new Error(`(${res.status}) ${errorText}`);
  }
}

let syncTimer = null;
function scheduleSyncPush(delayMs=600){
  if(syncTimer) clearTimeout(syncTimer);
  syncTimer = setTimeout(async ()=>{
    saveLocalBackup();
    if(!navigator.onLine){ setSyncState("offline"); return; }
    try{
      setSyncState("saving");
      await firebasePushOnce();
      setSyncState("ok");
    }catch(e){
      setSyncState("fail");
      // Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: (401) Permission Denied)
      showToast("ØªØ¹Ø°Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©", e.message, "err");
    }
  }, delayMs);
}

async function load(){
  if(navigator.onLine){
    try{
      setSyncState("saving");
      data = await firebasePull();
      saveLocalBackup();
      setSyncState("ok");
    }catch(e){
      setSyncState("fail");
      data = loadLocalBackup();
    }
  }else{
    setSyncState("offline");
    data = loadLocalBackup();
  }
}
function save(){
  saveLocalBackup();
  scheduleSyncPush(0);
}

/* ===== Utils ===== */
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(iso){ const d=new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return d; }
function addMonths(dateISO, m){
  const d=toDate(dateISO); const day=d.getDate();
  d.setMonth(d.getMonth()+m);
  if(d.getDate() < day) d.setDate(0);
  return d.toISOString().slice(0,10);
}
function daysLeft(endISO){
  const now=toDate(todayISO()); const end=toDate(endISO);
  return Math.round((end-now)/(1000*60*60*24));
}
function status(endISO, alertDays){
  const left=daysLeft(endISO);
  if(left < 0) return {key:"expired", label:"Ù…Ù†ØªÙ‡ÙŠ", cls:"err", left};
  if(left <= alertDays) return {key:"expiring", label:"Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ", cls:"warn", left};
  return {key:"active", label:"ÙØ¹Ù‘Ø§Ù„", cls:"ok", left};
}
function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
function currencyLabel(code){ const map = {DZD:"Ø¯Ø¬", USD:"$", EUR:"â‚¬"}; return map[code] || code; }

/* ===== Modals ===== */
function openModal(id){ $(id).setAttribute("aria-hidden","false"); }
function closeModal(id){ $(id).setAttribute("aria-hidden","true"); }
function showToast(msg, sub="", kind="warn"){
  const t=$("toast"); t.className=`toast ${kind} show`;
  t.innerHTML=`<span class="ico">${kind==="err"?"âŒ":kind==="ok"?"âœ…":"âš ï¸"}</span><div><div class="msg">${msg}</div><div class="sub">${sub}</div></div>`;
  // ØªÙ… Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙƒÙŠ ØªØªÙ…ÙƒÙ† Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ù‡Ø¯ÙˆØ¡
  setTimeout(()=>t.classList.remove("show"), 4000); 
}

/* ===== Form Logic ===== */
function resetForm(){
  $("name").value=""; $("email").value=""; $("phone").value=""; 
  $("months").value=""; $("price").value=""; $("start").value=todayISO();
  editingId=null; $("formTitle").textContent="Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ";
}
function fillForm(rec){
  editingId = rec.id;
  $("formTitle").textContent="ØªØ¹Ø¯ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ";
  $("name").value = rec.name || "";
  $("email").value = rec.email || "";
  $("phone").value = rec.phone || "";
  $("months").value = rec.months || "";
  $("price").value = rec.price || "";
  $("start").value = rec.start || todayISO();
}

$("openAdd").onclick = ()=>{ resetForm(); openModal("formModal"); };
$("closeForm").onclick = ()=> closeModal("formModal");
$("cancelBtn").onclick = ()=> closeModal("formModal");
$("quickPlan").onchange = ()=>{ if($("quickPlan").value) $("months").value = $("quickPlan").value; };

$("saveBtn").onclick = ()=>{
  const name = $("name").value.trim();
  const email = $("email").value.trim().toLowerCase();
  const phone = $("phone").value.trim();
  const months = Number($("months").value);
  const price = Number($("price").value);
  const start = $("start").value;
  const currency = $("currency").value;

  if(!name || !email || !start || !months || months<1) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

  const end = addMonths(start, months);
  const rec = {
    id: editingId || (Date.now()+"_"+Math.random().toString(16).slice(2)),
    name, email, phone, months, price, currency, start, end
  };

  if(editingId){
    const idx = data.findIndex(r=>r.id===editingId);
    if(idx>=0) data[idx] = rec;
  } else {
    data.unshift(rec);
  }
  
  save(); render(); closeModal("formModal");
};

/* ===== Row Actions & WhatsApp ===== */
let currentRowId = null;
function openRowActions(id){
  currentRowId = id;
  const rec = data.find(x => x.id === id);
  if(!rec) return;
  $("rowActionsHint").textContent = `${rec.name} â€” ${rec.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}`;
  openModal("rowActionsModal");
}
$("closeRowActionsX").onclick = ()=> closeModal("rowActionsModal");
$("closeRowActions").onclick = ()=> closeModal("rowActionsModal");

$("actEdit").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  closeModal("rowActionsModal"); fillForm(rec); openModal("formModal");
};

$("actExtend").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  rec.end = addMonths(rec.end, Number(rec.months));
  save(); render(); closeModal("rowActionsModal");
};

$("actDelete").onclick = ()=>{
  if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ")) return;
  data = data.filter(x => x.id !== currentRowId);
  save(); render(); closeModal("rowActionsModal");
};

$("actWhatsApp").onclick = ()=>{
  const rec = data.find(x => x.id === currentRowId);
  if(!rec) return;
  if(!rec.phone){
    alert("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.");
    return;
  }
  let cleanPhone = rec.phone.replace(/[^0-9+]/g, '');
  let message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${rec.name}ØŒ\nÙ†ÙˆØ¯ ØªØ°ÙƒÙŠØ±Ùƒ Ø¨Ø£Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${rec.end}.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø®Ø¯Ù…Ø©.`;
  window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`, '_blank');
  closeModal("rowActionsModal");
};

/* ===== Filters Logic ===== */
document.querySelectorAll(".filterBtn").forEach(btn => {
  btn.onclick = (e) => {
    document.querySelectorAll(".filterBtn").forEach(b => b.classList.remove("active"));
    e.target.classList.add("active");
    currentFilter = e.target.getAttribute("data-filter");
    render();
  };
});

/* ===== Chart.js ===== */
function updateDashboardChart(active, expiring, expired) {
  const ctx = document.getElementById('statusChart');
  if(!ctx) return;
  
  if(myChartInstance) myChartInstance.destroy(); 
  
  const total = active + expiring + expired;
  const chartData = total > 0 ? [active, expiring, expired] : [1];
  const bgColors = total > 0 ? ['#22c55e', '#f59e0b', '#ef4444'] : ['rgba(255,255,255,0.1)'];
  const chartLabels = total > 0 ? ['ÙØ¹Ù‘Ø§Ù„', 'Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ', 'Ù…Ù†ØªÙ‡ÙŠ'] : ['Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'];

  myChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: chartLabels,
      datasets: [{ data: chartData, backgroundColor: bgColors, borderWidth: 0, hoverOffset: 4 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '60%',
      plugins: {
        legend: { position: 'right', labels: { color: '#eaf0ff', font: {family: 'system-ui', size: 13, weight: 'bold'} } },
        datalabels: {
          color: '#ffffff', font: { weight: 'bold', size: 13, family: 'system-ui' },
          formatter: (value, context) => {
            if (value === 0 || chartLabels[0] === 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª') return '';
            let sum = 0;
            context.chart.data.datasets[0].data.map(d => sum += d);
            let percentage = (value * 100 / sum).toFixed(0) + "%";
            return value + '\n(' + percentage + ')';
          },
          textAlign: 'center', textStrokeColor: 'rgba(0,0,0,0.6)', textStrokeWidth: 3
        }
      }
    }
  });
}

function updateRevenueSummary() {
  const groups = {};
  for(const r of data){
    const c = r.currency || "DZD";
    const p = Number(r.price ?? 0);
    if(p <= 0) continue;
    groups[c] = (groups[c]||0) + p;
  }
  const revDiv = $("revenueList");
  if(!revDiv) return;
  const keys = Object.keys(groups);
  if(keys.length === 0) { revDiv.innerHTML = `<div class="revValue">0.00</div>`; return; }
  revDiv.innerHTML = keys.map(k => `<div class="revValue">${groups[k].toFixed(2).replace(/\.00$/,"")} ${currencyLabel(k)}</div>`).join('');
}

/* ===== Render ===== */
$("search").addEventListener("input", render);

function render(){
  const q = ($("search").value||"").trim().toLowerCase();
  const tb = $("tbody");
  tb.innerHTML="";
  
  const alertDays = Number($("alertDays")?.value || 7);
  
  const allCounts={active:0, expiring:0, expired:0};
  for(const r of data) allCounts[status(r.end, alertDays).key]++;
  
  updateDashboardChart(allCounts.active, allCounts.expiring, allCounts.expired);
  updateRevenueSummary();

  const rows = data.filter(r=>{
    const matchSearch = !q || (r.name||"").toLowerCase().includes(q) || (r.email||"").toLowerCase().includes(q) || (r.phone||"").includes(q);
    if(!matchSearch) return false;

    const stKey = status(r.end, alertDays).key;
    if(currentFilter === "active" && stKey !== "active") return false;
    if(currentFilter === "expiring" && stKey !== "expiring") return false;
    if(currentFilter === "expired" && stKey !== "expired") return false;

    return true;
  });

  for(const r of rows){
    const st = status(r.end, alertDays);
    const tr = document.createElement("tr");
    if(st.key==="expired") tr.classList.add("expired-row");
    if(st.key==="expiring") tr.classList.add("expiring-row");

    tr.innerHTML = `
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.email)}</td>
      <td style="font-family:monospace; color:var(--muted)">${escapeHtml(r.phone || 'â€”')}</td>
      <td>${r.months} Ø´Ù‡Ø±</td>
      <td>${r.price || 0} ${r.currency}</td>
      <td>${r.start}</td>
      <td>${r.end}</td>
      <td>${st.left < 0 ? `Ù…Ù†Ø° ${Math.abs(st.left)} ÙŠÙˆÙ…` : `${st.left} ÙŠÙˆÙ…`}</td>
      <td><span class="badge ${st.cls}">${st.label}</span></td>
      <td><button class="actionPill" data-act="actions" data-id="${r.id}" type="button">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</button></td>
    `;
    tb.appendChild(tr);
  }

  if(rows.length === 0){
    tb.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</td></tr>`;
  }
}

$("tbody").addEventListener("click",(e)=>{
  const btn = e.target.closest("button[data-act='actions']");
  if(btn) openRowActions(btn.getAttribute("data-id"));
});

/* ===== Modals Openers ===== */
$("openBackup").onclick = ()=> openModal("backupModal");
$("closeBackup").onclick = ()=> closeModal("backupModal");
$("openSync").onclick = ()=> openModal("syncModal");
$("closeSyncX").onclick = ()=> closeModal("syncModal");
$("openAuth").onclick = ()=> openModal("authModal");

/* init */
(async ()=>{
  try{ initAuth(); }catch{}
})();
</script>

<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" style="width:400px;">
    <div class="modalHeader">
      <div><h2>ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨</h2><div class="hint">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div></div>
      <button class="btn" id="closeAuth" type="button" style="display:none;">âœ•</button>
    </div>
    <div style="padding:14px 16px">
      <div class="field" style="margin-bottom:10px"><label>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="authEmail" type="email"></div>
      <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="authPass" type="password"></div>
      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
        <button class="btn primary" id="authLogin" type="button">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn danger" id="authLogout" type="button" style="margin-inline-start:auto">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
      <div id="authStateText" style="margin-top:10px; font-size:13px; color:var(--muted)">â€”</div>
    </div>
  </div>
</div>
<script>
$("authLogin").onclick = async ()=>{
  const e=$("authEmail").value.trim(), p=$("authPass").value;
  if(!e||!p) return showToast("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  try{ await firebase.auth().signInWithEmailAndPassword(e, p); showToast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„","","ok"); }
  catch(err){ showToast("ÙØ´Ù„", err.message, "err"); }
};
$("authLogout").onclick = async ()=>{ await firebase.auth().signOut(); };
</script>

<div id="toast" class="toast"></div>

</body>
</html>
