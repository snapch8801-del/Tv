<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช - v12.9.29</title>

<meta name="theme-color" content="#070a12" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="ุงูุงุดุชุฑุงูุงุช" />

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) { registration.unregister(); }
    });
    caches.keys().then(function(names) {
        for (let name of names) caches.delete(name);
    });
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
const _urlParams = new URLSearchParams(window.location.search);
const _portalData = _urlParams.get('p');

if (_portalData) {
    window.onload = () => {
        try {
            const jsonStr = decodeURIComponent(atob(_portalData));
            const d = JSON.parse(jsonStr);
            
            document.body.innerHTML = `
            <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: radial-gradient(circle at 50% -20%, #7c5cff30, transparent 60%), #070a12; font-family: system-ui, -apple-system, sans-serif; direction: rtl;">
                <div style="width: 100%; max-width: 400px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; padding: 35px 25px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); backdrop-filter: blur(20px);">
                    <div style="font-size: 50px; margin-bottom: 10px; filter: drop-shadow(0 10px 15px rgba(124,92,255,0.3));">๐ค</div>
                    <h2 style="color: #eaf0ff; margin: 0 0 5px 0; font-size: 22px; font-weight: 900;">${d.sn}</h2>
                    <div style="color: rgba(234,240,255,0.5); font-size: 13px; margin-bottom: 30px; letter-spacing: 1px;">ุจูุงุจุฉ ุงููุดุชุฑู ุงูุฑูููุฉ</div>

                    <h1 style="color: white; font-size: 28px; margin: 0 0 10px 0; font-weight: 900;">${d.n}</h1>
                    <div style="display: inline-block; background: rgba(124,92,255,0.15); color: #c4b5fd; padding: 6px 16px; border-radius: 99px; font-weight: bold; font-size: 14px; border: 1px solid rgba(124,92,255,0.3); margin-bottom: 30px;">${d.srv}</div>

                    <div style="background: rgba(0,0,0,0.3); border-radius: 18px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.03); text-align: right;">
                        <div style="color: rgba(234,240,255,0.5); font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;"><span>๐</span> ุชูุงุตูู ุงูุงุดุชุฑุงู:</div>
                        ${d.ty === 'sessions'
                            ? `<div style="font-size: 16px; color: white; font-weight: bold;">ูุชุจูู <span style="color: #10b981; font-size: 26px; font-weight: 900; margin: 0 4px;">${d.sl}</span> ูู ${d.st} ุญุตุฉ</div>`
                            : `<div style="font-size: 15px; color: white; font-weight: bold; line-height: 1.8;">ุงูุจุฏุงูุฉ: <span style="color:#eaf0ff;">${d.sd}</span><br>ุงูุงูุชูุงุก: <span style="color:#ef4444; font-size:18px;">${d.ed}</span></div>`
                        }
                    </div>

                    <div style="background: ${d.db > 0 ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)'}; border-radius: 18px; padding: 20px; border: 1px solid ${d.db > 0 ? 'rgba(239,68,68,0.2)' : 'rgba(16,185,129,0.2)'}; text-align: right;">
                        <div style="color: ${d.db > 0 ? '#fca5a5' : '#6ee7b7'}; font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;"><span>๐ณ</span> ุงููุถุนูุฉ ุงููุงููุฉ:</div>
                        <div style="font-size: 18px; color: ${d.db > 0 ? '#ef4444' : '#10b981'}; font-weight: bold;">
                            ${d.db > 0 ? `ูุชุจูู ููุฏูุน: <span style="font-size: 24px; font-weight: 900;">${d.db}</span> ${d.cr}` : 'ุฎุงูุต ุจุงููุงูู ๐ข'}
                        </div>
                    </div>
                </div>
            </div>
            `;
        } catch(e) {
            document.body.innerHTML = `<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #070a12;"><div style="text-align:center; padding:50px; color:#ef4444; background: rgba(239,68,68,0.1); border-radius:20px; border: 1px solid rgba(239,68,68,0.3);">โ<br><br>ุนุฐุฑุงูุ ุงูุฑุงุจุท ุชุงูู ุฃู ุบูุฑ ุตุงูุญ.</div></div>`;
        }
    };
}
</script>

<style>
/* CSS ุงูุดุงูู ูููุญุฉ ูุงูุฌุฏูู ุงูููุงุณููู */
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, sans-serif; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px; -webkit-user-select: none; user-select: none; overflow-x: hidden;
}
input, textarea, table, select { -webkit-user-select: auto; user-select: auto; }
.container{max-width:1200px;margin:0 auto}
.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px; display: flex; align-items: center; gap: 8px;}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}
.version-badge { background: linear-gradient(135deg, var(--accent), #5a3bc2); color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 12px;}
.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }
.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; flex-direction:column; gap:12px; }
.topbar-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; width: 100%; justify-content: flex-start; }
.searchWrap{ display: flex; gap: 6px; align-items: center; width: 100%; }
.searchWrap input { flex:1; width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; transition: all 0.2s; font-size: 14px;}
.searchWrap input:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }
.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; transition: all .15s ease; font-size:13px; white-space: nowrap; }
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.45); background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12)); color: #ff8a8a; }
.btn.soft{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
.btn-close { padding: 8px 14px; font-size: 13px; border-radius: 12px; }
.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 10px 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); background: rgba(0,0,0,0.1); }
.filterBtn{ padding: 6px 12px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 12px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }
.bulkBar{ display: none; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(124,92,255,.15); border-bottom: 1px solid rgba(124,92,255,.3); flex-wrap: wrap; }
.bulkBar .selCount{ font-weight: 900; color: #fff; background: var(--accent); padding: 4px 10px; border-radius: 99px; font-size: 12px; }
.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color: var(--text); margin-inline-start: auto; }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }
input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid var(--muted); border-radius: 4px; background: rgba(0,0,0,.2); cursor: pointer; position: relative; display: inline-block; vertical-align: middle; }
input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
input[type="checkbox"]:checked::after { content: "โ"; position: absolute; color: white; font-size: 12px; left: 3px; top: -1px; font-weight: bold; }

/* ุงูุฌุฏูู ุงูููุงุณููู ุงูููู ุฌุฏุงู (ูุง ูููุงุฑ) */
.tableWrap { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; }
table { width: 100%; border-collapse: collapse; min-width: 900px; text-align: right; }
thead th { position: sticky; top: 0; z-index: 5; background: rgba(0,0,0,0.4); color: var(--muted); padding: 14px 12px; border-bottom: 1px solid var(--line); font-size: 12px; font-weight: 900; white-space: nowrap; }
tbody tr { transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
tbody tr:hover { background: rgba(255,255,255,0.03); }
tbody td { padding: 12px; vertical-align: middle; white-space: nowrap; }
tr.expired-row{ background: rgba(239,68,68,.08); }
tr.expiring-row{ background: rgba(245,158,11,.06); }

.badge{ display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:11px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; background: rgba(34,197,94,.1); }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; background: rgba(245,158,11,.1); }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; background: rgba(239,68,68,.1); }
.service-badge { background: rgba(124,92,255,0.15); color: #a78bfa; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; border: 1px solid rgba(124,92,255,0.3); display: inline-block; }
.tag-pill { background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 6px; font-size: 10px; margin-inline-end: 4px; display: inline-block; margin-top: 4px;}

/* ุงูููุงูุฐ ุงูููุจุซูุฉ (Modals) */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.75); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(500px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: 0 30px 90px rgba(0,0,0,.65); max-height: 90vh; overflow-y: auto; }
.modalHeader{ padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; position: sticky; top: 0; background: rgba(10,14,26,.96); z-index: 10; }
.modalHeader h2{margin:0;font-size:18px}
.modalBody{ padding: 20px; }
.modalFooter{ padding:16px 20px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; position: sticky; bottom: 0; background: rgba(10,14,26,.96); z-index: 10; }
.formGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
.full-width { grid-column: 1 / -1 !important; }
@media (max-width: 768px){ .formGrid{ grid-template-columns: 1fr; } }
.field label{ display:block; font-weight:900; font-size:13px; color: var(--muted); margin-bottom:8px; }
.field input, .field select, .field textarea { background: rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.15); width:100%; padding:12px 14px; border-radius:14px; color: var(--text); outline:none; font-size: 14px; font-family:inherit; resize:vertical; }
.field input:focus, .field select:focus, .field textarea:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); background:rgba(0,0,0,0.5); }
.actBtn{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); padding: 14px; border-radius: 18px; font-weight: 900; cursor:pointer; text-align: right; width: 100%; }
.actionPill { padding: 8px 16px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #5a3bc2); color: white; font-weight: 900; border: none; cursor: pointer; font-size: 13px; transition: all 0.2s; }
.actionPill:active { transform: scale(0.95); }
.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 14px; border-radius: 16px; background: rgba(10,14,26,.92); border: 1px solid rgba(255,255,255,.12); display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s ease; z-index: 10000; font-weight:bold; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;}
.auth-wrap { text-align: center; padding: 10px 15px; }
.auth-icon-wrap { display:inline-flex; align-items:center; justify-content:center; width:75px; height:75px; background:linear-gradient(135deg, rgba(124,92,255,0.2), rgba(124,92,255,0.05)); border:1px solid rgba(124,92,255,0.3); border-radius:50%; font-size:32px; margin-bottom:15px;}
.auth-input { width:100%; padding:15px 18px; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); border-radius:16px; color:#fff; font-size:15px; outline:none; text-align: left; direction: ltr; }
.pagination { display: flex; justify-content: center; align-items: center; gap: 12px; padding: 16px; border-top: 1px solid var(--line); background: rgba(0,0,0,0.1); }
.page-btn { padding: 8px 16px; border-radius: 12px; border: 1px solid var(--line); background: rgba(255,255,255,.05); color: var(--text); cursor: pointer; font-weight: bold; }
.page-info { font-size: 13px; color: var(--muted); font-weight: bold; background: rgba(0,0,0,0.2); padding: 8px 14px; border-radius: 10px; }
.id-card-wrap { border: 2px solid #e2e8f0; border-radius: 16px; padding: 25px; background: linear-gradient(135deg, #ffffff, #f1f5f9); position: relative; overflow: hidden; color: #0f172a; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
.id-card-wrap::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--accent), #4ade80); }
.side-menu { position: fixed; top: 0; right: -320px; width: 300px; height: 100vh; background: rgba(10,14,26,.98); border-left: 1px solid rgba(255,255,255,.1); box-shadow: -10px 0 50px rgba(0,0,0,0.8); z-index: 10001; transition: right 0.3s; display: flex; flex-direction: column; padding: 20px; backdrop-filter: blur(15px); }
.side-menu.open { right: 0; }
.menu-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.menu-backdrop.open { opacity: 1; pointer-events: auto; }
.flex-row-receipt { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #cbd5e1; flex-wrap: wrap; gap: 5px;}
.flex-row-receipt span.label { color: #64748b; }
.flex-row-receipt strong.val, .flex-row-receipt span.val { color: #0f172a; text-align: left; }
@media print { body > *:not(#receiptModal):not(#idCardModal) { display: none !important; } body { background: white !important; padding: 0 !important; margin: 0 !important; } .modal.print-active { display: block !important; position: static !important; background: white !important; } .modal.print-active .box { width: 100% !important; max-width: none !important; box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; } .no-print { display: none !important; } }
</style>
</head>

<body>
<div class="container" id="adminAppContainer" style="display: none;">
  <div class="header">
    <h1>๐งพ ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช <span class="version-badge">v12.9.29 Max</span></h1>
    <div class="sub">โก ุงููุณุฎุฉ ุงููุงููุฉ ุงูุดุงููุฉ ุจูู ุงูููุฒุงุช ูุงูุฌุฏูู ุงูููุงุณููู.</div>
  </div>

  <div class="card">
    <div class="topbar">
      <div class="topbar-actions">
        <button type="button" class="btn soft" onclick="openSideMenu()" title="ุงูุฅุนุฏุงุฏุงุช ูุงูุฃุฏูุงุช" style="padding: 10px 14px; font-size: 18px; border-color: rgba(255,255,255,0.2);">โฐ</button>
        <button type="button" class="btn primary" onclick="openAddSub()">โ ุฅุถุงูุฉ ุนููู</button>
        <button type="button" class="btn primary" onclick="openScannerModal()" style="background: linear-gradient(135deg, #10b981, #059669); border-color: #059669;">๐ท ูุณุญ ุจุทุงูุฉ</button>
        <button type="button" class="btn soft" onclick="openModal('packagesModal')" style="border-color:#a855f7; color:#c084fc; background: rgba(168,85,247,0.15);">๐ฆ ุงูุจุงูุงุช</button>
        <button type="button" class="btn soft" onclick="openTotalsReport()">๐ฐ ุงูุฅุญุตุงุฆูุงุช</button>
        <div class="statChip sync" id="syncChip"><span class="ico">โ๏ธ</span> <span class="v" id="syncVal">โ</span></div>
      </div>
      <div class="searchWrap">
        <input id="search" oninput="window.debounceSearch()" placeholder="ุจุญุซ ุจุงูุงุณูุ ุงูุฅููููุ ุงููุณุงูุ ุงููุงุชู..." />
        <button type="button" class="btn soft" title="ูุตู ุงูุจุญุซ" style="padding: 10px 12px; border-radius: 12px; font-size: 15px;" onclick="window.pasteSearch()">๐</button>
        <button type="button" class="btn soft" title="ูุณุญ ุงูุจุญุซ" style="padding: 10px 12px; border-radius: 12px; color: var(--err);" onclick="window.clearSearch()">โ</button>
      </div>
    </div>

    <div class="bulkBar" id="bulkBar">
      <div class="selCount" id="selCount">0 ูุญุฏุฏ</div>
      <button type="button" class="btn" style="border-color:#10b981; color:#10b981; background: rgba(16,185,129,0.1);" onclick="openBulkWhatsAppModal()">๐ฌ ุฑุณุงุฆู ุฌูุงุนูุฉ</button>
      <button type="button" class="btn" style="border-color:var(--accent); color:var(--accent);" onclick="bulkExtendAction()">๐ ุชุฌุฏูุฏ</button>
      <button type="button" class="btn danger" onclick="bulkDeleteAction()">๐๏ธ ุญุฐู</button>
      <button type="button" class="btn soft" style="margin-inline-start:auto;" onclick="clearSelectionAction()">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button type="button" class="filterBtn active" data-filter="all" onclick="setFilter(this, 'all')">ุงููู</button>
      <button type="button" class="filterBtn" data-filter="active" onclick="setFilter(this, 'active')">โ ูุนูุงู (ุฒููู/ุญุตุต)</button>
      <button type="button" class="filterBtn" data-filter="expiring" onclick="setFilter(this, 'expiring')">โฐ ูุฑูุจ ููุชูู</button>
      <button type="button" class="filterBtn" data-filter="expired" onclick="setFilter(this, 'expired')">โ ููุชูู ุงูุฑุตูุฏ/ุงููุฏุฉ</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
            <th>ุงูุนููู ูุงูุฃูุณูุฉ</th> <th>ุงููุงุชู</th> <th>ุงูุงุดุชุฑุงู</th> <th>ุงููุงููุฉ</th> <th>ุงูุชูุงุฑูุฎ / ุงูุฑุตูุฏ</th> <th>ุงูุญุงูุฉ</th> <th>ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="paginationControls" class="pagination"></div>
  </div>
</div>

<div class="menu-backdrop" id="menuBackdrop" onclick="closeSideMenu()"></div>
<div class="side-menu" id="sideMenu">
  <div class="side-menu-header">
    <h2>โ๏ธ ุฃุฏูุงุช ูุฅุนุฏุงุฏุงุช</h2>
    <button type="button" class="btn danger btn-close" onclick="closeSideMenu()">โ</button>
  </div>
  <div style="flex:1; overflow-y:auto; padding-right: 5px;">
    <div class="menu-section-title">ุฅุตูุงุญ ูุญู ุงููุดุงูู</div>
    <button type="button" class="actBtn" style="color:#60a5fa; border-color:rgba(96,165,250,0.4); background:rgba(96,165,250,0.1);" onclick="window.location.reload(true)">๐ ุชูุฑูุบ ุงูุฐุงูุฑุฉ ูุชุญุฏูุซ ุงูุตูุญุฉ</button>
    <div class="menu-section-title">ุฅุฏุงุฑุฉ ุงููุธุงู</div>
    <button type="button" class="actBtn" onclick="closeSideMenu(); openModal('authModal')" style="border-color:var(--accent); color:var(--accent); background: rgba(124,92,255,0.1);">๐ค ุฅุฏุงุฑุฉ ุงูุญุณุงุจุงุช ูุงูุตูุงุญูุงุช</button>
    <div class="menu-section-title">ุงูุจูุงูุงุช ูุงูุญูุงูุฉ</div>
    <button type="button" class="actBtn" style="color:#10b981; border-color:rgba(16,185,129,0.4); background:rgba(16,185,129,0.1);" onclick="closeSideMenu(); window.exportCSV()">๐ฅ ุชุญููู ูููู Excel</button>
    <button type="button" class="actBtn" onclick="closeSideMenu(); openModal('backupModal')">๐ฆ ุญูุธ ูุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช</button>
    <button type="button" class="actBtn" onclick="closeSideMenu(); openModal('syncModal')">โ๏ธ ุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ</button>
    <div class="menu-section-title">ุฃุฏูุงุช ุฅุถุงููุฉ</div>
    <button type="button" class="actBtn" style="color:#f59e0b; border-color:rgba(245,158,11,0.4); background:rgba(245,158,11,0.1);" onclick="closeSideMenu(); window.undoDelete()">โฉ๏ธ ุงูุชุฑุงุฌุน ุนู ุขุฎุฑ ุญุฐู</button>
    <button type="button" class="actBtn" onclick="closeSideMenu(); window.shareApp()">๐ค ูุดุงุฑูุฉ ุฑุงุจุท ุงูููุญุฉ</button>
    <button type="button" class="actBtn" onclick="closeSideMenu(); window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงูุฌุฏูู</button>
    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(239,68,68,0.2);">
      <button type="button" class="actBtn danger" onclick="closeSideMenu(); window.clearAllData()" style="text-align: center;">โ๏ธ ุชุตููุฑ ุงูููุญุฉ ุจุงููุงูู</button>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" style="width:min(600px, 100%)">
    <div class="modalHeader"><div><h2 id="formTitle">ุฅุถุงูุฉ ุงุดุชุฑุงู</h2></div><button type="button" class="btn danger btn-close" onclick="closeModal('formModal')">โ ุฅุบูุงู</button></div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full-width" style="background:rgba(124,92,255,0.08); padding:12px 14px; border-radius:14px; border:1px dashed rgba(124,92,255,0.3); margin-bottom:5px;">
          <label style="color:#c4b5fd; margin-bottom:8px;">๐ฆ ุงุฎุชุตุงุฑ: ุงุฎุชุฑ ุจุงูุฉ ุฌุงูุฒุฉ</label>
          <div style="display:flex; gap:8px;">
            <select id="packageSelector" onchange="window.applyPackage()" style="background:rgba(0,0,0,0.5); border-color:rgba(124,92,255,0.4); cursor:pointer; flex:1;">
              <option value="">โ๏ธ ูุง ุฃุฑูุฏ ุจุงูุฉุ ุณุฃูุชุจ ุงูุจูุงูุงุช ุจููุณู</option>
            </select>
            <button type="button" class="btn primary" style="padding:0 16px; border-radius:12px; font-size:16px;" onclick="openModal('packagesModal')">โ</button>
          </div>
        </div>
        <div class="field full-width"><label>ุงูุงุณู <span style="color:var(--err)">*</span></label><input id="name" placeholder="ูุซุงู: ุฃุญูุฏ ูุญูุฏ"></div>
        <div class="field full-width"><label>ุงููุงุชู (ูุน ุงูุฑูุฒ)</label><div style="display: flex; gap: 8px;"><select id="countryCode" style="width: 110px; direction: ltr;"><option value="+213">๐ฉ๐ฟ +213</option><option value="">ุจุฏูู ุฑูุฒ</option></select><input id="phone" type="tel" dir="ltr" placeholder="555000000" style="flex:1;"></div></div>
        <div class="field full-width" style="margin-top: 5px;"><label>ุงูุฎุฏูุฉ / ุงูุจุฑูุงูุฌ <span style="color:var(--err)">*</span></label><input id="serviceType" list="serviceList"><datalist id="serviceList"><option value="ุฏุฑูุณ ุฏุนู"><option value="ูุงุฏู ุฑูุงุถู"></datalist></div>
        <div class="field full-width" style="margin-top: 5px; padding-top: 10px; border-top: 1px dashed rgba(255,255,255,0.1);"><label>ุทุจูุนุฉ ุงูุงุดุชุฑุงู</label><select id="subType" onchange="window.toggleSubType()" style="background:rgba(0,0,0,0.5); border:1px solid #10b981; color:#10b981; font-weight:bold;"><option value="time">โณ ุงุดุชุฑุงู ุฒููู</option><option value="sessions">๐๏ธ ุงุดุชุฑุงู ุจุงูุญุตุต</option></select></div>
        <div id="timeFieldsGrp" style="display:contents;"><div class="field full-width" style="display: flex; gap:10px; background: rgba(16,185,129,0.05); padding: 12px; border-radius: 12px;"><div style="flex:1;"><label>ุงููุฏุฉ (ุฃุดูุฑ)</label><input id="months" type="number" min="1" step="1"></div><div style="flex:1;"><label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label><input id="start" type="date"></div><div style="flex:1;"><label>ุงุฎุชูุงุฑ ุณุฑูุน</label><select id="quickPlan" onchange="window.handleQuickPlan()"><option value="">โ ุงุฎุชุฑ โ</option><option value="1">1 ุดูุฑ</option><option value="3">3 ุฃุดูุฑ</option></select></div></div></div>
        <div id="sessionsFieldsGrp" style="display:none;"><div class="field full-width" style="display: flex; gap:10px; background: rgba(16,185,129,0.05); padding: 12px; border-radius: 12px;"><div style="flex:1;"><label>ุฅุฌูุงูู ุงูุญุตุต</label><input id="sessionsTotal" type="number" min="1" step="1"></div><div style="flex:1;"><label>ุงููุชุจูู (ููุชุนุฏูู)</label><input id="sessionsLeft" type="number" min="0" step="1" style="color:var(--warn); font-weight:bold;"></div></div></div>
        <div class="field full-width" style="display:flex; gap:10px; margin-top:5px;"><div style="flex:1;"><label>ุงูุณุนุฑ ุงูุฅุฌูุงูู</label><input id="price" type="number" min="0" step="0.01" oninput="window.calcDebt()"></div><div style="flex:1;"><label>ุงููุฏููุน</label><input id="paidAmount" type="number" min="0" step="0.01" oninput="window.calcDebt()"></div></div>
        <div class="field full-width"><label>ุงูุฏูู ุงููุชุจูู</label><input id="debtAmount" type="text" readonly style="background: rgba(239,68,68,0.1); color: #ff8a8a; font-weight: bold; border-color: rgba(239,68,68,0.3); pointer-events: none;"></div>
        <div class="full-width" style="margin-top: 10px;"><button type="button" id="btnToggleAdvanced" class="btn soft" style="width: 100%; border-style: dashed; padding: 12px;" onclick="window.toggleAdvancedFields()">๐ฝ ุงูุฎูุงุฑุงุช ุงูุฅุถุงููุฉ</button></div>
        <div id="advancedFields" class="full-width" style="display: none; background: rgba(0,0,0,0.2); padding: 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.05); margin-top: 10px;"><div class="formGrid"><div class="field full-width"><label>๐ ุฑุงุจุท ุงููุญุงุฏุซุฉ</label><input id="messengerLink" type="url" dir="ltr"></div><div class="field full-width"><label>ุงูุฅูููู</label><input id="email"></div><div class="field full-width"><label>ุงูุฃูุณูุฉ</label><input id="tags"></div><div class="field"><label>ุชูุจูู ูุจู (ุฃูุงู)</label><input id="alertDays" type="number" value="7"></div><div class="field full-width"><label>ุงูุนููุฉ</label><select id="currency"><option value="DZD">DZD</option><option value="USD">USD</option></select></div><div class="field full-width"><label>ููุงุญุธุงุช ุฎุงุตุฉ</label><textarea id="notes" rows="2"></textarea></div></div></div>
      </div>
    </div>
    <div class="modalFooter"><button type="button" class="btn primary" style="width:100%; padding: 16px; font-size: 16px; font-weight:bold; border-radius:14px;" onclick="window.saveSubscription()">๐พ ุญูุธ ุจูุงูุงุช ุงููุดุชุฑู</button></div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" style="width: min(400px, 100%)">
    <div class="modalHeader"><div><h2 style="font-size: 16px;">โก ุฅุฌุฑุงุกุงุช ุงููุดุชุฑู</h2><div class="hint" id="rowActionsHint" style="color: var(--accent); font-weight: bold; font-size: 14px;">โ</div></div><button type="button" class="btn danger btn-close" onclick="closeModal('rowActionsModal')">โ</button></div>
    <div class="modalBody" style="padding: 20px;">
      <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
        <button type="button" class="btn primary" style="padding: 14px; font-size: 15px;" onclick="window.actExtendAction()">๐ ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู</button>
        <button type="button" class="btn" style="padding: 14px; font-size: 15px; color: #fff; background: linear-gradient(135deg, #3b82f6, #2563eb); border-color: #2563eb;" onclick="window.openMembershipCard()">๐ชช ุนุฑุถ ุจุทุงูุฉ ุงูุงูุฎุฑุงุท (QR)</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
        <button type="button" class="btn soft" style="color:#4ade80;" onclick="window.actWhatsAppAction()">๐ฌ ูุงุชุณุงุจ</button>
        <button type="button" class="btn soft" id="btnMessengerAction" style="color:#0ea5e9;" onclick="window.actMessengerAction()">๐ฌ ููุณูุฌุฑ</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <button type="button" class="btn soft" style="color:#f43f5e;" onclick="window.actSMSAction()">๐ฑ SMS</button>
        <button type="button" class="btn soft" style="color:#60a5fa;" onclick="window.openReceiptAction()">๐ ุฅุตุฏุงุฑ ูุงุชูุฑุฉ</button>
      </div>
      <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; padding-top: 15px; border-top: 1px dashed rgba(255,255,255,0.1);">
        <button type="button" class="btn soft" style="font-size:12px; padding:8px 14px;" onclick="window.actEditAction()">โ๏ธ ุชุนุฏูู</button>
        <button type="button" class="btn soft" id="btnViewNotes" style="font-size:12px; padding:8px 14px; color:#a855f7;" onclick="window.openNotesAction()">๐ ุงูููุงุญุธุงุช</button>
        <button type="button" class="btn soft" id="btnViewAttendance" style="font-size:12px; padding:8px 14px; color:#10b981;" onclick="window.openAttendanceLog()">๐ ุณุฌู ุงูุญุถูุฑ</button>
        <button type="button" class="btn soft" style="font-size:12px; padding:8px 14px; color:#fbbf24;" onclick="window.openPaymentModal()">๐ธ ุงูุฏูุนุงุช ูุงูุฏููู</button>
        <button type="button" class="btn soft" style="font-size:12px; padding:12px; color:#c084fc; width:100%; border-color:#c084fc;" onclick="window.openPortalLinkSafe()">๐ ุงุณุชุฎุฑุงุฌ ุฑุงุจุท ุจูุงุจุฉ ุงูุนููู</button>
      </div>
      <div style="padding-top: 15px; border-top: 1px solid rgba(239,68,68,0.2);">
        <button type="button" class="btn danger" style="width: 100%; padding: 12px;" onclick="window.actDeleteAction()">๐๏ธ ุญุฐู ุงููุดุชุฑู ููุงุฆูุงู</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="scannerModal" aria-hidden="true"><div class="box" style="width: min(400px, 100%)"><div class="modalHeader"><h2>๐ท ูุณุญ ุจุทุงูุฉ ุงูุงูุฎุฑุงุท</h2><button type="button" class="btn danger btn-close" onclick="closeScannerModal()">โ</button></div><div class="modalBody" style="text-align: center;"><div id="qr-reader" style="width:100%; border-radius: 12px; overflow: hidden; background: #fff;"></div><div id="qr-reader-results" style="margin-top: 15px; font-weight: bold; color: var(--warn);">ูุฌูู ุงููุงููุฑุง ูุญู ุงูู QR...</div></div></div></div>
<div class="modal" id="checkInModal" aria-hidden="true"><div class="box" style="width: min(400px, 100%); text-align:center;"><div class="modalHeader" style="justify-content:center;"><h2>๐ ููุทุฉ ุงูุฏุฎูู (Check-in)</h2></div><div class="modalBody" style="padding: 30px 20px;"><h3 id="chkInName" style="font-size:26px; margin:0 0 10px 0;">ุงูุงุณู</h3><div id="chkInService" style="color:var(--muted); font-size:15px; margin-bottom:20px;">ุงูุฎุฏูุฉ</div><div style="margin-bottom:25px;"><span id="chkInStatus" class="badge" style="font-size:14px; padding:8px 16px;">ุงูุญุงูุฉ</span></div><div id="chkInAlert" style="font-weight:bold; font-size:18px; margin-bottom:25px; padding:15px; border-radius:12px;"></div><button type="button" class="btn primary" id="btnChkInAction" style="width:100%; padding:16px; font-size:16px; margin-bottom:15px;"></button><div style="display:flex; gap:10px;"><button type="button" class="btn soft" style="flex:1;" onclick="closeModal('checkInModal'); window.openRowActions(currentRowId)">โ๏ธ ุฅุฏุงุฑุฉ</button><button type="button" class="btn danger" style="flex:1;" onclick="closeModal('checkInModal')">ุฅุบูุงู</button></div></div></div></div>
<div class="modal" id="paymentModal" aria-hidden="true"><div class="box" style="width: min(450px, 100%)"><div class="modalHeader"><h2>๐ธ ุฅุฏุงุฑุฉ ุงูุฏูุนุงุช</h2><button type="button" class="btn danger btn-close" onclick="closeModal('paymentModal')">โ</button></div><div class="modalBody"><div style="margin-bottom: 15px; font-weight: bold; font-size: 16px;" id="paymentClientName"></div><div style="display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; margin-bottom: 15px;"><div style="text-align: center;"><span style="font-size:11px; color:var(--muted); display:block;">ุงูุณุนุฑ ุงูุฅุฌูุงูู</span><strong id="payTotal" style="font-size:15px;"></strong></div><div style="text-align: center;"><span style="font-size:11px; color:var(--muted); display:block;">ุงููุฏููุน</span><strong id="payPaid" style="color:#10b981; font-size:15px;"></strong></div><div style="text-align: center;"><span style="font-size:11px; color:var(--muted); display:block;">ุงููุชุจูู (ุฏูู)</span><strong id="payDebt" style="color:#ef4444; font-size:15px;"></strong></div></div><div id="newPaymentWrap"><div class="field" style="display:flex; gap:10px; margin-bottom:15px;"><input id="newPaymentAmount" type="number" placeholder="ุฃุฏุฎู ูุจูุบ ุงูุฏูุนุฉ ุงูุฌุฏูุฏุฉ..." style="flex:1;"><button type="button" class="btn primary" onclick="window.confirmNewPayment()" style="background: #10b981;">โ ุชุณุฏูุฏ</button></div></div><div style="font-size:12px; color:var(--accent); margin-bottom:8px; font-weight:bold;">ุณุฌู ุงูุฏูุนุงุช:</div><div style="max-height: 200px; overflow: auto; background: rgba(0,0,0,0.3); border-radius: 12px;"><table style="width: 100%; font-size: 13px;"><tbody id="paymentTbody"></tbody></table></div></div></div></div>
<div class="modal" id="attendanceModal" aria-hidden="true"><div class="box" style="width: min(450px, 100%)"><div class="modalHeader"><h2>๐ ุณุฌู ุงูุญุถูุฑ</h2><button type="button" class="btn danger btn-close" onclick="closeModal('attendanceModal')">โ</button></div><div class="modalBody"><div style="margin-bottom: 15px; font-weight: bold; font-size: 18px;" id="attendanceClientName"></div><div style="max-height: 300px; overflow: auto; background: rgba(0,0,0,0.3); border-radius: 14px;"><table style="width: 100%; font-size: 13px;"><tbody id="attendanceTbody"></tbody></table></div></div></div></div>
<div class="modal" id="extendModal" aria-hidden="true"><div class="box" style="width: min(350px, 100%)"><div class="modalHeader"><h2 id="extendTitle">ุชุฌุฏูุฏ ุงูุงุดุชุฑุงู</h2><button type="button" class="btn danger btn-close" onclick="closeModal('extendModal')">โ</button></div><div class="modalBody"><div class="field" style="margin-bottom:15px"><label id="lblExtendValue">ุงููุฏุฉ ุงููุถุงูุฉ</label><input id="extendValue" type="number" min="1" value="1"></div><div class="field" style="margin-bottom:20px" id="grpExtendUnit"><label>ุงููุญุฏุฉ</label><select id="extendUnit"><option value="months">ุฃุดูุฑ</option><option value="days">ุฃูุงู</option></select></div><button type="button" class="btn primary" style="width:100%;" onclick="window.confirmExtend()">ุชุฃููุฏ ุงูุชุฌุฏูุฏ</button></div></div></div>
<div class="modal" id="bulkWhatsAppModal" aria-hidden="true"><div class="box" style="width: min(450px, 100%)"><div class="modalHeader"><h2>๐ฌ ุฑุณุงุฆู ูุงุชุณุงุจ ุงูุฌูุงุนูุฉ</h2><button type="button" class="btn danger btn-close" onclick="closeModal('bulkWhatsAppModal')">โ</button></div><div class="modalBody"><div style="margin-bottom:15px; background:rgba(34,197,94,0.1); padding:12px; border-radius:12px; color:#c8f7d9; font-size:13px;">ุงูุนุฏุฏ: <span id="bulkWaCount" style="font-weight:bold; font-size:16px;">0</span> ูุดุชุฑู</div><div class="field" style="margin-bottom:15px"><label>ูุต ุงูุฑุณุงูุฉ</label><textarea id="bulkWaMsg" rows="4">ูุฑุญุจุงู {name}ุ ููุฏ ุชุฐููุฑู ุจุงูุชูุงุก ุงุดุชุฑุงูู ูู {service}.</textarea></div><div style="text-align:center; padding:15px 0;"><div id="bulkWaCurrentTarget" style="font-weight:bold; margin-bottom:12px;">ุงูุนููู ุงูุชุงูู: -</div><button type="button" class="btn primary" id="btnSendNextWa" style="width:90%; background:#22c55e;" onclick="window.sendNextBulkWhatsApp()">ุฅุฑุณุงู ุงูุฑุณุงูุฉ ๐</button></div></div></div></div>

<div class="modal" id="receiptModal" aria-hidden="true"><div class="box" style="width: min(450px, 100%); background: #ffffff; color: #000000; border-radius: 12px;"><div class="modalHeader no-print" style="background:#f8fafc;"><h2 style="color:#0f172a;">๐ ุงููุตู ุงูุฑููู</h2><button type="button" class="btn btn-close" style="color:#ef4444;" onclick="closeModal('receiptModal')">โ</button></div><div class="modalBody" style="padding: 30px 25px; font-family: Tahoma;"><div style="text-align: center; margin-bottom: 25px;"><h1 id="receiptStoreName" style="margin: 0; font-size: 24px; color: #4f46e5;">ุงููุคุณุณุฉ</h1><div style="color: #64748b; font-size: 13px;">ูุงุชูุฑุฉ ุงุดุชุฑุงู</div></div><div style="font-size: 15px;"><div class="flex-row-receipt"><span class="label">ุงูุนููู:</span><strong class="val" id="recName"></strong></div><div class="flex-row-receipt"><span class="label">ุงููุงุชู:</span><span class="val" id="recPhone"></span></div><div class="flex-row-receipt"><span class="label">ุงูุฎุฏูุฉ:</span><strong class="val" id="recService"></strong></div><div id="recRowMonths" class="flex-row-receipt"><span class="label">ุงููุฏุฉ:</span><span class="val" id="recMonths"></span></div><div id="recRowSessions" class="flex-row-receipt"><span class="label">ุงูุญุตุต:</span><strong class="val" id="recSessions"></strong></div><div id="recRowStart" class="flex-row-receipt"><span class="label">ุงูุจุฏุงูุฉ:</span><span class="val" id="recStart"></span></div><div id="recRowEnd" class="flex-row-receipt"><span class="label">ุงูุงูุชูุงุก:</span><span class="val" id="recEnd"></span></div><div style="display:flex; justify-content:space-between; padding:20px 0 10px 0;"><span style="color:#0f172a; font-weight:900;">ุงูุฅุฌูุงูู:</span><strong style="color:#10b981; font-size:20px;" id="recPrice"></strong></div><div class="flex-row-receipt"><span class="label">ุงูุฏูุน:</span><strong class="val" id="recPaymentStatus"></strong></div><div id="recPaidAmountRow" class="flex-row-receipt"><span class="label">ุงููุฏููุน:</span><strong class="val" id="recPaidAmount"></strong></div><div id="recRemainingRow" style="display:flex; justify-content:space-between; padding:12px 5px; background:#fef2f2;"><span style="color:#ef4444; font-weight:bold;">ูุชุจูู (ุฏูู):</span><strong style="color:#ef4444;" id="recRemaining"></strong></div></div><div style="text-align:center; margin-top:35px; font-size:12px; color:#94a3b8;">ุชู ุงูุฅุตุฏุงุฑ ุจุชุงุฑูุฎ <span id="recToday"></span></div></div><div class="modalFooter no-print" style="background:#f8fafc;"><button type="button" class="btn primary" style="flex:1;" onclick="window.printReceiptAction()">๐จ๏ธ ุทุจุงุนุฉ</button></div></div></div>
<div class="modal" id="idCardModal" aria-hidden="true"><div class="box" style="width: min(420px, 100%); background: #ffffff; color: #000000; border-radius: 16px;"><div class="modalHeader no-print" style="background:#f8fafc;"><h2 style="color:#0f172a;">๐ชช ุงูุจุทุงูุฉ</h2><button type="button" class="btn btn-close" style="color:#ef4444;" onclick="closeModal('idCardModal')">โ</button></div><div class="modalBody" style="padding: 25px; display: flex; justify-content: center;"><div class="id-card-wrap" style="width: 100%; max-width: 350px;"><h2 id="idCardStoreName" style="color: #4f46e5;">ุงููุคุณุณุฉ</h2><div style="display: flex; justify-content: center; margin-bottom: 20px;"><div id="idCardQR" style="padding:10px; background:white; border-radius:12px;"></div></div><h3 id="idCardClientName" style="margin: 0 0 5px 0; font-size: 24px;">ุงูุงุณู</h3><div id="idCardService" style="font-weight: bold; color: #8b5cf6;">ุงูุฎุฏูุฉ</div></div></div><div class="modalFooter no-print" style="background:#f8fafc;"><button type="button" class="btn primary" style="width: 100%;" onclick="window.printIdCardAction()">๐จ๏ธ ุทุจุงุนุฉ ุงูุจุทุงูุฉ</button></div></div></div>
<div class="modal" id="viewNotesModal" aria-hidden="true"><div class="box" style="width: min(400px, 100%)"><div class="modalHeader"><h2>๐ ููุงุญุธุงุช ุงูุนููู</h2><button type="button" class="btn danger btn-close" onclick="closeModal('viewNotesModal')">โ</button></div><div class="modalBody"><div id="viewNotesContent" style="white-space:pre-wrap; background:rgba(0,0,0,0.3); padding:18px; border-radius:14px;"></div></div></div></div>

<div class="modal" id="authModal" aria-hidden="true"><div class="box" style="width: min(420px, 100%);"><div class="modalHeader"><h2 class="auth-title">ุชุณุฌูู ุงูุฏุฎูู</h2><button type="button" class="btn danger btn-close" id="closeAuthBtn" onclick="closeModal('authModal')" style="display:none;">โ</button></div><div class="modalBody"><div id="authLoginSection"><input id="authEmailAuth" type="email" class="auth-input" placeholder="ุงูุฅูููู" style="margin-bottom:20px;"><input id="authPass" type="password" class="auth-input" placeholder="ูููุฉ ุงููุฑูุฑ" style="margin-bottom:20px;"><button type="button" class="btn primary" style="width:100%; padding:16px;" onclick="window.loginUser()">ุฏุฎูู ๐</button></div><div id="authLoggedInSection" style="display:none; text-align:center;"><div id="authStateText" style="font-weight:bold; margin-bottom:20px;"></div><button type="button" class="btn danger" style="width:100%; padding:14px;" onclick="window.logoutUser()">ุชุณุฌูู ุงูุฎุฑูุฌ</button></div></div></div></div>
<div class="modal" id="totalsModal" aria-hidden="true"><div class="box" style="width:min(400px, 100%)"><div class="modalHeader"><h2>๐ฐ ุงููุฌููุน ุงูุนุงู</h2><button type="button" class="btn danger btn-close" onclick="closeModal('totalsModal')">โ</button></div><div class="modalBody"><div id="totalsBody" style="text-align:center; padding: 10px 0;"></div></div></div></div>
<div class="modal" id="packagesModal" aria-hidden="true"><div class="box" style="width: min(600px, 100%)"><div class="modalHeader"><h2>๐ฆ ุงูุจุงูุงุช</h2><button type="button" class="btn danger btn-close" onclick="closeModal('packagesModal')">โ</button></div><div class="modalBody"><div class="formGrid"><div class="field full-width"><label>ุงุณู ุงูุจุงูุฉ</label><input id="pkgName"></div><div class="field"><label>ุงูุณุนุฑ</label><input id="pkgPrice" type="number"></div><div class="field full-width"><button type="button" class="btn primary" onclick="window.savePackage()">โ ุญูุธ</button></div></div><div style="max-height: 250px; overflow: auto; margin-top:20px;"><table style="min-width: 100%;"><tbody id="packagesTbody"></tbody></table></div></div></div></div>
<div class="modal" id="storeSettingsModal" aria-hidden="true"><div class="box" style="width: min(400px, 100%)"><div class="modalHeader"><h2>โ๏ธ ุงููุชุฌุฑ</h2><button type="button" class="btn danger btn-close" onclick="closeModal('storeSettingsModal')">โ</button></div><div class="modalBody"><div class="field"><label>ุงุณู ุงููุคุณุณุฉ</label><input id="setStoreName"></div><button type="button" class="btn primary" style="width:100%; margin-top:20px;" onclick="window.saveStoreSettings()">ุญูุธ</button></div></div></div>
<div class="modal" id="backupModal" aria-hidden="true"><div class="box" style="width:min(400px, 100%)"><div class="modalHeader"><h2>๐ฆ ุงููุณุฎ ุงูุงุญุชูุงุทู</h2><button type="button" class="btn danger btn-close" onclick="closeModal('backupModal')">โ</button></div><div class="modalBody"><div style="display:grid; gap:10px;"><button type="button" class="btn soft" onclick="window.exportJson()">โฌ๏ธ ุชุตุฏูุฑ JSON</button></div></div></div></div>
<div class="modal" id="syncModal" aria-hidden="true"><div class="box"><div class="modalHeader"><h2>โ๏ธ ุงููุฒุงููุฉ</h2><button type="button" class="btn danger btn-close" onclick="closeModal('syncModal')">โ</button></div><div class="modalBody">ููุฒุฉ ุงููุฒุงููุฉ ุชุนูู ูู ุงูุฎูููุฉ ูุญุธูุงู ูุจุดูู ุชููุงุฆู โ</div></div></div>

<div id="toast" class="toast"></div>

<script>
// =================================================================
// ๐ก๏ธ ุฏุงูุฉ ุงุณุชุฎุฑุงุฌ ุฑุงุจุท ุงูุจูุงุจุฉ (ุนุจุฑ Prompt ูุชุฌูุจ ุชุดูุฌ Brave)
// =================================================================
window.openPortalLinkSafe = () => {
    const rec = data.find(x => x.id === currentRowId);
    if(!rec) return;

    let debt = (parseFloat(rec.price)||0) - (parseFloat(rec.paidAmount)||0);
    if(debt < 0) debt = 0;

    const payload = {
        n: rec.name || "ุนููู", srv: rec.serviceType || "ุบูุฑ ูุญุฏุฏ", ty: rec.subType || "time",
        sl: rec.sessionsLeft || 0, st: rec.sessionsTotal || 0, sd: rec.start || "-", ed: rec.end || "-",
        db: debt, cr: rec.currency || "DZD", sn: storeSettings.name || "ุงููุคุณุณุฉ"
    };

    try {
        const jsonStr = JSON.stringify(payload);
        const encodedStr = encodeURIComponent(jsonStr); 
        const base64 = window.btoa(encodedStr);
        const link = window.location.origin + window.location.pathname + "?p=" + base64;

        closeModal("rowActionsModal");
        // ุงุณุชุฎุฏุงู Prompt ูููุน ุงูุงูููุงุฑ ูุฃู ุงููุชุตูุญ ูุซู ุจู ุชูุงูุงู
        window.prompt("ุงูุฑุงุจุท ุฌุงูุฒ! ุงูุณุฎู ูู ุงููุฑุจุน ุฃุฏูุงู ูุฃุฑุณูู ููุนููู:", link);
    } catch(err) {
        showToast("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุดููุฑ", "err");
    }
};

// =================================================================
// ุงูุฃููุงุฏ ุงูุฃุณุงุณูุฉ ูููุญุฉ ูุงููุฒุงููุฉ
// =================================================================
window.addEventListener('DOMContentLoaded', () => {
    if(!_portalData) {
        document.getElementById('adminAppContainer').style.display = 'block';
        data = loadLocalBackup();
        window.render();
    }
});

let data = []; let packagesData = []; let editingId = null; let currentRowId = null; let currentFilter = "all"; 
let selectedIds = new Set(); let extendMode = "single"; let currentUser = null; let currentRole = null;
let lastDeletedData = null; let storeSettings = { name: "ุงููุคุณุณุฉ", logo: "" }; let editingPkgId = null;
window.currentPage = 1; window.itemsPerPage = 50; let bulkWaQueue = [];

const FIREBASE_CONFIG = { apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ", authDomain: "dattta-6f497.firebaseapp.com", databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com", projectId: "dattta-6f497", storageBucket: "dattta-6f497.firebasestorage.app", messagingSenderId: "804914291938", appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb" };
try { if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG); var auth = firebase.auth(); var db = firebase.database(); } catch(e) {}

window.openModal = (id) => { const el = document.getElementById(id); if(el) el.setAttribute("aria-hidden","false"); };
window.closeModal = (id) => { const el = document.getElementById(id); if(el) el.setAttribute("aria-hidden","true"); };
const $ = (id) => document.getElementById(id);
window.showToast = (m, type="ok") => { const t=$("toast"); t.textContent=m; t.style.borderColor = type==="err"?"#ef4444":"#22c55e"; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 3000); };
function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(iso){ if(!iso) return new Date(); const d = new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return isNaN(d) ? new Date() : d; }

function saveLocalBackup(){ localStorage.setItem("subs_backup_v12", JSON.stringify(data)); localStorage.setItem("pkgs_v12", JSON.stringify(packagesData)); }
function loadLocalBackup(){ 
    try { const j = JSON.parse(localStorage.getItem("subs_backup_v12")); data = Array.isArray(j) ? j : []; } catch { data = []; } 
    try { const p = JSON.parse(localStorage.getItem("pkgs_v12")); packagesData = Array.isArray(p) ? p : []; } catch { packagesData = []; }
    return data;
}

function setSyncState(state){ 
    const chip = $("syncChip"); const val = $("syncVal"); chip.className = "statChip sync " + state; 
    if(!navigator.onLine) val.textContent = "ุฃูููุงูู ๐ด"; else if(state==="saving") val.textContent = "ุฌุงุฑู ุงูุญูุธ..."; 
    else if(state==="ok") { const d = new Date(); val.textContent = d.getHours()+":"+String(d.getMinutes()).padStart(2,"0") + " โ"; } 
    else if(state==="fail") { val.textContent = "ุฎุทุฃ โ"; chip.style.borderColor="var(--err)"; chip.style.background="rgba(239,68,68,0.1)"; } 
}

async function logAction(actionName, detailsStr) { if (!currentUser || typeof db === 'undefined') return; try { await db.ref("logs").push({ email: currentUser.email, action: actionName, details: detailsStr || "-", time: new Date().toISOString() }); } catch(e) {} }

if(typeof auth !== 'undefined') {
    auth.onAuthStateChanged(async (u)=>{ 
        currentUser = u; 
        if(u){ $("closeAuthBtn").style.display = "block"; closeModal("authModal"); await window.loadData(); } 
        else { data = []; window.render(); $("closeAuthBtn").style.display = "none"; openModal("authModal"); } 
        window.updateAuthUI(); 
    });
}
window.updateAuthUI = () => { if(currentUser) { $("authLoginSection").style.display="none"; $("authLoggedInSection").style.display="block"; $("authStateText").textContent=`ุฃุฏูู: ${currentUser.email}`; } else { $("authLoginSection").style.display="block"; $("authLoggedInSection").style.display="none"; } };
window.loginUser = () => auth.signInWithEmailAndPassword($("authEmailAuth").value.trim(), $("authPass").value).catch(e => showToast("ุจูุงูุงุช ุฎุงุทุฆุฉ", "err"));
window.logoutUser = () => auth.signOut();

window.loadData = async () => { 
  if(!navigator.onLine) { data = loadLocalBackup(); window.render(); return; } 
  try { 
    setSyncState("saving"); 
    try { const setSnap = await db.ref("settings/storeInfo").once('value'); if(setSnap.exists()){ storeSettings = setSnap.val(); $("setStoreName").value=storeSettings.name||""; } } catch(e){} 
    const snap = await db.ref("subscriptions").once('value'); data = snap.exists() ? Object.values(snap.val()) : []; saveLocalBackup(); setSyncState("ok"); window.render(); 
  } catch(e) { setSyncState("fail"); data = loadLocalBackup(); window.render(); } 
};
async function firebasePush() { if(!navigator.onLine) return; try { setSyncState("saving"); await db.ref("subscriptions").set(data); saveLocalBackup(); setSyncState("ok"); } catch(e) { showToast("ุฎุทุฃ", "err"); } }

function getStatus(r, alertDays) {
  if (r.subType === 'sessions') {
    let left = parseInt(r.sessionsLeft) || 0;
    if (left <= 0) return { key: "expired", label: "ููุชูู ุงูุฑุตูุฏ", cls: "err", text: "0 ุญุตุฉ" };
    if (left <= 2) return { key: "expiring", label: "ูุงุฑุจ ุนูู ุงูุงูุชูุงุก", cls: "warn", text: `ุจูู ${left} ุญุตุต` };
    return { key: "active", label: "ุฑุตูุฏ ูุนูุงู", cls: "ok", text: `ุจูู ${left} ุญุตุต` };
  } else {
    if (!r.end) return { key:"expired", label:"ุบูุฑ ูุญุฏุฏ", cls:"err", text:`-` };
    const left = Math.round((toDate(r.end) - toDate(todayISO()))/(1000*60*60*24));
    if (isNaN(left)) return { key:"expired", label:"ุฎุทุฃ ุชุงุฑูุฎ", cls:"err", text:`-` };
    if(left < 0) return { key:"expired", label:"ููุชูู", cls:"err", text:`ููุฐ ${Math.abs(left)} ููู` };
    if(left <= alertDays) return { key:"expiring", label:"ูุฑูุจ ููุชูู", cls:"warn", text:`ุจูู ${left} ููู` };
    return { key:"active", label:"ูุนูุงู", cls:"ok", text:`ุจูู ${left} ููู` };
  }
}

window.toggleSubType = () => {
  if($("subType").value === 'sessions') { $("timeFieldsGrp").style.display = "none"; $("sessionsFieldsGrp").style.display = "contents"; } 
  else { $("timeFieldsGrp").style.display = "contents"; $("sessionsFieldsGrp").style.display = "none"; }
};

window.render = () => {
  try {
      const searchInput = $("search"); const q = searchInput ? (searchInput.value || "").trim().toLowerCase() : "";
      const tb = $("tbody"); if(!tb) return; tb.innerHTML = ""; if($("selectAll")) $("selectAll").checked = false;
      const alertD = parseInt($("alertDays")?.value || 7);
      
      let filteredRows = data.filter(r => { 
        if(!r || typeof r !== 'object') return false; // ุญูุงูุฉ ุถุฏ ุงูุจูุงูุงุช ุงูุชุงููุฉ
        const n = String(r.name||"").toLowerCase(); const p = String(r.phone||"").toLowerCase(); const srv = String(r.serviceType||"").toLowerCase(); 
        const match = !q || n.includes(q) || p.includes(q) || srv.includes(q); 
        const st = getStatus(r, alertD); 
        if(currentFilter !== "all" && currentFilter !== st.key) return false; return match; 
      });
      
      const totalPages = Math.ceil(filteredRows.length / window.itemsPerPage) || 1;
      if (window.currentPage > totalPages) window.currentPage = totalPages;
      if (window.currentPage < 1) window.currentPage = 1;
      
      const startIdx = (window.currentPage - 1) * window.itemsPerPage;
      const paginatedRows = filteredRows.slice(startIdx, startIdx + window.itemsPerPage);

      if(filteredRows.length === 0) { tb.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px; color:var(--muted);">ูุง ุชูุฌุฏ ุจูุงูุงุช ๐ญ</td></tr>`; return; }

      paginatedRows.forEach(r => {
        try {
            const st = getStatus(r, alertD); const isChecked = selectedIds.has(r.id) ? "checked" : ""; const tr = document.createElement("tr");
            if(st.key === "expired") tr.className = "expired-row"; else if(st.key === "expiring") tr.className = "expiring-row";
            
            let pStatus = r.paymentStatus || 'paid'; let payBadge = pStatus === 'unpaid' ? '<span class="badge err">๐ด ุบูุฑ ูุฏููุน</span>' : (pStatus === 'partial' ? `<span class="badge warn">๐ก ุฌุฒุฆู (${r.paidAmount||0})</span>` : '<span class="badge ok">๐ข ุฎุงูุต</span>');
            const hasNotes = String(r.notes||"").trim() !== ""; const notesIcon = hasNotes ? `<span title="ููุงุญุธุงุช" style="font-size:12px; margin-inline-start:6px;">๐</span>` : "";
            let tagsHtml = ""; String(r.tags||"").split(',').filter(t=>t.trim()!=="").forEach(t => { tagsHtml += `<span class="tag-pill">${t}</span>`; });
            const serviceHtml = `<span class="service-badge">${r.serviceType||"-"}</span>`;
            
            let dateOrSessionHtml = r.subType === 'sessions' ? `<div style="font-weight:bold; font-size:14px; color:var(--text);">${r.sessionsLeft||0} / ${r.sessionsTotal||0} ุญุตุฉ</div><button type="button" class="btn soft" style="padding:4px 8px; font-size:10px; margin-top:4px; color:#22c55e;" onclick="window.markAttendance('${r.id}')">โ๏ธ ุญุถูุฑ</button>` : `<span style="color:var(--text)">ู:</span> ${r.start||"-"}<br><span style="color:var(--text)">ุฅ:</span> ${r.end||"-"}<div style="margin-top:4px;"><button type="button" class="btn soft" style="padding:4px 8px; font-size:10px; color:#22c55e;" onclick="window.markAttendance('${r.id}')">โ๏ธ ุฏุฎูู</button></div>`;

            tr.innerHTML = `
              <td style="text-align: center;"><input type="checkbox" class="rowChk" value="${r.id}" ${isChecked}></td>
              <td><div style="font-weight:bold; font-size:14px;">${r.name||"-"}${notesIcon}</div><div>${tagsHtml}</div></td>
              <td dir="ltr" style="text-align:right; font-size:14px;">${r.phone?`${r.countryCode||''}${r.phone}`:'-'}</td>
              <td><div style="margin-bottom:4px;">${serviceHtml}</div><div style="font-size:11px; color:var(--muted); font-weight:bold;">${r.subType === 'sessions' ? 'ุญุตุต' : `ุงููุฏุฉ: ${r.months||0} ุดูุฑ`}</div></td>
              <td><div style="font-weight:bold; font-size:14px;">${r.price||0} <span style="font-size:10px; color:var(--muted);">${r.currency||'DZD'}</span></div><div style="margin-top:4px;">${payBadge}</div></td>
              <td style="font-size:12px; color:var(--muted); line-height:1.6;">${dateOrSessionHtml}</td>
              <td><div style="margin-bottom:4px;"><span class="badge ${st.cls}">${st.label}</span></div><div style="font-size:11px; font-weight:bold; color:${st.key === 'expired' ? 'var(--err)' : 'var(--text)'};">${st.text}</div></td>
              <td><button type="button" class="actionPill" onclick="window.openRowActions('${r.id}')">โก ุฅุฌุฑุงุก</button></td>
            `;
            tb.appendChild(tr);
        } catch(rowErr) { console.error(rowErr); }
      });
      $("paginationControls").innerHTML = `<button type="button" class="page-btn" onclick="window.changePage(1)" ${window.currentPage === totalPages ? 'disabled' : ''}>ุงูุชุงูู โ</button><span class="page-info">ุตูุญุฉ ${window.currentPage} ูู ${totalPages} | ุงููุฌููุน: ${filteredRows.length}</span><button type="button" class="page-btn" onclick="window.changePage(-1)" ${window.currentPage === 1 ? 'disabled' : ''}>โถ ุงูุณุงุจู</button>`;
  } catch(e) { console.error(e); }
};

window.openSideMenu = () => { $("sideMenu").classList.add("open"); $("menuBackdrop").classList.add("open"); };
window.closeSideMenu = () => { $("sideMenu").classList.remove("open"); $("menuBackdrop").classList.remove("open"); };

window.calcDebt = () => { const p = parseFloat($("price").value)||0; let a = parseFloat($("paidAmount").value)||0; $("debtAmount").value = (p-a)>0?(p-a):0; };
window.handleQuickPlan = () => { if($("quickPlan").value) $("months").value = $("quickPlan").value; };

window.openAddSub = () => { editingId=null; $("formTitle").textContent="ุฅุถุงูุฉ ุงุดุชุฑุงู"; $("name").value=""; $("email").value=""; $("phone").value=""; $("tags").value=""; $("messengerLink").value=""; $("serviceType").value=""; $("months").value=""; $("sessionsTotal").value=""; $("sessionsLeft").value=""; $("price").value=""; $("start").value=todayISO(); $("paidAmount").value=""; $("notes").value=""; $("subType").value="time"; window.toggleSubType(); window.calcDebt(); openModal("formModal"); };

window.actEditAction = () => { const rec=data.find(x=>x.id===currentRowId); if(!rec)return; closeModal("rowActionsModal"); editingId=rec.id; $("formTitle").textContent="ุชุนุฏูู ุงุดุชุฑุงู"; $("subType").value=rec.subType||"time"; window.toggleSubType(); $("name").value=rec.name||""; $("email").value=rec.email||""; $("phone").value=rec.phone||""; $("tags").value=rec.tags||""; $("serviceType").value=rec.serviceType||""; $("months").value=rec.months||""; $("sessionsTotal").value=rec.sessionsTotal||""; $("sessionsLeft").value=rec.sessionsLeft||""; $("price").value=rec.price||""; $("start").value=rec.start; $("notes").value=rec.notes||""; $("paidAmount").value=rec.paymentStatus==='unpaid'?0:(rec.paymentStatus==='partial'?rec.paidAmount:""); window.calcDebt(); openModal("formModal"); };

window.saveSubscription = async () => {
  const subType=$("subType").value; const nameVal=$("name").value.trim(); const serviceVal=$("serviceType").value.trim(); const priceFloat=parseFloat($("price").value)||0; const paidFloat=$("paidAmount").value===""?priceFloat:(parseFloat($("paidAmount").value)||0);
  if(!nameVal || !serviceVal) return showToast("ุฃุฏุฎู ุงูุงุณู ูุงูุฎุฏูุฉ", "err");
  const rec = { id: editingId||Date.now().toString(), subType, name: nameVal, email: $("email").value, messengerLink: $("messengerLink").value, tags: $("tags").value, phone: $("phone").value, countryCode: $("countryCode").value, serviceType: serviceVal, price: priceFloat, currency: $("currency").value||"DZD", paymentStatus: (paidFloat===0&&priceFloat>0)?'unpaid':(paidFloat<priceFloat?'partial':'paid'), paidAmount: paidFloat, notes: $("notes").value };
  if(subType === 'time') { rec.start=$("start").value; rec.months=parseInt($("months").value); let endD=new Date(rec.start); endD.setMonth(endD.getMonth()+rec.months); rec.end=endD.toISOString().split('T')[0]; } else { rec.sessionsTotal=parseInt($("sessionsTotal").value); rec.sessionsLeft=editingId?parseInt($("sessionsLeft").value):rec.sessionsTotal; }
  if(editingId) { const old = data.find(x=>x.id===editingId); if(old){ rec.attendanceLog=old.attendanceLog; rec.paymentLog=old.paymentLog; } } else if(paidFloat>0){ rec.paymentLog=[{time:new Date().toISOString(), amount:paidFloat}]; }
  if(editingId) data=data.map(x=>x.id===editingId?rec:x); else data.unshift(rec);
  await firebasePush(); window.render(); closeModal("formModal"); showToast("ุชู ุงูุญูุธ โจ");
};

window.openRowActions = (id) => { currentRowId=id; $("rowActionsHint").textContent=data.find(x=>x.id===id)?.name||""; openModal("rowActionsModal"); };
window.actDeleteAction = async () => { if(confirm("ุญุฐูุ")){ data=data.filter(x=>x.id!==currentRowId); await firebasePush(); window.render(); closeModal("rowActionsModal"); showToast("ุชู ุงูุญุฐู"); } };

window.markAttendance = async (id) => { const rec=data.find(x=>x.id===id); if(rec){ if(rec.subType==='sessions'&&rec.sessionsLeft<=0)return showToast("ููุชูู!","err"); if(rec.subType==='sessions')rec.sessionsLeft--; if(!rec.attendanceLog)rec.attendanceLog=[]; rec.attendanceLog.push({time:new Date().toISOString()}); await firebasePush(); window.render(); showToast("ุชู ุงูุญุถูุฑ โ๏ธ"); } };
window.openAttendanceLog = () => { const rec=data.find(x=>x.id===currentRowId); if(!rec)return; closeModal("rowActionsModal"); $("attendanceClientName").textContent=rec.name; const tb=$("attendanceTbody"); tb.innerHTML=""; if(rec.attendanceLog){ [...rec.attendanceLog].reverse().forEach((l,i)=>{ tb.innerHTML+=`<tr><td style="padding:10px;">${i+1}</td><td style="padding:10px;">${new Date(l.time).toLocaleDateString('en-GB')}</td><td style="padding:10px;direction:ltr;">${new Date(l.time).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}</td></tr>`; }); } openModal("attendanceModal"); };

window.openPaymentModal = () => { const rec=data.find(x=>x.id===currentRowId); if(!rec)return; closeModal("rowActionsModal"); let tot=parseFloat(rec.price)||0; let pd=parseFloat(rec.paidAmount)||0; let dbt=tot-pd; $("payTotal").textContent=tot; $("payPaid").textContent=pd; $("payDebt").textContent=dbt>0?dbt:0; $("newPaymentWrap").style.display=dbt>0?"block":"none"; $("newPaymentAmount").value=dbt>0?dbt:""; const tb=$("paymentTbody"); tb.innerHTML=""; if(rec.paymentLog){ [...rec.paymentLog].reverse().forEach(l=>{ tb.innerHTML+=`<tr><td style="padding:10px;">${new Date(l.time).toLocaleDateString('en-GB')}</td><td style="padding:10px;color:#10b981;">${l.amount}</td></tr>`; }); } openModal("paymentModal"); };
window.confirmNewPayment = async () => { const amt=parseFloat($("newPaymentAmount").value); if(amt>0){ const rec=data.find(x=>x.id===currentRowId); rec.paidAmount=(parseFloat(rec.paidAmount)||0)+amt; let tot=parseFloat(rec.price)||0; rec.paymentStatus=rec.paidAmount>=tot?'paid':'partial'; if(!rec.paymentLog)rec.paymentLog=[]; rec.paymentLog.push({time:new Date().toISOString(),amount:amt}); await firebasePush(); window.render(); showToast("ุชู ุงูุชุณุฏูุฏ"); window.openPaymentModal(); } };

window.actExtendAction = () => { extendMode="single"; closeModal("rowActionsModal"); openModal("extendModal"); };
window.confirmExtend = async () => { const val=parseInt($("extendValue").value); const unit=$("extendUnit").value; const process = (rec) => { if(rec.subType==='sessions'){ rec.sessionsLeft=(parseInt(rec.sessionsLeft)||0)+val; rec.sessionsTotal=(parseInt(rec.sessionsTotal)||0)+val; }else{ const ed=new Date(rec.end); if(unit==='months')ed.setMonth(ed.getMonth()+val); else ed.setDate(ed.getDate()+val); rec.end=ed.toISOString().split('T')[0]; } return rec; }; if(extendMode==="bulk"){ data=data.map(x=>selectedIds.has(x.id)?process(x):x); selectedIds.clear(); window.updateBulkUI(); } else { data=data.map(x=>x.id===currentRowId?process(x):x); } await firebasePush(); window.render(); closeModal("extendModal"); showToast("ุชู ุงูุชุฌุฏูุฏ ๐"); };

window.openReceiptAction = () => { const rec=data.find(x=>x.id===currentRowId); if(!rec)return; closeModal("rowActionsModal"); $("recName").textContent=rec.name||"-"; $("recPhone").textContent=rec.phone||"-"; $("recService").textContent=rec.serviceType||"-"; $("recPrice").textContent=(rec.price||0)+" "+(rec.currency||"DZD"); if(rec.subType==='sessions'){ $("recRowSessions").style.display="flex"; $("recSessions").textContent=rec.sessionsTotal+" ุญุตุฉ"; $("recRowMonths").style.display="none";$("recRowStart").style.display="none";$("recRowEnd").style.display="none"; }else{ $("recRowMonths").style.display="flex"; $("recMonths").textContent=rec.months+" ุดูุฑ"; $("recRowStart").style.display="flex"; $("recStart").textContent=rec.start; $("recRowEnd").style.display="flex"; $("recEnd").textContent=rec.end; $("recRowSessions").style.display="none"; } openModal("receiptModal"); };
window.printReceiptAction = () => { document.body.classList.add("print-mode-receipt"); $("receiptModal").classList.add("print-active"); window.print(); setTimeout(()=>{ document.body.classList.remove("print-mode-receipt"); $("receiptModal").classList.remove("print-active"); }, 500); };
window.openMembershipCard = () => { const rec=data.find(x=>x.id===currentRowId); if(!rec)return; closeModal("rowActionsModal"); $("idCardClientName").textContent=rec.name||"-"; $("idCardService").textContent=rec.serviceType||"-"; const qr=$("idCardQR"); qr.innerHTML=""; new QRCode(qr,{text:"ID:"+rec.id,width:130,height:130}); openModal("idCardModal"); };
window.printIdCardAction = () => { document.body.classList.add("print-mode-idcard"); $("idCardModal").classList.add("print-active"); window.print(); setTimeout(()=>{ document.body.classList.remove("print-mode-idcard"); $("idCardModal").classList.remove("print-active"); }, 500); };

window.updateBulkUI = () => { const b=$("bulkBar"); if(selectedIds.size>0){ b.style.display="flex"; $("selCount").textContent=selectedIds.size+" ูุญุฏุฏ"; }else{ b.style.display="none"; $("selectAll").checked=false; } };
$("tbody").addEventListener("change", e => { if(e.target.classList.contains("rowChk")){ if(e.target.checked)selectedIds.add(e.target.value); else selectedIds.delete(e.target.value); window.updateBulkUI(); } });
window.toggleSelectAll = (el) => { const c=el.checked; document.querySelectorAll(".rowChk").forEach(k=>{ k.checked=c; if(c)selectedIds.add(k.value); else selectedIds.delete(k.value); }); window.updateBulkUI(); };
window.clearSelectionAction = () => { selectedIds.clear(); window.render(); window.updateBulkUI(); };
window.bulkDeleteAction = async () => { if(confirm("ุญุฐู ุงููุญุฏุฏุ")){ data=data.filter(x=>!selectedIds.has(x.id)); selectedIds.clear(); await firebasePush(); window.render(); window.updateBulkUI(); } };
window.bulkExtendAction = () => { extendMode="bulk"; openModal("extendModal"); };

let searchTimeout; window.debounceSearch = () => { clearTimeout(searchTimeout); searchTimeout=setTimeout(()=>{window.currentPage=1;window.render();},400); };
window.clearSearch = () => { $("search").value=""; window.currentPage=1; window.render(); };
</script>
</body>
</html>
