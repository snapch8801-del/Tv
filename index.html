<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª 2.1 - Digital Receipts</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, sans-serif; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}
.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}

.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }
.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }

.searchWrap{flex:1;min-width:240px}
.searchWrap input{ width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; }

.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 0 14px 14px 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }

.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }

.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 980px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; font-weight:900; padding:12px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px 12px; border-bottom:1px solid rgba(255,255,255,.07); white-space:nowrap; vertical-align:middle; }
tbody tr:hover{ background: rgba(255,255,255,.03); }

.badge{ display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); font-size:12px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.62); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: 0 30px 90px rgba(0,0,0,.65); overflow:hidden; }
.modalHeader{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; }
.modalBody{ padding: 14px 16px; }

/* ===== Receipt Style ===== */
#receiptCapture{
  width: 380px; padding: 30px; background: #fff; color: #111; border-radius: 10px; font-family: 'Segoe UI', Tahoma, sans-serif;
  position: relative; margin: 0 auto;
}
.receipt-header{ text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 20px; }
.receipt-header h2{ margin: 0; color: #7c5cff; font-size: 24px; }
.receipt-row{ display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 15px; }
.receipt-row .label{ color: #666; }
.receipt-row .val{ font-weight: bold; }
.receipt-total{ margin-top: 20px; padding-top: 15px; border-top: 2px solid #111; display: flex; justify-content: space-between; font-weight: 900; font-size: 18px; }
.receipt-footer{ text-align: center; margin-top: 30px; font-size: 12px; color: #999; }

.actGrid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
.actBtn{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); padding: 14px; border-radius: 18px; font-weight: 900; cursor:pointer; }
.actionPill{ padding:10px 12px; border-radius:16px; border:1px solid var(--line); background: rgba(255,255,255,.04); color: var(--text); font-weight: 900; cursor:pointer; }

.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 14px; border-radius: 16px; background: rgba(10,14,26,.92); border: 1px solid var(--line); color: var(--text); font-weight: 900; display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s; z-index: 10000; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

</head>
<body>

<div class="container">
  <div class="header">
    <h1>ğŸ§¾ Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h1>
    <div class="sub">Ù†Ø³Ø®Ø© 2.1 - Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØµÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ ğŸ“„</div>
  </div>

  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd">â• Ø¥Ø¶Ø§ÙØ©</button>
      <button class="btn" id="openAuth">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>
      <div class="searchWrap"><input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…..." /></div>
      <div id="statsBar">
        <div class="statChip sync" id="syncChip"><span class="ico">â˜ï¸</span> <span id="syncVal">â€”</span></div>
      </div>
    </div>

    <div class="filtersBar">
      <button class="filterBtn active" data-filter="all">Ø§Ù„ÙƒÙ„</button>
      <button class="filterBtn" data-filter="active">âœ… ÙØ¹Ù‘Ø§Ù„</button>
      <button class="filterBtn" data-filter="expiring">â° Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="filterBtn" data-filter="expired">âŒ Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="receiptModal" aria-hidden="true">
  <div class="box" style="width: 420px; background: #f4f4f4;">
    <div class="modalHeader"><h2 style="color:#333">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙˆØµÙ„</h2><button class="btn" onclick="closeModal('receiptModal')" style="color:#333">âœ•</button></div>
    <div class="modalBody">
      <div id="receiptCapture">
        <div class="receipt-header">
          <h2>ALICIA SERVICES</h2>
          <p>ÙˆØµÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø´ØªØ±Ø§Ùƒ Ø±Ù‚Ù…ÙŠ</p>
        </div>
        <div class="receipt-row"><span class="label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</span><span class="val" id="recName">-</span></div>
        <div class="receipt-row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹:</span><span class="val" id="recDate">-</span></div>
        <div class="receipt-row"><span class="label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</span><span class="val" id="recMonths">-</span></div>
        <div class="receipt-row"><span class="label">ØµØ§Ù„Ø­ Ù„ØºØ§ÙŠØ©:</span><span class="val" id="recEnd">-</span></div>
        <div class="receipt-total"><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span><span class="val" id="recPrice">-</span></div>
        <div class="receipt-footer">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§!<br>Ù‡Ø°Ø§ Ø§Ù„ÙˆØµÙ„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Ù‹.</div>
      </div>
    </div>
    <div style="padding: 15px; display: flex; gap: 10px;">
      <button class="btn primary" style="flex:1" id="downloadReceiptBtn">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ ÙƒØµÙˆØ±Ø©</button>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box"><div class="modalHeader"><h2 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</h2><button class="btn" onclick="closeModal('formModal')">âœ•</button></div>
    <div class="modalBody">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
        <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù…" class="btn" style="text-align:right; background:rgba(0,0,0,.2)">
        <input id="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" class="btn" style="text-align:right; background:rgba(0,0,0,.2)">
        <input id="months" type="number" placeholder="Ø§Ù„Ø£Ø´Ù‡Ø±" class="btn" style="text-align:right; background:rgba(0,0,0,.2)">
        <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="btn" style="text-align:right; background:rgba(0,0,0,.2)">
        <input id="start" type="date" class="btn" style="background:rgba(0,0,0,.2)">
        <select id="currency" class="btn" style="background:rgba(0,0,0,.2)"><option value="DZD">DZD</option><option value="USD">USD</option></select>
      </div>
      <button class="btn primary" id="saveBtn" style="width:100%; margin-top:20px">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  </div>
</div>

<div class="modal" id="rowActionsModal" aria-hidden="true">
  <div class="box" style="width: 400px;">
    <div class="modalHeader"><h2>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2><button class="btn" onclick="closeModal('rowActionsModal')">âœ•</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" id="actReceipt" style="border-color:var(--accent); color:var(--accent)">ğŸ“„ ØªØ­Ù…ÙŠÙ„ ÙˆØµÙ„</button>
        <button class="actBtn" id="actWhatsApp" style="border-color:#25d366; color:#25d366">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="actBtn" id="actEdit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="actBtn danger" id="actDelete">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

const $ = (id)=>document.getElementById(id);
let data = []; let editingId = null; let currentRowId = null; let currentFilter = 'all';

// === Firebase Init ===
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
firebase.auth().onAuthStateChanged(u => { if(u) load(); else openModal('authModal'); });

async function load() {
  setSyncState('saving');
  const snap = await db.ref("subscriptions").once('value');
  data = snap.val() ? Object.values(snap.val()) : [];
  render(); setSyncState('ok');
}

async function save() {
  setSyncState('saving');
  await db.ref("subscriptions").set(data);
  setSyncState('ok');
}

function setSyncState(st) {
  const val = $('syncVal');
  if(st==='saving') val.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
  if(st==='ok') { const d=new Date(); val.textContent = d.getHours()+':'+d.getMinutes()+' âœ…'; }
}

function render() {
  const tb = $('tbody'); tb.innerHTML = '';
  const q = $('search').value.toLowerCase();
  
  data.filter(r => {
    const match = !q || r.name.toLowerCase().includes(q) || (r.phone||"").includes(q);
    const st = getStatus(r.end);
    if(currentFilter !== 'all' && currentFilter !== st.key) return false;
    return match;
  }).forEach(r => {
    const st = getStatus(r.end);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.phone||'-'}</td><td>${r.months} Ø´</td><td>${r.price} ${r.currency}</td><td>${r.end}</td><td><span class="badge ${st.cls}">${st.label}</span></td><td><button class="actionPill" onclick="openRowActions('${r.id}')">âš¡</button></td>`;
    tb.appendChild(tr);
  });
}

function getStatus(end) {
  const left = Math.round((new Date(end) - new Date()) / 86400000);
  if(left < 0) return {key:'expired', label:'Ù…Ù†ØªÙ‡ÙŠ', cls:'err'};
  if(left <= 7) return {key:'expiring', label:'Ù‚Ø±ÙŠØ¨', cls:'warn'};
  return {key:'active', label:'ÙØ¹Ø§Ù„', cls:'ok'};
}

// === Receipt Generator ===
function generateReceipt(id) {
  const r = data.find(x => x.id === id);
  if(!r) return;
  $('recName').textContent = r.name;
  $('recDate').textContent = r.start;
  $('recMonths').textContent = r.months + " Ø£Ø´Ù‡Ø±";
  $('recEnd').textContent = r.end;
  $('recPrice').textContent = r.price + " " + r.currency;
  openModal('receiptModal');
}

$('downloadReceiptBtn').onclick = () => {
  const target = $('receiptCapture');
  html2canvas(target).then(canvas => {
    const link = document.createElement('a');
    link.download = `ÙˆØµÙ„_Ø¯ÙØ¹_${$('recName').textContent}.png`;
    link.href = canvas.toDataURL();
    link.click();
    showToast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  });
};

// === Actions ===
window.openRowActions = (id) => { currentRowId = id; openModal('rowActionsModal'); };
$('actReceipt').onclick = () => { closeModal('rowActionsModal'); generateReceipt(currentRowId); };
$('actWhatsApp').onclick = () => { 
  const r = data.find(x => x.id === currentRowId);
  window.open(`https://wa.me/${r.phone}?text=Ù…Ø±Ø­Ø¨Ø§Ù‹ ${r.name}ØŒ ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù„ØºØ§ÙŠØ© ${r.end}`,'_blank');
};

$('saveBtn').onclick = () => {
  const r = {
    id: editingId || Date.now().toString(),
    name: $('name').value, phone: $('phone').value, months: $('months').value,
    price: $('price').value, currency: $('currency').value, start: $('start').value,
    end: addMonths($('start').value, parseInt($('months').value))
  };
  if(editingId) data = data.map(x => x.id === editingId ? r : x); else data.unshift(r);
  save(); render(); closeModal('formModal');
};

function addMonths(iso, m) { const d = new Date(iso); d.setMonth(d.getMonth() + m); return d.toISOString().split('T')[0]; }
function openModal(id) { $(id).setAttribute('aria-hidden','false'); }
function closeModal(id) { $(id).setAttribute('aria-hidden','true'); }
function showToast(m) { const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
$('openAdd').onclick = () => { editingId=null; openModal('formModal'); };
$('search').oninput = render;

document.querySelectorAll('.filterBtn').forEach(b => {
  b.onclick = (e) => { document.querySelectorAll('.filterBtn').forEach(x=>x.classList.remove('active')); e.target.classList.add('active'); currentFilter=e.target.dataset.filter; render(); };
});
</script>

</body>
</html>
