<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©</title>

<meta name="theme-color" content="#000000" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    :root {
        --bg: #05070a;
        --text: #ffffff;
        --success: #10b981;
        --error: #ef4444;
        --warning: #f59e0b;
    }
    
    * { box-sizing: border-box; }
    
    body {
        margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif;
        background: var(--bg); color: var(--text); overflow: hidden;
        display: flex; flex-direction: column; height: 100vh;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ± */
    #authScreen {
        position: absolute; inset: 0; background: var(--bg); z-index: 100;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .auth-box {
        background: rgba(255,255,255,0.05); padding: 40px; border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; text-align: center;
    }
    .auth-box input {
        width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.2); background: rgba(0,0,0,0.5);
        color: white; font-size: 16px; outline: none; text-align: left; direction: ltr;
    }
    .auth-box button {
        width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; font-size: 16px;
        background: linear-gradient(135deg, #7c5cff, #5a3bc2); color: white; border: none; cursor: pointer;
    }

    /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    #kioskScreen { display: none; flex-direction: column; height: 100vh; position: relative; }
    
    .header {
        text-align: center; padding: 20px; background: rgba(0,0,0,0.5); border-bottom: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(10px); z-index: 10;
    }
    .header h1 { margin: 0; font-size: 24px; font-weight: 900; letter-spacing: 1px; color: #eaf0ff;}
    .header p { margin: 5px 0 0 0; font-size: 14px; color: rgba(234,240,255,0.5); }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    .camera-container {
        flex: 1; display: flex; align-items: center; justify-content: center;
        padding: 20px; position: relative; flex-direction: column;
    }
    #reader {
        width: 100%; max-width: 500px; border-radius: 24px; overflow: hidden;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.1); background: #000;
    }
    #reader video { border-radius: 24px; object-fit: cover; }

    /* Ø²Ø± Ù‚Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
    .flip-btn {
        margin-top: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
        color: white; padding: 12px 24px; border-radius: 99px; cursor: pointer;
        font-weight: bold; font-family: inherit; font-size: 15px; transition: all 0.2s;
    }
    .flip-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© */
    #resultOverlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 50;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        text-align: center; padding: 20px; backdrop-filter: blur(15px);
        transition: all 0.3s ease;
    }
    .result-icon { font-size: 80px; margin-bottom: 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .result-title { font-size: 32px; font-weight: 900; margin: 0 0 10px 0; }
    .result-desc { font-size: 18px; color: rgba(255,255,255,0.7); max-width: 80%; line-height: 1.6;}
    .result-badge { display: inline-block; padding: 8px 20px; border-radius: 99px; font-size: 16px; font-weight: bold; margin-top: 20px; }

    @keyframes popIn {
        0% { transform: scale(0); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .theme-success .result-title { color: var(--success); }
    .theme-success .result-icon { filter: drop-shadow(0 0 20px rgba(16,185,129,0.5)); }
    .theme-success .result-badge { background: rgba(16,185,129,0.2); color: var(--success); border: 1px solid rgba(16,185,129,0.4); }

    .theme-error .result-title { color: var(--error); }
    .theme-error .result-icon { filter: drop-shadow(0 0 20px rgba(239,68,68,0.5)); }
    .theme-error .result-badge { background: rgba(239,68,68,0.2); color: var(--error); border: 1px solid rgba(239,68,68,0.4); }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<div id="authScreen">
    <div class="auth-box">
        <h2 style="margin-top:0;">ğŸ”’ ØªÙØ¹ÙŠÙ„ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p style="color:var(--muted); font-size:13px; margin-bottom:25px;">Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø¢Ù„ÙŠØ©.</p>
        <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button onclick="login()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸš€</button>
        <div id="loginError" style="color:var(--error); margin-top:15px; font-size:13px; display:none;">Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!</div>
    </div>
</div>

<div id="kioskScreen">
    <div class="header">
        <h1>Ù†Ù‚Ø·Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù„ÙŠ</h1>
        <p>ÙŠØ±Ø¬Ù‰ ØªÙ…Ø±ÙŠØ± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ù†Ø®Ø±Ø§Ø· (QR Code) Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
    </div>
    <div class="camera-container">
        <div id="reader"></div>
        <button class="flip-btn" onclick="flipCamera()">ğŸ”„ Ù‚Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>
</div>

<div id="resultOverlay">
    <div class="result-icon" id="resIcon">âœ…</div>
    <h1 class="result-title" id="resTitle">Ù…Ø±Ø­Ø¨Ø§Ù‹!</h1>
    <div class="result-desc" id="resDesc">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­.</div>
    <div class="result-badge" id="resBadge">Ù…ØªØ¨Ù‚ÙŠ 5 Ø­ØµØµ</div>
</div>

<script>
// ==========================================
// âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø· Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âš™ï¸
// ==========================================
const FIREBASE_CONFIG = { apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ", authDomain: "dattta-6f497.firebaseapp.com", databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com", projectId: "dattta-6f497", storageBucket: "dattta-6f497.firebasestorage.app", messagingSenderId: "804914291938", appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb" };
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const auth = firebase.auth();
const db = firebase.database();

let data = []; 
let isProcessing = false; 
let html5QrCode;
let currentFacingMode = "user"; // "user" Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©ØŒ "environment" Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©

function todayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(iso){ if(!iso) return new Date(); const d = new Date(iso+"T00:00:00"); d.setHours(0,0,0,0); return isNaN(d) ? new Date() : d; }

function getStatus(r) {
    if (r.subType === 'sessions') {
        let left = parseInt(r.sessionsLeft) || 0;
        if (left <= 0) return { key: "expired", label: "Ø±ØµÙŠØ¯ Ù…Ù†ØªÙ‡ÙŠ", text: "0 Ø­ØµØ©" };
        return { key: "active", label: "Ø±ØµÙŠØ¯ Ø³Ø§Ø±ÙŠ", text: `Ù…ØªØ¨Ù‚ÙŠ ${left} Ø­ØµØ©` };
    } else {
        if (!r.end) return { key:"expired", label:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯", text:`-` };
        const left = Math.round((toDate(r.end) - toDate(todayISO()))/(1000*60*60*24));
        if(left < 0) return { key:"expired", label:"Ù…Ø¯Ø© Ù…Ù†ØªÙ‡ÙŠØ©", text:`Ù…Ù†Ø° ${Math.abs(left)} ÙŠÙˆÙ…` };
        return { key:"active", label:"Ø³Ø§Ø±ÙŠ Ø§Ù„Ù…ÙØ¹ÙˆÙ„", text:`Ù…ØªØ¨Ù‚ÙŠ ${left} ÙŠÙˆÙ…` };
    }
}

// ==========================================
// ğŸ” Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙƒØ´Ùƒ
// ==========================================
auth.onAuthStateChanged((user) => {
    if (user) {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('kioskScreen').style.display = 'flex';
        startSyncAndCamera();
    } else {
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('kioskScreen').style.display = 'none';
    }
});

function login() {
    const e = document.getElementById('email').value.trim(); 
    const p = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');
    errorDiv.style.color = '#eaf0ff';
    errorDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
    errorDiv.style.display = 'block';

    auth.signInWithEmailAndPassword(e, p).catch((error) => {
        errorDiv.style.color = 'var(--error)';
        let msg = "Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!";
        if(error.code === 'auth/invalid-email') msg = "ØµÙŠØºØ© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø®Ø§Ø·Ø¦Ø©.";
        else if(error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        else if(error.code === 'auth/network-request-failed') msg = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.";
        else msg = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.code;
        errorDiv.textContent = msg;
    });
}

// ==========================================
// ğŸ“· ØªØ´ØºÙŠÙ„ ÙˆÙ‚Ù„Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
// ==========================================
function startSyncAndCamera() {
    db.ref("subscriptions").on('value', (snap) => {
        data = snap.exists() ? Object.values(snap.val()) : [];
    });

    html5QrCode = new Html5Qrcode("reader");
    startCamera();
}

function startCamera() {
    html5QrCode.start(
        { facingMode: currentFacingMode },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        handleScan,
        (err) => { /* ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© */ }
    ).catch(err => {
        // Ø¥Ø°Ø§ ÙØ´Ù„ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹ ÙÙŠ Ø­Ø§Ø³ÙˆØ¨ Ø¹Ø§Ø¯ÙŠ)ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        if(currentFacingMode === "user") {
            currentFacingMode = "environment";
            startCamera();
        }
    });
}

function flipCamera() {
    if(html5QrCode && html5QrCode.isScanning) {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø«Ù… ØªØ¨Ø¯ÙŠÙ„Ù‡Ø§
        html5QrCode.stop().then(() => {
            currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
            startCamera();
        }).catch(err => console.log(err));
    }
}

// Ø¥ØµØ¯Ø§Ø± ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ (Beep) Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­
function playBeep(isSuccess) {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = isSuccess ? 'sine' : 'sawtooth';
        osc.frequency.setValueAtTime(isSuccess ? 800 : 250, ctx.currentTime);
        osc.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.3);
    } catch(e) {}
}

// ==========================================
// ğŸ“· Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù€ QR Code
// ==========================================
async function handleScan(decodedText) {
    if (isProcessing) return; 
    isProcessing = true;

    if(!decodedText.startsWith("ID:")) {
        showScreen("error", "âŒ", "Ø±Ù…Ø² ØºÙŠØ± ØµØ§Ù„Ø­", "ÙŠØ±Ø¬Ù‰ Ù…Ø³Ø­ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù†Ø®Ø±Ø§Ø· Ù†Ø¸Ø§Ù…ÙŠØ© ØµØ§Ø¯Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ².", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©");
        return;
    }

    const scId = decodedText.split("ID:")[1];
    let userIndex = data.findIndex(x => x.id === scId);
    let user = data[userIndex];

    if(!user) {
        showScreen("error", "ğŸ›‘", "ØºÙŠØ± Ù…Ø³Ø¬Ù„", "Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", "Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
        return;
    }

    const st = getStatus(user);

    if (st.key === 'expired') {
        showScreen("error", "âš ï¸", "Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„", `Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ (${user.serviceType}) Ù…Ù†ØªÙ‡ÙŠ!`, st.text);
        db.ref("logs").push({ email: auth.currentUser.email, action: "Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ Ù…Ø±ÙÙˆØ¶Ø© âŒ", details: `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${user.name} (Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ)`, time: new Date().toISOString() });
        return;
    }

    if(user.subType === 'sessions') {
        user.sessionsLeft = parseInt(user.sessionsLeft) - 1;
    }
    
    if(!user.attendanceLog) user.attendanceLog = [];
    user.attendanceLog.push({ time: new Date().toISOString() });

    data[userIndex] = user;
    try {
        await db.ref("subscriptions").set(data);
        let logDetails = user.subType === 'sessions' ? `Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${user.sessionsLeft}` : `Ø§Ø´ØªØ±Ø§Ùƒ Ø²Ù…Ù†ÙŠ`;
        db.ref("logs").push({ email: auth.currentUser.email, action: "Ø¯Ø®ÙˆÙ„ Ø¢Ù„ÙŠ (Ø¨ÙˆØ§Ø¨Ø©) âœ”ï¸", details: `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${user.name}ØŒ ${logDetails}`, time: new Date().toISOString() });
        
        let newStatusTxt = user.subType === 'sessions' ? `Ù…ØªØ¨Ù‚ÙŠ ${user.sessionsLeft} Ø­ØµØ©` : st.text;
        showScreen("success", "âœ…", `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name.split(' ')[0]}!`, `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø³Ù… ${user.serviceType}.`, newStatusTxt);
    } catch(e) {
        showScreen("error", "ğŸ“¡", "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.", "Ù…Ø´ÙƒÙ„Ø© ØªÙ‚Ù†ÙŠØ©");
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ¥Ø®ÙØ§Ø¦Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function showScreen(theme, icon, title, desc, badge) {
    playBeep(theme === 'success');
    
    const overlay = document.getElementById('resultOverlay');
    overlay.className = ''; 
    overlay.classList.add('theme-' + theme);
    
    document.getElementById('resIcon').textContent = icon;
    document.getElementById('resTitle').textContent = title;
    document.getElementById('resDesc').textContent = desc;
    document.getElementById('resBadge').textContent = badge;
    
    overlay.style.display = 'flex';

    setTimeout(() => {
        overlay.style.display = 'none';
        isProcessing = false; 
    }, 3500);
}

</script>
</body>
</html>
