<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ù„ÙˆØ­Ø© ØªØ³ÙŠÙŠØ± Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ØµØ­Ø­Ø©</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --radius:18px;
}

*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, sans-serif; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}
.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); backdrop-filter: blur(10px); overflow:hidden; }
.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; font-size: 13px; }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }

.searchWrap{flex:1;min-width:200px}
.searchWrap input{ width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; }

/* Receipt Style */
#receiptCapture{ width: 380px; padding: 30px; background: #fff; color: #111; margin: 0 auto; text-align: right; }
#receiptLogoPreview{ max-height: 80px; max-width: 150px; display: block; margin: 0 auto 15px; }
.receipt-header{ text-align: center; border-bottom: 2px dashed #eee; padding-bottom: 15px; margin-bottom: 20px; }
.receipt-row{ display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
.receipt-total{ margin-top: 20px; padding-top: 15px; border-top: 2px solid #111; display: flex; justify-content: space-between; font-weight: 900; font-size: 18px; }

table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 800px; }
thead th{ background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; padding:12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px; border-bottom:1px solid rgba(255,255,255,.07); }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.85); z-index:9999; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ background: #161b2a; border-radius: 22px; padding: 20px; border: 1px solid var(--line); }

.badge{ padding:4px 8px; border-radius:99px; font-size:11px; font-weight:bold; }
.badge.ok{ background:rgba(34,197,94,.2); color:#4ade80; }
.badge.warn{ background:rgba(245,158,11,.2); color:#fbbf24; }
.badge.err{ background:rgba(239,68,68,.2); color:#f87171; }

.toast{ position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); padding: 12px 20px; border-radius: 12px; background: #7c5cff; color: #fff; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 10000; }
.toast.show{ opacity: 1; }
</style>
</head>
<body>

<div class="container">
  <div class="card">
    <div class="topbar">
      <button class="btn primary" id="openAdd">â• Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</button>
      <button class="btn" onclick="$('logoInput').click()">ğŸ–¼ï¸ Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±</button>
      <input type="file" id="logoInput" hidden accept="image/*">
      <div class="searchWrap"><input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..."></div>
      <button class="btn" id="openAuth">ğŸ‘¤ Ø­Ø³Ø§Ø¨</button>
      <div id="syncVal" style="font-size: 11px; color: var(--muted); margin-inline-start: 10px;">â˜ï¸ â€”</div>
    </div>

    <div style="overflow-x:auto">
      <table>
        <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal" id="receiptModal" aria-hidden="true">
  <div class="box" style="background: #f0f0f0; width: 420px;">
    <div id="receiptCapture">
      <img id="receiptLogoPreview" src="" alt="" style="display:none">
      <div class="receipt-header">
        <h2 id="receiptBusinessName">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h2>
        <p>ÙˆØµÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ø´ØªØ±Ø§Ùƒ</p>
      </div>
      <div class="receipt-row"><span>Ø§Ù„Ù…Ø´ØªØ±Ùƒ:</span><span id="recName"></span></div>
      <div class="receipt-row"><span>Ù…Ù† ØªØ§Ø±ÙŠØ®:</span><span id="recStart"></span></div>
      <div class="receipt-row"><span>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</span><span id="recEnd"></span></div>
      <div class="receipt-total"><span>Ø§Ù„Ù…Ø¨Ù„Øº:</span><span id="recPrice"></span></div>
      <div style="text-align:center; font-size:11px; margin-top:20px; color:#999">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… - ØªÙ… Ø§Ù„Ù†Ø´Ø± Ù…Ù† Ù…Ø¯ÙŠØ©</div>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px">
      <button class="btn primary" style="flex:1" id="downloadBtn">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØµÙ„</button>
      <button class="btn" style="background:#fff; color:#000" onclick="closeModal('receiptModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" style="width: 350px;">
    <h3>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
    <input id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <input id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <input id="price" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <input id="months" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <input id="start" type="date" class="btn" style="width:100%; margin-bottom:10px">
    <button class="btn primary" id="saveBtn" style="width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>
</div>

<div class="modal" id="authModal" aria-hidden="true">
  <div class="box" style="width: 350px;">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    <input id="authEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <input id="authPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="btn" style="width:100%; margin-bottom:10px; text-align:right">
    <button class="btn primary" id="authLogin" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
'use strict';
const $ = (id)=>document.getElementById(id);
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAQPzqeazhj4rjyY1dbcGZ9YEAv8ZhLQbQ",
  authDomain: "dattta-6f497.firebaseapp.com",
  databaseURL: "https://dattta-6f497-default-rtdb.firebaseio.com",
  projectId: "dattta-6f497",
  storageBucket: "dattta-6f497.firebasestorage.app",
  messagingSenderId: "804914291938",
  appId: "1:804914291938:web:7a7d3fe8a5ebb28a306abb"
};

let data = []; let editingId = null; 

// === Logo Logic ===
const logo = localStorage.getItem('user_logo');
if(logo) { $('receiptLogoPreview').src = logo; $('receiptLogoPreview').style.display='block'; }
$('logoInput').onchange = (e) => {
  const reader = new FileReader();
  reader.onload = () => { localStorage.setItem('user_logo', reader.result); $('receiptLogoPreview').src = reader.result; $('receiptLogoPreview').style.display='block'; showToast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ø¹Ø§Ø±"); };
  reader.readAsDataURL(e.target.files[0]);
};

// === Firebase Setup ===
if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
firebase.auth().onAuthStateChanged(u => { if(u) load(); else openModal('authModal'); });

async function load() {
  const snap = await db.ref("subscriptions").once('value');
  data = snap.val() ? Object.values(snap.val()) : [];
  render(); updateSync();
}

function render() {
  const tb = $('tbody'); tb.innerHTML = '';
  const q = $('search').value.toLowerCase();
  data.filter(r => !q || r.name.toLowerCase().includes(q)).forEach(r => {
    const left = Math.round((new Date(r.end) - new Date()) / 86400000);
    const badge = left < 0 ? 'err' : (left <= 7 ? 'warn' : 'ok');
    const label = left < 0 ? 'Ù…Ù†ØªÙ‡ÙŠ' : (left <= 7 ? 'Ù‚Ø±ÙŠØ¨' : 'ÙØ¹Ø§Ù„');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.phone}</td><td>${r.price} DZD</td><td>${r.end}</td>
    <td><button class="btn" onclick="openReceipt('${r.id}')">ğŸ“„</button>
    <button class="btn" onclick="editRow('${r.id}')">âœï¸</button></td>`;
    tb.appendChild(tr);
  });
}

window.openReceipt = (id) => {
  const r = data.find(x => x.id === id);
  $('recName').textContent = r.name;
  $('recStart').textContent = r.start;
  $('recEnd').textContent = r.end;
  $('recPrice').textContent = r.price + " DZD";
  openModal('receiptModal');
};

$('downloadBtn').onclick = () => {
  html2canvas($('receiptCapture')).then(canvas => {
    const a = document.createElement('a'); a.download = `ÙˆØµÙ„_${$('recName').textContent}.png`;
    a.href = canvas.toDataURL(); a.click(); closeModal('receiptModal');
  });
};

$('saveBtn').onclick = async () => {
  const start = $('start').value;
  const months = parseInt($('months').value);
  const endD = new Date(start); endD.setMonth(endD.getMonth() + months);
  
  const rec = {
    id: editingId || Date.now().toString(),
    name: $('name').value, phone: $('phone').value, price: $('price').value,
    start, end: endD.toISOString().split('T')[0], months
  };

  if(editingId) data = data.map(x => x.id === editingId ? rec : x);
  else data.unshift(rec);

  await db.ref("subscriptions").set(data);
  render(); closeModal('formModal'); showToast("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­");
};

window.editRow = (id) => {
  const r = data.find(x => x.id === id);
  editingId = id; $('name').value = r.name; $('phone').value = r.phone;
  $('price').value = r.price; $('months').value = r.months; $('start').value = r.start;
  openModal('formModal');
};

$('authLogin').onclick = () => {
  firebase.auth().signInWithEmailAndPassword($('authEmail').value, $('authPass').value)
  .then(() => closeModal('authModal')).catch(e => alert(e.message));
};

function openModal(id) { $(id).setAttribute('aria-hidden','false'); }
function closeModal(id) { $(id).setAttribute('aria-hidden','true'); }
function showToast(m) { const t=$('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
function updateSync() { const d=new Date(); $('syncVal').textContent = `â˜ï¸ ${d.getHours()}:${d.getMinutes()} âœ…`; }
$('openAdd').onclick = () => { editingId=null; $('start').value=new Date().toISOString().split('T')[0]; openModal('formModal'); };
$('search').oninput = render;
</script>
</body>
</html>
