<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช - v12.1</title>

<style>
:root{
  --bg0:#070a12; --bg1:#0b1020; --card: rgba(255,255,255,.06); --line: rgba(255,255,255,.10);
  --text:#eaf0ff; --muted: rgba(234,240,255,.70); --accent:#7c5cff; --warn:#f59e0b;
  --err:#ef4444; --radius:18px; --shadow: 0 18px 45px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; color: var(--text);
  background: radial-gradient(1200px 650px at 85% -10%, rgba(124,92,255,.25), transparent 60%), linear-gradient(180deg, var(--bg0), var(--bg1));
  padding: 18px;
}
.container{max-width:1200px;margin:0 auto}

.header{margin-bottom:14px}
.header h1{margin:0;font-size:20px; display: flex; align-items: center; gap: 8px;}
.header .sub{margin-top:6px;font-size:13px;color:var(--muted);line-height:1.7}
.version-badge { background: linear-gradient(135deg, var(--accent), #5a3bc2); color: white; padding: 4px 8px; border-radius: 8px; font-weight: 900; font-size: 12px; box-shadow: 0 4px 15px rgba(124,92,255,0.3);}

.card{ background: var(--card); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(10px); overflow:hidden; }

.topbar{ padding:14px; border-bottom:1px solid var(--line); display:flex; flex-direction:column; gap:12px; }
.topbar-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; width: 100%; }
.searchWrap{ display: flex; gap: 6px; align-items: center; width: 100%; }
.searchWrap input { flex:1; width:100%; padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); outline:none; transition: all 0.2s; font-size: 14px;}
.searchWrap input:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); }

.btn{ border:1px solid var(--line); background: rgba(0,0,0,.18); color: var(--text); padding:10px 12px; border-radius:14px; font-weight:900; cursor:pointer; transition: all .15s ease; font-size:13px; }
.btn:hover{ background: rgba(255,255,255,.06); }
.btn:active{ transform: scale(.98); }
.btn.primary{ border-color: rgba(124,92,255,.55); background: linear-gradient(135deg, rgba(124,92,255,.55), rgba(124,92,255,.15)); }
.btn.danger{ border-color: rgba(239,68,68,.45); background: linear-gradient(135deg, rgba(239,68,68,.35), rgba(239,68,68,.12)); color: #ff8a8a; }
.btn.soft{ border-color: rgba(255,255,255,.14); background: rgba(255,255,255,.04); }
.btn-close { padding: 8px 14px; font-size: 13px; border-radius: 12px; }

input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active{ -webkit-box-shadow: 0 0 0 30px #161b2a inset !important; -webkit-text-fill-color: var(--text) !important; transition: background-color 5000s ease-in-out 0s; }

.filtersBar{ width: 100%; display: flex; gap: 8px; padding: 14px; flex-wrap: wrap; border-bottom: 1px solid var(--line); background: rgba(0,0,0,0.1); }
.filterBtn{ padding: 8px 14px; border-radius: 999px; border: 1px solid var(--line); background: rgba(0,0,0,.18); color: var(--muted); font-size: 13px; font-weight: 800; cursor: pointer; }
.filterBtn.active{ background: var(--text); color: var(--bg0); border-color: var(--text); }

.bulkBar{ display: none; align-items: center; gap: 10px; padding: 12px 14px; background: rgba(124,92,255,.15); border-bottom: 1px solid rgba(124,92,255,.3); }
.bulkBar .selCount{ font-weight: 900; color: #fff; background: var(--accent); padding: 4px 10px; border-radius: 99px; font-size: 12px; }

.statChip{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(0,0,0,.18); font-size:12px; font-weight:900; color: var(--text); margin-inline-start: auto; }
.statChip.sync{ border-color: rgba(124,92,255,.45); background: rgba(124,92,255,.10); }

input[type="checkbox"] { appearance: none; width: 18px; height: 18px; border: 2px solid var(--muted); border-radius: 4px; background: rgba(0,0,0,.2); cursor: pointer; position: relative; display: inline-block; vertical-align: middle; }
input[type="checkbox"]:checked { background: var(--accent); border-color: var(--accent); }
input[type="checkbox"]:checked::after { content: "โ"; position: absolute; color: white; font-size: 12px; left: 3px; top: -1px; font-weight: bold; }

.tableWrap{ overflow:auto; }
table{ width:100%; border-collapse:separate; border-spacing:0; min-width: 850px; }
thead th{ position:sticky; top:0; z-index:5; background: rgba(0,0,0,.22); color: var(--muted); text-align:right; font-size:12px; font-weight:900; padding:14px 12px; border-bottom:1px solid var(--line); }
tbody td{ padding:12px; border-bottom:1px solid rgba(255,255,255,.05); white-space:nowrap; vertical-align:middle; }

tr.expired-row{ background: rgba(239,68,68,.08); }
tr.expiring-row{ background: rgba(245,158,11,.06); }
tr.expired-row td:nth-child(2){ box-shadow: inset 4px 0 0 rgba(239,68,68,.85); }
tr.expiring-row td:nth-child(2){ box-shadow: inset 4px 0 0 rgba(245,158,11,.85); }

.badge{ display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:11px; font-weight:900; }
.badge.ok{ border-color: rgba(34,197,94,.45); color:#c8f7d9; background: rgba(34,197,94,.1); }
.badge.warn{ border-color: rgba(245,158,11,.45); color:#ffe2b3; background: rgba(245,158,11,.1); }
.badge.err{ border-color: rgba(239,68,68,.45); color:#ffd0d0; background: rgba(239,68,68,.1); }

.service-badge { background: rgba(124,92,255,0.15); color: #a78bfa; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 11px; border: 1px solid rgba(124,92,255,0.3); display: inline-block; }

.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.75); z-index:9999; padding: 18px; }
.modal[aria-hidden="false"]{ display:flex; }
.modal .box{ width:min(860px, 100%); background: rgba(10,14,26,.96); border: 1px solid rgba(255,255,255,.10); border-radius: 22px; box-shadow: 0 30px 90px rgba(0,0,0,.65); overflow:hidden; max-height: 90vh; overflow-y: auto; }
.modalHeader{ padding:16px 20px; border-bottom:1px solid rgba(255,255,255,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; position: sticky; top: 0; background: rgba(10,14,26,.96); z-index: 10; backdrop-filter: blur(5px); }
.modalHeader h2{margin:0;font-size:18px}
.modalHeader .hint{color:var(--muted);font-size:12px}
.modalBody{ padding: 20px; }
.modalFooter{ padding:16px 20px; border-top:1px solid rgba(255,255,255,.10); display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start; position: sticky; bottom: 0; background: rgba(10,14,26,.96); z-index: 10; }

.formGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
.full-width { grid-column: 1 / -1 !important; }
@media (max-width: 768px){ .formGrid{ grid-template-columns: 1fr; } }

.field label{ display:block; font-weight:900; font-size:13px; color: var(--muted); margin-bottom:8px; }
.field input, .field select{ background: rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.15); width:100%; padding:12px 14px; border-radius:14px; color: var(--text); outline:none; transition: all 0.2s; font-size: 14px; }
.field input:focus, .field select:focus{ border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); background:rgba(0,0,0,0.5); }

.actionPill{ padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); font-weight: 900; cursor:pointer; font-size: 12px; }
.actGrid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px; }
@media (max-width: 640px){ .actGrid{ grid-template-columns: 1fr; } }
.actBtn{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); padding: 14px; border-radius: 18px; font-weight: 900; cursor:pointer; }

.toast{ position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%) translateY(20px); padding: 12px 14px; border-radius: 16px; background: rgba(10,14,26,.92); border: 1px solid rgba(255,255,255,.12); color: var(--text); display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none; transition: all .2s ease; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-weight:bold; }
.toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto;}

.auth-wrap { text-align: center; padding: 10px 15px; }
.auth-icon-wrap { display:inline-flex; align-items:center; justify-content:center; width:75px; height:75px; background:linear-gradient(135deg, rgba(124,92,255,0.2), rgba(124,92,255,0.05)); border:1px solid rgba(124,92,255,0.3); border-radius:50%; font-size:32px; margin-bottom:15px; box-shadow: 0 10px 25px rgba(124,92,255,0.15); }
.auth-title { margin:0 0 5px 0; font-size:24px; color:var(--text); font-weight:900; }
.auth-sub { color:var(--muted); font-size:13px; margin-bottom: 30px; }
.auth-input { width:100%; padding:15px 18px; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.1); border-radius:16px; color:#fff; font-size:15px; outline:none; transition:all 0.2s; text-align: left; direction: ltr; }
.auth-input:focus { border-color: rgba(124,92,255,.6); box-shadow: 0 0 0 4px rgba(124,92,255,.14); background:rgba(0,0,0,0.6); }

.receipt-table { min-width: 0 !important; width: 100% !important; } 

@media print {
    body > *:not(#receiptModal) { display: none !important; }
    body { background: white !important; padding: 0 !important; margin: 0 !important; }
    #receiptModal { display: block !important; position: static !important; background: white !important; }
    #receiptModal .box { width: 100% !important; max-width: none !important; box-shadow: none !important; border: none !important; border-radius: 0 !important; padding: 0 !important; }
    .no-print { display: none !important; }
}

/* =========================================
   ุชูุณููุงุช ุดุฑูุท ุงูุชูุณูู Pagination (ุงูุฌุฏูุฏุฉ)
   ========================================= */
.paginationBar { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-top: 1px solid var(--line); background: rgba(0,0,0,.15); flex-wrap: wrap; gap: 15px; }
.paginationBar .page-info { font-size: 13px; color: var(--muted); font-weight: 600; }
.paginationBar .page-info span { color: var(--text); font-weight: 900; }
.paginationBar .page-actions { display: flex; align-items: center; gap: 10px; }
.paginationBar .page-numbers { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,.3); padding: 4px 12px; border-radius: 12px; border: 1px solid var(--line); font-size: 13px; font-weight: bold; }
.paginationBar .current-page { color: var(--accent); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>๐งพ ููุญุฉ ุชุณููุฑ ุงูุงุดุชุฑุงูุงุช <span class="version-badge">v12.1</span></h1>
    <div class="sub">โก ุงููุณุฎุฉ ุงูุตุงููุฉ (ุฅุตูุงุญ ุงูููุงูุฐ ูุงูุฃุฒุฑุงุฑ ุจุงููุงูู)</div>
  </div>

  <div class="card">
    <div class="topbar">
      <div class="topbar-actions">
        <button class="btn primary" type="button" onclick="openAddSub()">โ ุฅุถุงูุฉ</button>
        <button class="btn soft" type="button" onclick="openTotalsReport()">๐ฐ ุงููุฌููุน</button>
        <button class="btn soft" type="button" onclick="openModal('authModal')" style="border-color:var(--accent); color:var(--accent);">๐ค ุงูุฅุฏุงุฑุฉ</button>
        <button class="btn soft" type="button" onclick="openModal('toolsModal')">โ๏ธ ุฃุฏูุงุช</button>
        <div class="statChip sync" id="syncChip"><span class="ico">โ๏ธ</span> <span class="v" id="syncVal">โ</span></div>
      </div>
      <div class="searchWrap">
        <input id="search" oninput="window.render()" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงูุฅููููุ ุงููุงุชูุ ุฃู ุงูุฎุฏูุฉ..." />
        <button class="btn soft" title="ูุตู ุงูุจุญุซ" style="padding: 10px 12px; border-radius: 12px; font-size: 15px;" onclick="pasteSearch()">๐</button>
        <button class="btn soft" title="ูุณุญ ุงูุจุญุซ" style="padding: 10px 12px; border-radius: 12px; font-size: 15px; color: var(--err);" onclick="clearSearch()">โ</button>
      </div>
    </div>

    <div class="bulkBar" id="bulkBar">
      <div class="selCount" id="selCount">0 ูุญุฏุฏ</div>
      <button class="btn" style="border-color:var(--accent); color:var(--accent);" onclick="bulkExtendAction()">๐ ุชุฌุฏูุฏ</button>
      <button class="btn danger" onclick="bulkDeleteAction()">๐๏ธ ุญุฐู</button>
      <button class="btn soft" style="margin-inline-start:auto;" onclick="clearSelectionAction()">ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
    </div>

    <div class="filtersBar" id="filtersBar">
      <button class="filterBtn active" data-filter="all" onclick="setFilter(this, 'all')">ุงููู</button>
      <button class="filterBtn" data-filter="active" onclick="setFilter(this, 'active')">โ ูุนูุงู</button>
      <button class="filterBtn" data-filter="expiring" onclick="setFilter(this, 'expiring')">โฐ ูุฑูุจ ููุชูู</button>
      <button class="filterBtn" data-filter="expired" onclick="setFilter(this, 'expired')">โ ููุชูู</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
            <th>ุงูุนููู</th> <th>ุงููุงุชู</th> <th>ุงูุงุดุชุฑุงู</th> <th>ุงููุงููุฉ</th> <th>ุงูุชูุงุฑูุฎ</th> <th>ุงูุญุงูุฉ</th> <th>ุฅุฌุฑุงุก</th>
          </tr>
        </thead>
        <tbody id="tbody">
          </tbody>
      </table>
    </div>

    <div class="paginationBar">
      <div class="page-info">
        ุฅุธูุงุฑ <span id="startItem">0</span> - <span id="endItem">0</span> ูู ุฃุตู <span id="totalItems">0</span> ูุดุชุฑู
      </div>
      <div class="page-actions">
        <button class="btn soft" id="prevPageBtn" onclick="goToPrevPage()" disabled>โฌ๏ธ ุงูุณุงุจู</button>
        <div class="page-numbers" id="pageNumbers">
          <span class="current-page">1</span>
        </div>
        <button class="btn soft" id="nextPageBtn" onclick="goToNextPage()" disabled>ุงูุชุงูู โก๏ธ</button>
      </div>
    </div>

  </div>
</div>

<div class="modal" id="toolsModal" aria-hidden="true">
  <div class="box" style="width: 480px">
    <div class="modalHeader"><h2>โ๏ธ ุฃุฏูุงุช ุฅุถุงููุฉ</h2><button class="btn danger btn-close" type="button" onclick="closeModal('toolsModal')">โ ุฅุบูุงู</button></div>
    <div class="modalBody">
      <div class="actGrid">
        <button class="actBtn" style="color:#10b981; border-color:rgba(16,185,129,0.4); background:rgba(16,185,129,0.1);" onclick="exportCSV()">๐ฅ ุชุตุฏูุฑ Excel</button>
        <button class="actBtn" style="color:#f59e0b; border-color:rgba(245,158,11,0.4); background:rgba(245,158,11,0.1);" onclick="undoDelete()">โฉ๏ธ ุงูุชุฑุงุฌุน ุนู ุงูุญุฐู</button>
        <button class="actBtn" onclick="closeModal('toolsModal'); openModal('backupModal')">๐ฆ ุงููุณุฎ ุงูุงุญุชูุงุทู</button>
        <button class="actBtn" onclick="closeModal('toolsModal'); openModal('syncModal')">โ๏ธ ุญุงูุฉ ุงููุฒุงููุฉ</button>
        <button class="actBtn" onclick="shareApp()">๐ค ูุดุงุฑูุฉ ุงูููุญุฉ</button>
        <button class="actBtn" onclick="closeModal('toolsModal'); window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงูุฌุฏูู</button>
        <button class="actBtn danger" style="grid-column: span 2;" onclick="clearAllData()">๐๏ธ ุญุฐู ุฌููุน ุงูุจูุงูุงุช ููุงุฆูุงู</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="formModal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <div class="modalHeader"><div><h2 id="formTitle">ุฅุถุงูุฉ ุงุดุชุฑุงู</h2><div class="hint">ุงููุฃ ุงูุจูุงูุงุช ุซู ุงุถุบุท ุญูุธ</div></div><button class="btn danger btn-close" type="button" onclick="closeModal('formModal')">โ ุฅุบูุงู</button></div>
    <div class="modalBody">
      <div class="formGrid">
        <div class="field full-width"><label>ุงูุงุณู <span style="color:var(--err)">*</span></label><input id="name" placeholder="ูุซุงู: Ahmed"></div>
        <div class="field full-width"><label>ุงููุงุชู (ูุน ุงูุฑูุฒ)</label><div style="display: flex; gap: 8px;"><select id="countryCode" style="width: 110px; direction: ltr;"><option value="+213">๐ฉ๐ฟ +213</option><option value="+212">๐ฒ๐ฆ +212</option><option value="+216">๐น๐ณ +216</option><option value="">ุจุฏูู ุฑูุฒ</option></select><input id="phone" type="tel" dir="ltr" placeholder="555000000" style="flex:1;"></div></div>
        <div class="field full-width"><label>ุงูุฅูููู (ุฅุฌุจุงุฑู) <span style="color:var(--err)">*</span></label><input id="email" placeholder="name@example.com" inputmode="email"></div>
        <div class="field full-width"><label>ุงูุฎุฏูุฉ / ุงูุจุงูุฉ <span style="color:var(--err)">*</span></label><input id="serviceType" list="serviceList" placeholder="ุงุฎุชุฑ ุฃู ุงูุชุจ ุฎุฏูุฉ ุฌุฏูุฏุฉ"><datalist id="serviceList"><option value="IPTV"><option value="Netflix"><option value="Canva Pro"><option value="YouTube Premium"><option value="Office 365"></datalist></div>
        <div class="field"><label>ุงููุฏุฉ (ุฃุดูุฑ) <span style="color:var(--err)">*</span></label><input id="months" type="number" min="1" step="1"></div>
        <div class="field"><label>ุงูุนููุฉ</label><select id="currency"><option value="DZD">DZD</option><option value="EUR">EUR</option><option value="USD">USD</option><option value="MAD">MAD</option><option value="TND">TND</option></select></div>
        <div class="field full-width"><label>ุงูุณุนุฑ ุงูุฅุฌูุงูู</label><input id="price" type="number" min="0" step="0.01" placeholder="ูุซุงู: 5000" oninput="window.calcDebt()"></div>
        <div class="field full-width"><label>ุงููุจูุบ ุงููุฏููุน <span style="color:var(--muted); font-weight:normal; font-size:10px;">(ุงุชุฑูู ูุงุฑุบุงู ุฅู ุฏูุน ุงููู)</span></label><input id="paidAmount" type="number" min="0" step="0.01" placeholder="ูุซุงู: 2000" oninput="window.calcDebt()"></div>
        <div class="field full-width"><label>ุงูุฏูู ุงููุชุจูู (ุขูู)</label><input id="debtAmount" type="text" readonly style="background: rgba(239,68,68,0.1); color: #ff8a8a; font-weight: bold; border-color: rgba(239,68,68,0.3); pointer-events: none;"></div>
        <div class="field"><label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ <span style="color:var(--err)">*</span></label><input id="start" type="date"></div>
        <div class="field"><label>ุชูุจูู ูุจู (ุฃูุงู)</label><input id="alertDays" type="number" min="1" step="1" value="7"></div>
        <div class="field"><label>ุงุฎุชูุงุฑ ุณุฑูุน ูููุฏุฉ</label><select id="quickPlan" onchange="window.handleQuickPlan()"><option value="">โ ุงุฎุชุฑ โ</option><option value="1">1 ุดูุฑ</option><option value="3">3 ุฃุดูุฑ</option><option value="6">6 ุฃุดูุฑ</option><option value="12">12 ุดูุฑ</option></select></div>
      </div>
    </div>
    <div class="modalFooter"><button class="btn primary" type="button" style="padding: 12px 24px; font-size: 14px;" onclick="saveSubscription()">๐พ ุญูุธ ุงูุจูุงูุงุช</button></div>
  </div>
</div>

<div class="modal" id="storeSettingsModal" aria-hidden="true">
  <div class="box" style="width: 400px">
    <div class="modalHeader"><h2>โ๏ธ ุฅุนุฏุงุฏุงุช ุงููุชุฌุฑ (ุงูููุฌู)</h2><button class="btn danger btn-close" type="button" onclick="closeModal('storeSettingsModal')">โ ุฅุบูุงู</button></div>
    <div class="modalBody">
       <div class="field" style="margin-bottom:15px"><label>ุงุณู ุงููุชุฌุฑ (ูุธูุฑ ูู ุงููุงุชูุฑุฉ)</label><input id="setStoreName" placeholder="ูุซุงู: ูุชุฌุฑ ุงูุงุดุชุฑุงูุงุช"></div>
       <div class="field" style="margin-bottom:15px"><label>ุงูุดุนุงุฑ (Logo)</label><input type="file" id="setStoreLogo" accept="image/*" style="padding: 8px;" onchange="window.handleLogoUpload(event)"></div>
       <div style="text-align:center; padding:10px; background:rgba(255,255,255,0.05); border-radius:12px;"><div style="font-size:12px; color:var(--muted); margin-bottom:5px;">ูุนุงููุฉ ุงูุดุนุงุฑ:</div><img id="logoPreview" src="" style="max-width:100px; max-height:100px; border-radius:10px; display:none; margin: 0 auto;"><div id="logoEmojiFallback" style="font-size:40px;">๐</div></div>
       <button class="btn primary" style="width:100%; margin-top:20px; padding:14px; border-radius:14px;" onclick="saveStoreSettings()">๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
    </div>
  </div>
</div>

<div class="modal" id="receiptModal" aria-hidden="true">
  <div class="box" style="width: 450px; background: #ffffff; color: #000000; border: none; border-radius: 12px;">
    <div class="modalHeader no-print" style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
      <h2 style="color: #0f172a;">๐ ุงููุตู ุงูุฑููู</h2>
      <button class="btn btn-close" type="button" style="background:#f1f5f9; color:#ef4444; border:1px solid #e2e8f0;" onclick="closeModal('receiptModal')">โ ุฅุบูุงู</button>
    </div>
    <div class="modalBody receipt-content" style="padding: 30px 25px; font-family: Tahoma, Arial, sans-serif; background: #ffffff;">
      <div style="text-align: center; margin-bottom: 25px;">
        <img id="receiptLogoImg" src="" style="display:none; max-width:80px; max-height:80px; border-radius:12px; margin:0 auto 10px;">
        <div id="receiptLogoEmoji" style="font-size: 40px; margin-bottom: 5px;">๐</div>
        <h1 id="receiptStoreName" style="margin: 0; font-size: 22px; color: #0f172a;">ูุชุฌุฑ ุงูุงุดุชุฑุงูุงุช</h1>
        <p style="margin: 5px 0 0; color: #64748b; font-size: 14px;">ูุตู ุงุณุชูุงู ุงุดุชุฑุงู</p>
      </div>
      <div style="border-top: 2px dashed #e2e8f0; border-bottom: 2px dashed #e2e8f0; padding: 15px 0; margin-bottom: 20px;">
        <p style="margin: 5px 0; font-size: 15px;"><strong>ุงุณู ุงูุนููู:</strong> <span id="receiptCustomerName">---</span></p>
        <p style="margin: 5px 0; font-size: 15px;"><strong>ุงูุฎุฏูุฉ:</strong> <span id="receiptService">---</span></p>
        <p style="margin: 5px 0; font-size: 15px;"><strong>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ:</strong> <span id="receiptStartDate">---</span></p>
        <p style="margin: 5px 0; font-size: 15px;"><strong>ุชุงุฑูุฎ ุงูููุงูุฉ:</strong> <span id="receiptEndDate">---</span></p>
      </div>
      <div style="text-align: center;">
        <h2 style="margin: 0; color: #0f172a; font-size: 24px;"><span id="receiptPrice">0.00</span> <span id="receiptCurrency" style="font-size: 16px;">DZD</span></h2>
        <p style="margin: 5px 0 0; color: #10b981; font-weight: bold; font-size: 14px;" id="receiptStatus">ูุฏููุน ุจุงููุงูู</p>
      </div>
    </div>
    <div class="modalFooter no-print" style="background: #f8fafc; border-top: 1px solid #e2e8f0; justify-content: center;">
      <button class="btn primary" type="button" style="padding: 10px 20px;" onclick="window.print()">๐จ๏ธ ุทุจุงุนุฉ ุงููุตู</button>
    </div>
  </div>
</div>

<script>
// ุฅุนุฏุงุฏุงุช Firebase ุงูุฎุงุตุฉ ุจู (ูุฌุจ ุนููู ุฅุถุงูุฉ ุจูุงูุงุช ูุดุฑูุนู ููุง)
const firebaseConfig = {
  // apiKey: "YOUR_API_KEY",
  // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  // databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  // projectId: "YOUR_PROJECT_ID",
};

// ุชููุฆุฉ Firebase ููุท ุฅุฐุง ุชู ูุถุน ุงูุฅุนุฏุงุฏุงุช
if (firebaseConfig.apiKey) {
    firebase.initializeApp(firebaseConfig);
} else {
    console.warn("ุชูุจูู: ูู ุชูู ุจุฅุถุงูุฉ ุฅุนุฏุงุฏุงุช Firebase ุจุนุฏ. ุงูุชุทุจูู ุณูุนูู ุธุงูุฑูุงู ููุท.");
}

// ---------------------------------------------------------
// ุฏูุงู ุนุงูุฉ ููุชุญ ูุฅุบูุงู ุงูููุงูุฐ (Modals) ูููุน ุงูุฃุฎุทุงุก 
// ---------------------------------------------------------
function openModal(id) {
  const modal = document.getElementById(id);
  if(modal) modal.setAttribute('aria-hidden', 'false');
}

function closeModal(id) {
  const modal = document.getElementById(id);
  if(modal) modal.setAttribute('aria-hidden', 'true');
}

function openAddSub() {
  document.getElementById('formTitle').innerText = 'ุฅุถุงูุฉ ุงุดุชุฑุงู ุฌุฏูุฏ';
  // ูุฌุจ ุฅุถุงูุฉ ููุฏ ุชุตููุฑ ุงูุญููู ููุง
  openModal('formModal');
}

function calcDebt() {
  const price = parseFloat(document.getElementById('price').value) || 0;
  const paid = document.getElementById('paidAmount').value;
  const debtField = document.getElementById('debtAmount');
  
  if (paid === "") {
    debtField.value = "0 (ูุฏููุน ุจุงููุงูู)";
    debtField.style.color = "#10b981";
    debtField.style.background = "rgba(16,185,129,0.1)";
  } else {
    const debt = price - parseFloat(paid);
    debtField.value = debt > 0 ? debt : "0";
    debtField.style.color = debt > 0 ? "#ff8a8a" : "#10b981";
    debtField.style.background = debt > 0 ? "rgba(239,68,68,0.1)" : "rgba(16,185,129,0.1)";
  }
}

// ---------------------------------------------------------
// ูุธุงู ุงูุชูุณูู (Pagination) ุงูุงุญุชุฑุงูู
// ---------------------------------------------------------
const ITEMS_PER_PAGE = 10;
let currentPage = 1;
let firstKeysOfPages = []; 
let lastVisibleKey = null; 
let isLastPage = false;
let totalItemsCount = 0;

function fetchSubscriptions(pageAction = 'init') {
  // ุฅุฐุง ูู ููู Firebase ูููุฆุงูุ ูุฎุฑุฌ ูู ุงูุฏุงูุฉ ูุชูุงุฏู ุงูุฎุทุฃ
  if (!firebase.apps || firebase.apps.length === 0) return;

  const dbRef = firebase.database().ref('subscriptions');
  let query = dbRef.orderByKey().limitToFirst(ITEMS_PER_PAGE + 1); 

  if (pageAction === 'next' && lastVisibleKey) {
    query = dbRef.orderByKey().startAt(lastVisibleKey).limitToFirst(ITEMS_PER_PAGE + 1);
  } else if (pageAction === 'prev') {
    const targetKey = firstKeysOfPages[currentPage - 1];
    query = dbRef.orderByKey().startAt(targetKey).limitToFirst(ITEMS_PER_PAGE + 1);
  }

  query.once('value').then((snapshot) => {
    const data = snapshot.val();
    if (!data) {
      document.getElementById('tbody').innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">ูุง ุชูุฌุฏ ุงุดุชุฑุงูุงุช ูุนุฑุถูุง</td></tr>';
      return;
    }

    const items = Object.entries(data);
    isLastPage = items.length <= ITEMS_PER_PAGE;
    const itemsToShow = isLastPage ? items : items.slice(0, ITEMS_PER_PAGE);

    if (itemsToShow.length > 0) {
      if (pageAction === 'init' || pageAction === 'next') {
        firstKeysOfPages[currentPage] = itemsToShow[0][0]; 
      }
      lastVisibleKey = isLastPage ? null : items[ITEMS_PER_PAGE][0]; 
    }

    renderTable(itemsToShow);
    updatePaginationUI(itemsToShow.length);
  }).catch(error => {
    console.error("ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช:", error);
  });
}

function goToNextPage() {
  if (!isLastPage) {
    currentPage++;
    fetchSubscriptions('next');
  }
}

function goToPrevPage() {
  if (currentPage > 1) {
    currentPage--;
    fetchSubscriptions('prev');
  }
}

function updatePaginationUI(currentItemsCount) {
  document.getElementById('prevPageBtn').disabled = currentPage === 1;
  document.getElementById('nextPageBtn').disabled = isLastPage;
  document.querySelector('.current-page').innerText = currentPage;
  
  // ุชุญุฏูุซ ุฃุฑูุงู ุงูุนูุงุตุฑ ุงููุนุฑูุถุฉ
  const startNum = ((currentPage - 1) * ITEMS_PER_PAGE) + (currentItemsCount > 0 ? 1 : 0);
  const endNum = startNum + currentItemsCount - 1;
  
  document.getElementById('startItem').innerText = startNum;
  document.getElementById('endItem').innerText = endNum;
}

// ุฏุงูุฉ ูุจุฏุฆูุฉ ูุนุฑุถ ุงูุจูุงูุงุช (ุชุญุชุงุฌ ุชุทููุฑ ูุงุญูุงู ูุนุฑุถ ุงูุจูุงูุงุช ุงูุญููููุฉ)
function renderTable(items) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  
  items.forEach(([key, sub]) => {
    // ูุฐุง ูุฌุฑุฏ ูุซุงู ููููู ุงูุตู.. ุณูุชู ุชุบููุฑู ุจูุงุกู ุนูู ุจููุฉ ูุงุนุฏุฉ ุจูุงูุงุชู
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="text-align:center;"><input type="checkbox"></td>
      <td>${sub.name || 'ุบูุฑ ูุนุฑูู'}</td>
      <td dir="ltr">${sub.phone || '---'}</td>
      <td><span class="service-badge">${sub.serviceType || '---'}</span></td>
      <td>${sub.price || 0}</td>
      <td>${sub.start || '---'}</td>
      <td><span class="badge ok">ูุนุงู</span></td>
      <td><button class="btn soft" onclick="openModal('receiptModal')">๐งพ</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ุชุดุบูู ุฌูุจ ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงูุตูุญุฉ
window.onload = () => {
  fetchSubscriptions('init');
};

</script>
</body>
</html>
